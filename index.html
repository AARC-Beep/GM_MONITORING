<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaCrew Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body { margin: 0; background: #f8f9fa; }
#login_box {
    width: 350px;
    margin: 120px auto;
    padding: 25px;
    background: #ffffff;
    border-radius: 10px;
    box-shadow: 0 0 12px rgba(0,0,0,0.15);
}
#dashboard { display:none; }
.sidebar {
    width: 210px;
    height: 100vh;
    background: #212529;
    color: white;
    position: fixed;
    left: 0;
    top: 0;
    padding-top: 20px;
}
.sidebar a {
    display: block;
    color: white;
    padding: 12px 20px;
    text-decoration: none;
}
.sidebar a:hover {
    background: #343a40;
}
.main {
    margin-left: 210px;
    padding: 20px;
}
</style>
</head>

<body>

<!-- ✅ LOGIN BOX -->
<div id="login_box">
    <h3 class="text-center mb-3">SeaCrew Login</h3>
    <input type="text" id="username" class="form-control mb-2" placeholder="Username">
    <input type="password" id="password" class="form-control mb-3" placeholder="Password">
    <button id="loginbtn" class="btn btn-primary w-100">Login</button>
</div>

<!-- ✅ DASHBOARD -->
<div id="dashboard">

    <!-- ✅ SIDEBAR -->
    <div class="sidebar">
        <h4 class="text-center">SeaCrew</h4>
        <hr>
        <a class="sidebar-link" data-sheet="Vessel_Join">Vessel Join</a>
        <a class="sidebar-link" data-sheet="Arrivals">Arrivals</a>
        <a class="sidebar-link" data-sheet="Updates">Updates</a>
        <a class="sidebar-link" data-sheet="Memo">Memo</a>
        <a class="sidebar-link" data-sheet="Training">Training</a>
        <a class="sidebar-link" data-sheet="Pni">Pni</a>
        <a class="sidebar-link" data-sheet="ChatBoard">ChatBoard</a>
        <a class="sidebar-link" data-sheet="Users">Users</a>
        <hr>
        <a href="https://flightaware.com/" target="_blank">FlightAware</a>
        <a href="https://weather.com/" target="_blank">Weather</a>
        <a href="https://dmw.gov.ph/" target="_blank">DMW</a>
        <a href="https://marina.gov.ph/" target="_blank">Marina</a>
    </div>

    <!-- ✅ MAIN AREA -->
    <div class="main">
        <h3 id="sheetTitle">Dashboard</h3>
        <div id="dataContainer" class="mt-3"></div>
    </div>
</div>


<!-- ✅ JS SCRIPT -->
<script>
document.addEventListener("DOMContentLoaded", () => {

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxFQRBmpM9WCuPh-uMKJMGYziNzqMvgNDB2CgWe4zkwJIp9z0K2YPdqTNL0AnyhB-1A/exec";   // ✅ Replace this

    // -----------------------------------------------------
    // ✅ SAFE JSON PARSER (prevents callback errors)
    // -----------------------------------------------------
    function safeJSONParse(raw) {
        try {
            const m = raw.match(/\{[\s\S]*\}/);
            if (!m) throw new Error("No JSON detected");
            return JSON.parse(m[0]);
        } catch (err) {
            console.error("JSON PARSE ERROR:", err, raw);
            return null;
        }
    }

    // ✅ ELEMENTS
    const loginBox      = document.getElementById("login_box");
    const dashboard     = document.getElementById("dashboard");
    const loginBtn      = document.getElementById("loginbtn");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const dataContainer = document.getElementById("dataContainer");
    const sheetTitle    = document.getElementById("sheetTitle");

    // -----------------------------------------------------
    // ✅ LOGIN
    // -----------------------------------------------------
    loginBtn.addEventListener("click", async () => {

        const user = usernameInput.value.trim();
        const pass = passwordInput.value.trim();

        if (!user || !pass) return alert("Enter username and password.");

        try {
            const response = await fetch(
                `${SCRIPT_URL}?action=login&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`
            );

            const data = safeJSONParse(await response.text());

            if (!data) return alert("Server Error");

            if (data.status === "ok") {
                alert("✅ Login Successful!");

                loginBox.style.display = "none";
                dashboard.style.display = "block";

            } else {
                alert("❌ " + data.message);
            }

        } catch (err) {
            console.error("LOGIN ERROR:", err);
            alert("Network Error");
        }
    });

    // -----------------------------------------------------
    // ✅ FETCH ALL DATA
    // -----------------------------------------------------
    async function fetchAll(sheetName) {
        try {
            const r = await fetch(`${SCRIPT_URL}?action=fetchAll&sheet=${sheetName}`);
            const json = safeJSONParse(await r.text());
            return json?.data || [];
        } catch (err) {
            console.error(err);
            return [];
        }
    }

    // -----------------------------------------------------
    // ✅ SIDEBAR CLICK HANDLER
    // -----------------------------------------------------
    document.querySelectorAll(".sidebar-link").forEach(link => {
        link.addEventListener("click", async (e) => {
            e.preventDefault();
            const sheet = link.dataset.sheet;

            sheetTitle.innerText = sheet;
            dataContainer.innerHTML = `<p>⏳ Loading ${sheet}...</p>`;

            const rows = await fetchAll(sheet);

            if (rows.length === 0) {
                dataContainer.innerHTML = "<p>No data available.</p>";
                return;
            }

            let html = `<table class="table table-bordered table-striped"><thead><tr>`;
            Object.keys(rows[0]).forEach(h => html += `<th>${h}</th>`);
            html += `</tr></thead><tbody>`;

            rows.forEach(row => {
                html += `<tr>`;
                Object.values(row).forEach(v => html += `<td>${v}</td>`);
                html += `</tr>`;
            });

            html += "</tbody></table>";

            dataContainer.innerHTML = html;
        });
    });

});
</script>

</body>
</html>
