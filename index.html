<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SeaCrew Dashboard ‚Äî Daily Routine</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f3f7fb; font-family: Arial, Helvetica, sans-serif; }
    .sidebar { width:240px; position:fixed; top:0; left:0; bottom:0; background:#07304a; color:#fff; padding:18px; }
    .sidebar a { color:#cfe7ff; display:block; padding:10px 6px; text-decoration:none; border-radius:6px; margin-bottom:6px; }
    .sidebar a.active, .sidebar a:hover { background:#0b4866; color:#fff; }
    .main { margin-left:260px; padding:20px; }
    .card-slim { background:#fff; border-radius:8px; padding:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); margin-bottom:12px; }
    .row-entry { display:flex; justify-content:space-between; padding:12px 8px; border-bottom:1px solid #eee; }
    .left { flex:1; }
    .entry-meta { font-size:12px; color:#666; margin-top:6px; }
    .small-note { font-size:12px; color:#888; margin-top:6px; }
    .right { width:86px; display:flex; gap:6px; align-items:center; justify-content:flex-end; }
    .btn-icon { padding:6px 8px; }
    #chatLog { height:220px; overflow:auto; background:#fff; padding:8px; border-radius:6px; }
    #stickyNote { width:100%; height:100px; }
    .topbar { float:right; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

  <div class="sidebar">
    <h5 style="color:#fff; margin-bottom:12px;">SeaCrew ‚Äî DAILY ROUTINE LOG</h5>
    <a href="#" data-target="dashboard" onclick="navTo(event,'dashboard')" class="active">Dashboard</a>
    <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')">Vessel Crew Joining</a>
    <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')">Arriving Crew</a>
    <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')">Daily Updates</a>
    <a href="#" data-target="memo" onclick="navTo(event,'memo')">Memo</a>
    <a href="#" data-target="training" onclick="navTo(event,'training')">Training</a>
    <a href="#" data-target="pni" onclick="navTo(event,'pni')">P&I / Events</a>
    <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')">Help / User Guide</a>
    <hr style="border-color:rgba(255,255,255,0.06)">
    <div style="margin-top:6px;">
      <a href="#" onclick="openUrl('https://flightaware.com')">‚úà Flights ‚Äî FlightAware</a>
      <a href="#" onclick="openUrl('https://www.bing.com/maps/')">üõ∞ Zoom Earth</a>
      <a href="#" onclick="openUrl('https://www.msn.com/en-ph/news')">üì∞ News ‚Äî MSN Philippines</a>
      <a href="#" onclick="openUrl('https://www.dmw.gov.ph')">üèõ DMW</a>
      <a href="#" onclick="openUrl('https://www.marina.gov.ph')">‚öì MARINA</a>
      <a href="#" onclick="openUrl('https://owwa.gov.ph')">üë• OWWA</a>
    </div>
    <div style="position:absolute; bottom:14px; left:18px; right:18px; font-size:12px; color:#c9e3ff;">
      Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.
    </div>
  </div>

  <div class="main">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h3>SeaCrew Dashboard</h3>
        <small id="appNote">Connected to Google Apps Script web app: <span id="appName">DAILY ROUTINE LOG</span></small>
      </div>
      <div class="topbar">
        <button class="btn btn-outline-secondary btn-sm" onclick="manualSync()">Sync now</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearAllLocal()">Clear local</button>
        <button class="btn btn-primary btn-sm" onclick="printSectionPDF('all','Monthly_Report',true)">Monthly PDF</button>
        <span style="margin-left:12px" id="loggedUser">Not logged</span>
        <button class="btn btn-sm btn-outline-dark" onclick="showLogin()">Login</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- DASHBOARD (overview) -->
    <section id="dashboard" class="section">
      <div class="card-slim">
        <h5>Quick Overview <small style="float:right" id="lastSync">Last sync: -</small></h5>
        <div class="row">
          <div class="col-md-4">
            <div class="card-slim">
              <strong>Vessel Joining (<span id="countVessel">0</span>)</strong>
              <div id="vesselPreviewSmall"></div>
              <div style="text-align:right"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-slim">
              <strong>Arrivals (<span id="countArrivals">0</span>)</strong>
              <div id="arrivalsPreviewSmall"></div>
              <div style="text-align:right"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card-slim">
              <strong>ChatBoard</strong>
              <div id="chatLog"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Vessel Join -->
    <section id="vesselJoin" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Vessel Crew Joining</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
        </div>
      </div>
      <div class="card-slim mb-3">
        <div class="form-row d-grid gap-2">
          <input class="form-control" placeholder="Vessel" id="vjVessel">
          <input class="form-control" placeholder="Port" id="vjPort">
          <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
          <input class="form-control" placeholder="Rank" id="vjRank">
          <input class="form-control" placeholder="dd/mm/yyyy" type="date" id="vjDate">
          <input class="form-control" placeholder="Flight" id="vjFlight">
          <div>
            <button class="btn btn-success" id="vjAddBtn">Add</button>
            <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
          </div>
        </div>
      </div>
      <div id="vj_list" class="card-slim"></div>
    </section>

    <!-- Arriving Crew -->
    <section id="arrivingCrew" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Arriving Crew</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
        </div>
      </div>
      <div class="card-slim mb-3">
        <div class="form-row d-grid gap-2">
          <input class="form-control" placeholder="Vessel" id="acVessel">
          <input class="form-control" placeholder="Port" id="acPort">
          <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
          <input class="form-control" placeholder="Rank" id="acRank">
          <input class="form-control" placeholder="dd/mm/yyyy" type="date" id="acDate">
          <input class="form-control" placeholder="Flight" id="acFlight">
          <div>
            <button class="btn btn-success" id="acAddBtn">Add</button>
            <button class="btn btn-secondary" id="acResetBtn">Reset</button>
          </div>
        </div>
      </div>
      <div id="ac_list" class="card-slim"></div>
    </section>

    <!-- Daily Updates -->
    <section id="dailyUpdates" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Daily Updates</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Updates')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
        </div>
      </div>
      <div class="card-slim mb-3">
        <div class="form-row d-grid gap-2">
          <input class="form-control" placeholder="Title" id="duTitle">
          <input class="form-control" placeholder="Details" id="duDetails">
          <input class="form-control" type="date" id="duDate">
          <div>
            <button class="btn btn-success" id="duAddBtn">Add</button>
            <button class="btn btn-secondary" id="duResetBtn">Reset</button>
          </div>
        </div>
      </div>
      <div id="du_list" class="card-slim"></div>
    </section>

    <!-- Memo -->
    <section id="memo" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Memo</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
        </div>
      </div>
      <div class="card-slim mb-3">
        <div class="form-row d-grid gap-2">
          <input class="form-control" placeholder="Title" id="mTitle">
          <input class="form-control" placeholder="Details" id="mDetails">
          <input class="form-control" type="date" id="mDate">
          <div>
            <button class="btn btn-success" id="mAddBtn">Add</button>
            <button class="btn btn-secondary" id="mResetBtn">Reset</button>
          </div>
        </div>
      </div>
      <div id="m_list" class="card-slim"></div>
    </section>

    <!-- Training -->
    <section id="training" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Training</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
        </div>
      </div>
      <div class="card-slim mb-3">
        <div class="form-row d-grid gap-2">
          <input class="form-control" placeholder="Subject" id="tSubject">
          <input class="form-control" placeholder="Details" id="tDetails">
          <input class="form-control" type="date" id="tDate">
          <div>
            <button class="btn btn-success" id="tAddBtn">Add</button>
            <button class="btn btn-secondary" id="tResetBtn">Reset</button>
          </div>
        </div>
      </div>
      <div id="t_list" class="card-slim"></div>
    </section>

    <!-- PnI -->
    <section id="pni" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>P&amp;I / Events</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
        </div>
      </div>
      <div class="card-slim mb-3">
        <div id="p_list"></div>
      </div>
    </section>

    <!-- Help -->
    <section id="helpSection" class="section" style="display:none">
      <div class="card-slim">
        <h4>User Guide / Help</h4>
        <p>This guide will explain how to use the SeaCrew dashboard. Steps: Login > Select section > Add/Edit/Delete > Sync. Monthly PDF via top right.</p>
        <ol>
          <li>Login with your username/password (stored in the Users sheet).</li>
          <li>Admin role can add/edit/delete. User role can add only.</li>
          <li>Use Sync now to pull latest from Google Sheets. Auto-sync every 15s.</li>
          <li>To export monthly PDF click Monthly PDF (top-right).</li>
        </ol>
      </div>
    </section>

    <!-- Chat / sticky on right column (kept simple) -->
    <div style="margin-top:18px;">
      <div class="row">
        <div class="col-md-8">
          <!-- nothing (sections contain content) -->
        </div>
        <div class="col-md-4">
          <div class="card-slim">
            <strong>ChatBoard (public)</strong>
            <div id="chatLog"></div>
            <div style="margin-top:8px">
              <input id="chatName" class="form-control" placeholder="Name">
              <div style="display:flex; gap:6px; margin-top:6px;">
                <input id="chatMsg" class="form-control" placeholder="Message">
                <button id="chatSendBtn" class="btn btn-primary">Send</button>
              </div>
            </div>
          </div>
          <div class="card-slim" style="margin-top:12px">
            <strong>Sticky / Quick Note</strong>
            <textarea id="stickyNote" class="form-control"></textarea>
            <div style="margin-top:8px; text-align:right">
              <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('stickyNote').value='';">Clear</button>
              <button class="btn btn-primary btn-sm" onclick="saveSticky()">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= CONFIG - set this to YOUR deployed Apps Script web app URL after deployment */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkykBFEZTIWUZcsCM2Lb0_bUaqGKAQWzxK-2f4IrpP6ekN9iuh6gpGrCSeNU6uvYhc/exec"; // <-- REPLACE

/* Section mapping (localStorage key, sheet name) */
const SECTIONS = {
  vj: { key:'vesselJoin', sheet:'Vessel_Join' },
  ac: { key:'arrivingCrew', sheet:'Arrivals' },
  du: { key:'dailyUpdates', sheet:'Updates' },
  memo: { key:'memo', sheet:'Memo' },
  tr: { key:'training', sheet:'Training' },
  pni:{ key:'pni', sheet:'Pni' },
  chat:{ key:'chatboard', sheet:'ChatBoard' }
};

/* ---------------- local helpers ---------------- */
function saveLocal(key, arr){ localStorage.setItem(key, JSON.stringify(arr || [])); }
function loadLocal(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }

/* ----------------- navigation ----------------- */
function navTo(e, id){
  e && e.preventDefault();
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  const el = document.getElementById(id);
  if(el) el.style.display='block';
  document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
  const link = Array.from(document.querySelectorAll('.sidebar a')).find(a=>a.dataset.target===id);
  if(link) link.classList.add('active');
}
function navToElement(id){ navTo(null,id); window.scrollTo({top:0,behavior:'smooth'}); }

/* ----------------- JSONP helper ----------------- */
/* returns Promise */
function jsonpRequest(params = {}, timeout = 9000) {
  return new Promise((resolve, reject) => {
    if(!SCRIPT_URL) return reject(new Error('SCRIPT_URL not set - update SCRIPT_URL with your Apps Script web app URL'));
    const cbName = '__jsonp_cb_' + Date.now() + '_' + Math.floor(Math.random()*10000);
    params.callback = cbName;
    const query = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
    const src = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + query;

    const script = document.createElement('script');
    script.src = src;
    script.async = true;

    let timer = setTimeout(()=> {
      cleanup();
      reject(new Error('JSONP timeout'));
    }, timeout);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
      if(script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = function(data){
      cleanup();
      resolve(data);
    };

    script.onerror = function(err){
      cleanup();
      reject(new Error('JSONP script error'));
    };

    document.head.appendChild(script);
  });
}

/* ----------------- Server helpers ----------------- */
async function callServerGet(sheetName){ try{ const resp = await jsonpRequest({ action: 'get', sheet: sheetName }, 9000); if(!resp) return []; if(resp.success && Array.isArray(resp.data)) return resp.data; if(Array.isArray(resp)) return resp; return []; }catch(e){ console.warn('callServerGet error',e); return []; } }
async function callServerAppend(sheetName, rowArray){ if(!Array.isArray(rowArray)) throw new Error('append expects array'); return await jsonpRequest({ action:'append', sheet: sheetName, row: JSON.stringify(rowArray) }, 9000); }
async function callServerUpdateUID(sheetName, uid, rowArray){ return await jsonpRequest({ action:'update_uid', sheet: sheetName, uid: uid, row: JSON.stringify(rowArray) }, 9000); }
async function callServerDeleteUID(sheetName, uid){ return await jsonpRequest({ action:'delete_uid', sheet: sheetName, uid: uid }, 9000); }
async function callServerAuth(username, password){ return await jsonpRequest({ action:'auth', sheet: 'Users', username: username, password: password }, 9000); }

/* ----------------- utilities ----------------- */
function fmtDate(d){ if(!d) return ""; const dt=new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString(); }
function escapeHtml(unsafe){ if(!unsafe && unsafe !== 0) return ''; return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;"); }
function makeUID(){ return 'ID-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }

/* ======= app state ======= */
let editState = { vj:null, ac:null, du:null, memo:null, tr:null, pni:null };
let currentUser = null;

/* ----------------- add entry ----------------- */
function addEntry(sectionShort){
  if(!(sectionShort in SECTIONS)) return;
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  const list = loadLocal(key);

  const item = { id: Date.now() };

  if(sectionShort === 'vj'){
    item.vessel = document.getElementById('vjVessel').value.trim();
    item.port = document.getElementById('vjPort').value.trim();
    item.noCrew = document.getElementById('vjNo').value.trim();
    item.rank = document.getElementById('vjRank').value.trim();
    item.date = document.getElementById('vjDate').value;
    item.flight = document.getElementById('vjFlight').value.trim();
  } else if(sectionShort === 'ac'){
    item.vessel = document.getElementById('acVessel').value.trim();
    item.port = document.getElementById('acPort').value.trim();
    item.noCrew = document.getElementById('acNo').value.trim();
    item.rank = document.getElementById('acRank').value.trim();
    item.date = document.getElementById('acDate').value;
    item.flight = document.getElementById('acFlight').value.trim();
  } else if(sectionShort === 'du'){
    item.title = document.getElementById('duTitle').value.trim();
    item.details = document.getElementById('duDetails').value.trim();
    item.date = document.getElementById('duDate').value;
  } else if(sectionShort === 'memo'){
    item.title = document.getElementById('mTitle').value.trim();
    item.details = document.getElementById('mDetails').value.trim();
    item.date = document.getElementById('mDate').value;
  } else if(sectionShort === 'tr'){
    item.subject = document.getElementById('tSubject').value.trim();
    item.details = document.getElementById('tDetails').value.trim();
    item.date = document.getElementById('tDate').value;
  } else if(sectionShort === 'pni'){
    item.subject = document.getElementById('pSubject') ? document.getElementById('pSubject').value.trim() : '';
    item.details = document.getElementById('pDetails') ? document.getElementById('pDetails').value.trim() : '';
    item.date = document.getElementById('pDate') ? document.getElementById('pDate').value : '';
  }

  // minimal validation for vj/ac
  if((sectionShort==='vj' || sectionShort==='ac') && (!item.vessel || !item.port || !item.noCrew || !item.rank || !item.date)){
    return alert('Please fill required fields (Vessel/Port/No of Crew/Rank/Date).');
  }

  // set ID (sheet's unique ID) only after server append; local item gets temporary uid to avoid duplicates
  item.ID = makeUID();
  item.synced = false;
  list.push(item);
  saveLocal(key, list);
  renderList(sectionShort);
  clearForm(sectionShort);

  // prepare payload matching sheet headers: Timestamp/Vessel/Port/No. of Crew/Rank/Date/Flight/ID
  let payloadArray = [];
  if(sectionShort === 'vj' || sectionShort === 'ac'){
    const row = ['', item.vessel || '', item.port || '', item.noCrew || '', item.rank || '', item.date || '', item.flight || '', item.ID || ''];
    payloadArray = row;
  } else if(sectionShort === 'du' || sectionShort === 'memo'){
    const row = ['', item.title || '', item.details || '', item.date || '', item.ID || ''];
    payloadArray = row;
  } else if(sectionShort === 'tr' || sectionShort === 'pni'){
    const row = ['', item.subject || '', item.details || '', item.date || '', item.ID || ''];
    payloadArray = row;
  }

  // send to server
  callServerAppend(meta.sheet, payloadArray).then(res=>{
    // on success mark as synced; better to refresh authoritative copy
    retryLocalAppends().then(()=> syncFromSheet());
  }).catch(err=>{
    console.warn('append failed', err);
  });
}

/* ----------------- render list ----------------- */
function renderList(sectionShort){
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  const raw = loadLocal(key) || [];
  // filter out empty/corrupt entries
  const list = raw.filter(ep => ep && (ep.vessel || ep.port || ep.title || ep.subject || ep.details || ep.name || ep.message));
  const idMap = { vj: 'vj_list', ac: 'ac_list', du: 'du_list', memo: 'm_list', tr: 't_list', pni: 'p_list' };
  const containerEl = document.getElementById(idMap[sectionShort]);
  if(!containerEl) return;
  containerEl.innerHTML = '';

  list.forEach(ep => {
    const row = document.createElement('div'); row.className='row-entry';
    const left = document.createElement('div'); left.className='left';
    if(sectionShort === 'vj'){
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div>
        <div class="entry-meta">${escapeHtml(ep.port)} ¬∑ ${escapeHtml(ep.noCrew)} crew ¬∑ ${escapeHtml(ep.rank)}</div>
        <div class="small-note">Date: ${fmtDate(ep.date)} ${ep.flight? ' ¬∑ ' + escapeHtml(ep.flight):''}${ep.synced? ' ¬∑ (synced)':''}</div>`;
    } else if(sectionShort === 'ac'){
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div>
        <div class="entry-meta">${escapeHtml(ep.port)} ¬∑ ${escapeHtml(ep.noCrew)} crew ¬∑ ${escapeHtml(ep.rank)}</div>
        <div class="small-note">Arrival: ${fmtDate(ep.date)} ${ep.flight? ' ¬∑ ' + escapeHtml(ep.flight):''}${ep.synced? ' ¬∑ (synced)':''}</div>`;
    } else if(sectionShort === 'du' || sectionShort === 'memo'){
      const title = escapeHtml(ep.title || '');
      left.innerHTML = `<div style="font-weight:700">${title}</div><div class="small-note">${escapeHtml(ep.details)}</div><div class="small-note">${fmtDate(ep.date)}${ep.synced? ' ¬∑ (synced)':''}</div>`;
    } else if(sectionShort === 'tr' || sectionShort === 'pni'){
      const title = escapeHtml(ep.subject || '');
      left.innerHTML = `<div style="font-weight:700">${title}</div><div class="small-note">${escapeHtml(ep.details)}</div><div class="small-note">${fmtDate(ep.date)}${ep.synced? ' ¬∑ (synced)':''}</div>`;
    }
    const right = document.createElement('div'); right.className='right';
    // Show edit/delete only if logged-in and role=admin (or owner)
    const canEdit = currentUser && currentUser.role === 'admin';
    const editBtn = document.createElement('button'); editBtn.className='btn btn-sm btn-outline-primary btn-icon'; editBtn.innerHTML='‚úé';
    editBtn.title = 'Edit';
    editBtn.onclick = ()=> startEdit(sectionShort, ep.id);
    const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-outline-danger btn-icon'; delBtn.innerHTML='üóë';
    delBtn.title = 'Delete';
    delBtn.onclick = ()=> deleteEntry(sectionShort, ep.id);
    // append based on permission
    if(canEdit){ right.appendChild(editBtn); right.appendChild(delBtn); }
    row.appendChild(left); row.appendChild(right);
    containerEl.appendChild(row);
  });

  updateSmallPreview(sectionShort);
  updateCounts();
}

/* small dashboard preview: last 3 */
function updateSmallPreview(sectionShort){
  const key = SECTIONS[sectionShort].key;
  const list = loadLocal(key) || [];
  const previewIdMap = { vj:'vesselPreviewSmall', ac:'arrivalsPreviewSmall', du:'updatesPreviewSmall', memo:'memoPreviewSmall', tr:'trainingPreviewSmall', pni:'pniPreviewSmall' };
  const previewEl = document.getElementById(previewIdMap[sectionShort]);
  if(!previewEl) return;
  const last3 = list.slice(-3).reverse();
  previewEl.innerHTML = last3.map(item=>{
    if(sectionShort==='vj') return `<div><strong>${escapeHtml(item.vessel)}</strong> ‚Äî ${escapeHtml(item.port)} ¬∑ ${escapeHtml(item.noCrew)} crew ¬∑ ${escapeHtml(item.rank)}${item.synced? ' ¬∑ (synced)':''}</div>`;
    if(sectionShort==='ac') return `<div><strong>${escapeHtml(item.vessel)}</strong> ‚Äî ${escapeHtml(item.port)} ¬∑ ${escapeHtml(item.noCrew)} crew ¬∑ ${escapeHtml(item.rank)}${item.synced? ' ¬∑ (synced)':''}</div>`;
    if(sectionShort==='du') return `<div><strong>${escapeHtml(item.title)}</strong> ‚Äî ${fmtDate(item.date)}<div class="small-note">${escapeHtml(item.details)}</div></div>`;
    if(sectionShort==='memo') return `<div><strong>${escapeHtml(item.title)}</strong> ‚Äî ${fmtDate(item.date)}</div>`;
    if(sectionShort==='tr') return `<div><strong>${escapeHtml(item.subject)}</strong> ‚Äî ${fmtDate(item.date)}</div>`;
    if(sectionShort==='pni') return `<div><strong>${escapeHtml(item.subject)}</strong> ‚Äî ${fmtDate(item.date)}</div>`;
    return '';
  }).join('');
}

/* update counts */
function updateCounts(){
  document.getElementById('countVessel').innerText = loadLocal(SECTIONS.vj.key).length;
  document.getElementById('countArrivals').innerText = loadLocal(SECTIONS.ac.key).length;
  document.getElementById('countUpdates').innerText = loadLocal(SECTIONS.du.key).length;
  document.getElementById('countMemo').innerText = loadLocal(SECTIONS.memo.key).length;
  document.getElementById('countTraining').innerText = loadLocal(SECTIONS.tr.key).length;
  document.getElementById('countPNI').innerText = loadLocal(SECTIONS.pni.key).length;
}

/* clear section local only */
function clearSection(sectionId){
  if(!confirm('Clear ALL entries for this section (local only)?')) return;
  const short = mapSectionIdToShort(sectionId);
  if(!short) return;
  localStorage.removeItem(SECTIONS[short].key);
  renderList(short);
}

/* clear all local */
function clearAllLocal(){
  if(!confirm('Clear ALL local data? This will NOT delete Google Sheet data.')) return;
  Object.keys(SECTIONS).forEach(k => localStorage.removeItem(SECTIONS[k].key));
  Object.keys(SECTIONS).forEach(k => renderList(k));
  updateCounts();
}
function mapSectionIdToShort(sectionId){
  if(sectionId==='vesselJoin') return 'vj';
  if(sectionId==='arrivingCrew') return 'ac';
  if(sectionId==='dailyUpdates') return 'du';
  if(sectionId==='memo') return 'memo';
  if(sectionId==='training') return 'tr';
  if(sectionId==='pni') return 'pni';
  return null;
}

/* delete entry locally AND on server by ID */
function deleteEntry(sectionShort, id){
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  let list = loadLocal(key);
  const idx = list.findIndex(x => x.id === id);
  if(idx === -1) return;
  if(!confirm('Delete this entry?')) return;

  // get server ID (sheet ID)
  const sheetID = list[idx].ID || null;

  // remove locally
  list.splice(idx,1);
  saveLocal(key, list);
  renderList(sectionShort);

  if(sheetID){
    // call server delete_uid
    callServerDeleteUID(meta.sheet, sheetID).then(res => {
      console.log('server delete ok',res);
      syncFromSheet();
    }).catch(err => {
      console.warn('server delete failed', err);
    });
  }
}

/* start edit */
function startEdit(sectionShort, id){
  const key = SECTIONS[sectionShort].key;
  const list = loadLocal(key);
  const item = list.find(x=>x.id === id);
  if(!item) return alert('Item not found');
  editState[sectionShort] = { id: item.id };

  if(sectionShort === 'vj'){
    document.getElementById('vjVessel').value = item.vessel || '';
    document.getElementById('vjPort').value = item.port || '';
    document.getElementById('vjNo').value = item.noCrew || '';
    document.getElementById('vjRank').value = item.rank || '';
    document.getElementById('vjDate').value = item.date || '';
    document.getElementById('vjFlight').value = item.flight || '';
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(sectionShort === 'ac'){
    document.getElementById('acVessel').value = item.vessel || '';
    document.getElementById('acPort').value = item.port || '';
    document.getElementById('acNo').value = item.noCrew || '';
    document.getElementById('acRank').value = item.rank || '';
    document.getElementById('acDate').value = item.date || '';
    document.getElementById('acFlight').value = item.flight || '';
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(sectionShort === 'du'){
    document.getElementById('duTitle').value = item.title || '';
    document.getElementById('duDetails').value = item.details || '';
    document.getElementById('duDate').value = item.date || '';
  } else if(sectionShort === 'memo'){
    document.getElementById('mTitle').value = item.title || '';
    document.getElementById('mDetails').value = item.details || '';
    document.getElementById('mDate').value = item.date || '';
  } else if(sectionShort === 'tr'){
    document.getElementById('tSubject').value = item.subject || '';
    document.getElementById('tDetails').value = item.details || '';
    document.getElementById('tDate').value = item.date || '';
  } else if(sectionShort === 'pni'){
    // fields optional
    // you can add inputs in UI if needed
    alert('PNI edit not implemented in the compact UI. Use admin sheet to edit or we can add fields.');
  }

  // update Add button to Update
  const mapBtn = { vj:'vjAddBtn', ac:'acAddBtn', du:'duAddBtn', memo:'mAddBtn', tr:'tAddBtn', pni:'pAddBtn' };
  const btn = document.getElementById(mapBtn[sectionShort]);
  if(btn){ btn.innerText = 'Update'; btn.classList.remove('btn-success'); btn.classList.add('btn-warning'); }
}

/* clear form (and reset button) */
function clearForm(sectionShort){
  if(sectionShort==='vj'){ ['vjVessel','vjPort','vjNo','vjRank','vjDate','vjFlight'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='ac'){ ['acVessel','acPort','acNo','acRank','acDate','acFlight'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='du'){ ['duTitle','duDetails','duDate'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='memo'){ ['mTitle','mDetails','mDate'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='tr'){ ['tSubject','tDetails','tDate'].forEach(id=>document.getElementById(id).value=''); }
  ['vjAddBtn','acAddBtn','duAddBtn','mAddBtn','tAddBtn','pAddBtn'].forEach(id=>{
    const b=document.getElementById(id); if(b){ b.innerText='Add'; b.classList.remove('btn-warning'); b.classList.add('btn-success'); }
  });
  if(sectionShort) editState[sectionShort]=null;
}

/* wire up buttons */
function wireUpButtons(){
  document.getElementById('vjAddBtn').addEventListener('click', ()=> {
    if(editState.vj){
      // update local and server entry
      let list = loadLocal(SECTIONS.vj.key);
      const idx = list.findIndex(x=>x.id === editState.vj.id);
      if(idx>=0){
        list[idx].vessel = document.getElementById('vjVessel').value.trim();
        list[idx].port = document.getElementById('vjPort').value.trim();
        list[idx].noCrew = document.getElementById('vjNo').value.trim();
        list[idx].rank = document.getElementById('vjRank').value.trim();
        list[idx].date = document.getElementById('vjDate').value;
        list[idx].flight = document.getElementById('vjFlight').value.trim();
        list[idx].synced = false;
        saveLocal(SECTIONS.vj.key, list);
        // also update server if we have sheet ID
        const uid = list[idx].ID || null;
        if(uid){
          const payload = ['', list[idx].vessel || '', list[idx].port || '', list[idx].noCrew || '', list[idx].rank || '', list[idx].date || '', list[idx].flight || '', uid];
          callServerUpdateUID(SECTIONS.vj.sheet, uid, payload).then(()=> syncFromSheet()).catch(()=>{});
        }
        renderList('vj');
        clearForm('vj');
      }
    } else { addEntry('vj'); }
  });
  document.getElementById('vjResetBtn').addEventListener('click', ()=> clearForm('vj'));

  document.getElementById('acAddBtn').addEventListener('click', ()=> {
    if(editState.ac){
      let list = loadLocal(SECTIONS.ac.key);
      const idx = list.findIndex(x=>x.id === editState.ac.id);
      if(idx>=0){
        list[idx].vessel = document.getElementById('acVessel').value.trim();
        list[idx].port = document.getElementById('acPort').value.trim();
        list[idx].noCrew = document.getElementById('acNo').value.trim();
        list[idx].rank = document.getElementById('acRank').value.trim();
        list[idx].date = document.getElementById('acDate').value;
        list[idx].flight = document.getElementById('acFlight').value.trim();
        list[idx].synced = false;
        saveLocal(SECTIONS.ac.key, list);
        const uid = list[idx].ID || null;
        if(uid){
          const payload = ['', list[idx].vessel || '', list[idx].port || '', list[idx].noCrew || '', list[idx].rank || '', list[idx].date || '', list[idx].flight || '', uid];
          callServerUpdateUID(SECTIONS.ac.sheet, uid, payload).then(()=> syncFromSheet()).catch(()=>{});
        }
        renderList('ac');
        clearForm('ac');
      }
    } else { addEntry('ac'); }
  });
  document.getElementById('acResetBtn').addEventListener('click', ()=> clearForm('ac'));

  document.getElementById('duAddBtn').addEventListener('click', ()=> {
    if(editState.du){
      let list = loadLocal(SECTIONS.du.key);
      const idx = list.findIndex(x=>x.id === editState.du.id);
      if(idx>=0){
        list[idx].title = document.getElementById('duTitle').value.trim();
        list[idx].details = document.getElementById('duDetails').value.trim();
        list[idx].date = document.getElementById('duDate').value;
        list[idx].synced = false;
        saveLocal(SECTIONS.du.key, list);
        const uid = list[idx].ID || null;
        if(uid){
          const payload = ['', list[idx].title || '', list[idx].details || '', list[idx].date || '', uid];
          callServerUpdateUID(SECTIONS.du.sheet, uid, payload).then(()=> syncFromSheet()).catch(()=>{});
        }
        renderList('du');
        clearForm('du');
      }
    } else { addEntry('du'); }
  });
  document.getElementById('duResetBtn').addEventListener('click', ()=> clearForm('du'));

  document.getElementById('mAddBtn').addEventListener('click', ()=> {
    if(editState.memo){
      let list = loadLocal(SECTIONS.memo.key);
      const idx = list.findIndex(x=>x.id === editState.memo.id);
      if(idx>=0){
        list[idx].title = document.getElementById('mTitle').value.trim();
        list[idx].details = document.getElementById('mDetails').value.trim();
        list[idx].date = document.getElementById('mDate').value;
        list[idx].synced = false;
        saveLocal(SECTIONS.memo.key, list);
        const uid = list[idx].ID || null;
        if(uid){
          const payload = ['', list[idx].title || '', list[idx].details || '', list[idx].date || '', uid];
          callServerUpdateUID(SECTIONS.memo.sheet, uid, payload).then(()=> syncFromSheet()).catch(()=>{});
        }
        renderList('memo');
        clearForm('memo');
      }
    } else { addEntry('memo'); }
  });
  document.getElementById('mResetBtn').addEventListener('click', ()=> clearForm('memo'));

  document.getElementById('tAddBtn').addEventListener('click', ()=> {
    if(editState.tr){
      let list = loadLocal(SECTIONS.tr.key);
      const idx = list.findIndex(x=>x.id === editState.tr.id);
      if(idx>=0){
        list[idx].subject = document.getElementById('tSubject').value.trim();
        list[idx].details = document.getElementById('tDetails').value.trim();
        list[idx].date = document.getElementById('tDate').value;
        list[idx].synced = false;
        saveLocal(SECTIONS.tr.key, list);
        const uid = list[idx].ID || null;
        if(uid){
          const payload = ['', list[idx].subject || '', list[idx].details || '', list[idx].date || '', uid];
          callServerUpdateUID(SECTIONS.tr.sheet, uid, payload).then(()=> syncFromSheet()).catch(()=>{});
        }
        renderList('tr');
        clearForm('tr');
      }
    } else { addEntry('tr'); }
  });
  document.getElementById('tResetBtn').addEventListener('click', ()=> clearForm('tr'));

  // PNI buttons not added in this compact UI; can be added same way.

  // Chat
  document.getElementById('chatSendBtn').addEventListener('click', sendChat);
}

/* ---------- Chat ---------- */
async function loadChat(){
  const data = await callServerGet('ChatBoard');
  if(!Array.isArray(data)) return;
  const rows = data.map(r => ({
    name: r['Name'] || '',
    message: r['Message'] || r['Massage'] || r['Message'] || '',
    date: r['Date'] || r['Timestamp'] || '',
    ID: r['ID'] || r['Id'] || r['id'] || ''
  }));
  const el = document.getElementById('chatLog');
  el.innerHTML = rows.reverse().map(row => `<div style="margin-bottom:8px"><strong>${escapeHtml(row.name)}</strong><div>${escapeHtml(row.message)}</div><small class="small-note">${fmtDate(row.date)}</small></div>`).join('');
  el.scrollTop = el.scrollHeight;
}
function sendChat(){
  const name = document.getElementById('chatName').value.trim() || (currentUser ? currentUser.username : 'Anonymous');
  const msg = document.getElementById('chatMsg').value.trim();
  if(!msg) return alert('Please enter a message');
  const key = SECTIONS.chat.key;
  const local = loadLocal(key);
  const id = Date.now();
  const uid = makeUID();
  local.push({ id: id, name, message: msg, date: new Date().toISOString(), ID: uid, synced:false });
  saveLocal(key, local);
  const rowArr = ['', name, msg, new Date().toISOString(), uid];
  callServerAppend('ChatBoard', rowArr).then(()=> {
    document.getElementById('chatMsg').value='';
    loadChat();
    playBell();
  }).catch(()=> {
    document.getElementById('chatMsg').value='';
    loadChat();
  });
}

/* sound bell */
function playBell(){
  try{
    const audio = new Audio('data:audio/mp3;base64,//uQZAAAAAAAAAAAAAA...'); // optional: small beep base64 or you can use beep via WebAudio
    audio.play().catch(()=>{});
  }catch(e){}
}

/* ---------- Sync from Google Sheet ---------- */
async function syncFromSheet(){
  const tabs = ['Vessel_Join','Arrivals','Updates','Memo','Training','Pni','ChatBoard'];
  const now = new Date();
  const lastSyncEl = document.getElementById('lastSync');
  if(lastSyncEl) lastSyncEl.innerText = 'Last sync: ' + now.toLocaleString();

  for(const tab of tabs){
    const data = await callServerGet(tab);
    if(!Array.isArray(data)) continue;

    let mapped = [];

    if(tab === 'Vessel_Join'){
      mapped = data.map(r => ({
        id: Date.now() + Math.floor(Math.random()*100000),
        vessel: r['Vessel'] || '',
        port: r['Port'] || '',
        noCrew: r['No. of Crew'] || r['No of Crew'] || '',
        rank: r['Rank'] || '',
        date: r['Date'] || r['Timestamp'] || '',
        flight: r['Flight'] || '',
        ID: r['ID'] || r['Id'] || r['id'] || '',
        synced: true
      }));
      saveLocal(SECTIONS.vj.key, dedupeByID(mapped));
      renderList('vj');

    } else if(tab === 'Arrivals'){
      mapped = data.map(r => ({
        id: Date.now() + Math.floor(Math.random()*100000),
        vessel: r['Vessel'] || '',
        port: r['Port'] || '',
        noCrew: r['No. of Crew'] || r['No of Crew'] || '',
        rank: r['Rank'] || '',
        date: r['Date'] || r['Timestamp'] || '',
        flight: r['Flight'] || '',
        ID: r['ID'] || r['Id'] || r['id'] || '',
        synced: true
      }));
      saveLocal(SECTIONS.ac.key, dedupeByID(mapped));
      renderList('ac');

    } else if(tab === 'Updates'){
      mapped = data.map(r => ({
        id: Date.now() + Math.floor(Math.random()*100000),
        title: r['Title'] || '',
        details: r['Details'] || '',
        date: r['Date'] || r['Timestamp'] || '',
        ID: r['ID'] || r['Id'] || r['id'] || '',
        synced: true
      }));
      saveLocal(SECTIONS.du.key, dedupeByID(mapped));
      renderList('du');

    } else if(tab === 'Memo'){
      mapped = data.map(r => ({
        id: Date.now() + Math.floor(Math.random()*100000),
        title: r['Title'] || '',
        details: r['Details'] || '',
        date: r['Date'] || r['Timestamp'] || '',
        ID: r['ID'] || r['Id'] || r['id'] || '',
        synced: true
      }));
      saveLocal(SECTIONS.memo.key, dedupeByID(mapped));
      renderList('memo');

    } else if(tab === 'Training'){
      mapped = data.map(r => ({
        id: Date.now() + Math.floor(Math.random()*100000),
        subject: r['Subject'] || '',
        details: r['Details'] || '',
        date: r['Date'] || r['Timestamp'] || '',
        ID: r['ID'] || r['Id'] || r['id'] || '',
        synced: true
      }));
      saveLocal(SECTIONS.tr.key, dedupeByID(mapped));
      renderList('tr');

    } else if(tab === 'Pni'){
      mapped = data.map(r => ({
        id: Date.now() + Math.floor(Math.random()*100000),
        subject: r['Subject'] || '',
        details: r['Details'] || '',
        date: r['Date'] || r['Timestamp'] || '',
        ID: r['ID'] || r['Id'] || r['id'] || '',
        synced: true
      }));
      saveLocal(SECTIONS.pni.key, dedupeByID(mapped));
      renderList('pni');

    } else if(tab === 'ChatBoard'){
      // Chat handled by loadChat
      loadChat();
    }
  }
}

/* dedupe mapped rows by server ID to prevent duplicates */
function dedupeByID(mapped){
  const seen = {};
  const out = [];
  mapped.forEach(r => {
    const key = r.ID || r.id || Math.random();
    if(!seen[key]){
      seen[key]=true;
      out.push(r);
    }
  });
  return out;
}

/* manual sync + retry local appends */
async function manualSync(){
  try{
    await syncFromSheet();
    await retryLocalAppends();
    alert('Sync complete.');
  } catch(err){
    console.error('manualSync error', err);
    alert('Sync error (see console).');
  }
}

/* retry local appends (send unsynced) */
async function retryLocalAppends(){
  const listToTry = ['vj','ac','du','memo','tr','pni','chat'];
  for(const short of listToTry){
    const meta = SECTIONS[short];
    const arr = loadLocal(meta.key) || [];
    for(let i=0;i<arr.length;i++){
      const item = arr[i];
      if(!item || item.synced) continue;
      if(!item.ID) item.ID = makeUID();
      let payload = [];
      if(short==='vj' || short==='ac'){
        payload = ['', item.vessel || '', item.port || '', item.noCrew || '', item.rank || '', item.date || '', item.flight || '', item.ID];
      } else if(short==='du' || short==='memo'){
        payload = ['', item.title || '', item.details || '', item.date || '', item.ID];
      } else if(short==='tr' || short==='pni'){
        payload = ['', item.subject || '', item.details || '', item.date || '', item.ID];
      } else if(short==='chat'){
        payload = ['', item.name || '', item.message || '', item.date || '', item.ID];
      } else continue;

      try{
        await callServerAppend(meta.sheet, payload);
        // mark local item synced
        const localNow = loadLocal(meta.key);
        const idxLocal = localNow.findIndex(x=>x.ID === item.ID);
        if(idxLocal >= 0){
          localNow[idxLocal].synced = true;
          saveLocal(meta.key, localNow);
        }
      }catch(e){
        // ignore; will try again next time
      }
    }
  }
  await syncFromSheet();
}

/* ---------- PDF export ---------- */
function printSectionPDF(sectionId, filename, all=false){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  doc.setFontSize(12);
  doc.text('SeaCrew Monthly Report', 14, 14);
  if(all){
    // include each section
    generateSectionPDF(doc, 'Vessel Crew Joining', loadLocal(SECTIONS.vj.key), ['Vessel','Port','No. Crew','Rank','Date','Flight'], r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']);
    generateSectionPDF(doc, 'Arriving Crew', loadLocal(SECTIONS.ac.key), ['Vessel','Port','No. Crew','Rank','Arrival','Flight'], r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']);
    generateSectionPDF(doc, 'Daily Updates', loadLocal(SECTIONS.du.key), ['Title','Details','Date'], r=>[r.title,r.details,fmtDate(r.date)]);
    generateSectionPDF(doc, 'Memo', loadLocal(SECTIONS.memo.key), ['Title','Details','Date'], r=>[r.title,r.details,fmtDate(r.date)]);
    generateSectionPDF(doc, 'Training', loadLocal(SECTIONS.tr.key), ['Subject','Details','Date'], r=>[r.subject,r.details,fmtDate(r.date)]);
    generateSectionPDF(doc, 'P&I Events', loadLocal(SECTIONS.pni.key), ['Subject','Details','Date'], r=>[r.subject,r.details,fmtDate(r.date)]);
    // signature space
    doc.addPage('landscape');
    doc.setFontSize(12);
    doc.text('Prepared by:', 14, 30);
    doc.text('______________________________', 14, 50);
    doc.text('General Manager', 14, 58);
    doc.save(filename + '.pdf');
    return;
  }

  const short = mapSectionIdToShort(sectionId);
  if(!short){ alert('Unknown section'); return; }
  const list = loadLocal(SECTIONS[short].key) || [];
  if(!list || list.length===0){ alert('No entries to print'); return; }
  let headers=[], rows=[];
  if(short==='vj'){ headers=['Vessel','Port','No. Crew','Rank','Date','Flight']; rows = list.map(r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date), r.flight||'']); }
  if(short==='ac'){ headers=['Vessel','Port','No. Crew','Rank','Arrival','Flight']; rows = list.map(r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date), r.flight||'']); }
  if(short==='du' || short==='memo'){ headers=['Title','Details','Date']; rows = list.map(r=>[r.title,r.details,fmtDate(r.date)]); }
  if(short==='tr' || short==='pni'){ headers=['Subject','Details','Date']; rows = list.map(r=>[r.subject,r.details,fmtDate(r.date)]); }

  doc.autoTable({ head:[headers], body: rows, startY: 28, styles:{fontSize:8,cellPadding:3}, headStyles:{fillColor:[0,51,102], textColor:255} });
  doc.save(filename + '.pdf');
}
function generateSectionPDF(doc, sectionTitle, list, headers, rowMapper){
  if(!list || list.length===0) return;
  doc.addPage('landscape');
  doc.setFontSize(12); doc.text(sectionTitle, 14, 18);
  const rows = list.map(rowMapper);
  doc.autoTable({ head:[headers], body: rows, startY: 26, styles:{fontSize:8,cellPadding:2}, headStyles:{fillColor:[0,51,102], textColor:255} });
}

/* sticky note */
function saveSticky(){ localStorage.setItem('stickyNote', document.getElementById('stickyNote').value || ''); alert('Saved locally'); }

/* ---------- Login (auth via Users sheet) ---------- */
async function showLogin(){
  const username = prompt('Username:');
  if(!username) return;
  const password = prompt('Password:');
  if(!password) return;
  try{
    const resp = await callServerAuth(username, password);
    if(!resp || !resp.success || !resp.user){ alert('Login failed'); return; }
    currentUser = { username:resp.user.username, role: resp.user.role || 'user' };
    document.getElementById('loggedUser').innerText = currentUser.username + ' (' + currentUser.role + ')';
    // load initial data and set UI permission
    await syncFromSheet();
    await retryLocalAppends();
    // prefill chat name
    document.getElementById('chatName').value = currentUser.username;
    alert('Login successful as ' + currentUser.role);
  }catch(e){ console.error('auth',e); alert('Auth error (see console)'); }
}
function logout(){ if(!confirm('Logout?')) return; currentUser = null; document.getElementById('loggedUser').innerText = 'Not logged'; }

/* ---------- Init ---------- */
function openUrl(u){ window.open(u,'_blank'); }

/* startup */
async function init(){
  wireUpButtons();
  // populate sticky
  const saved = localStorage.getItem('stickyNote'); if(saved) document.getElementById('stickyNote').value = saved;
  // render local
  Object.keys(SECTIONS).forEach(k=> { if(k==='chat') return; renderList(k); });
  // load chat
  loadChat();
  // initial sync (best effort)
  try{ await syncFromSheet(); await retryLocalAppends(); }catch(e){}
  // auto sync
  setInterval(()=>{ syncFromSheet().catch(()=>{}); retryLocalAppends().catch(()=>{}); loadChat().catch(()=>{}); }, 15000);
}
window.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
