<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SeaCrew Dashboard — Daily Routine Log</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root { --sidebar-width:260px; --navy:#0b2a4a; --accent:#123855; }
body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
.sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
.sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
.sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
.sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
.sidebar a.active { background:#072033; color:#fff; }
.content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
.card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
.small-note { font-size:0.9rem; color:#666; }
.preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
.entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
.entry-meta { color:#444; font-size:0.95rem; }
.form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.form-row .form-control { min-width:140px; }
.entry-actions button { margin-left:6px; }
.fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }

/* layout for list rows */
.row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
.row-entry .left { flex:1; }
.row-entry .right { display:flex; gap:8px; align-items:center; }

/* Chatboard */
.chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
.chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
.chat-inputs { display:flex; gap:8px; align-items:center; }

/* responsive */
@media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
@media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }

/* small helpers */
.btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
.badge-synced { font-size:0.75rem; color:#0b6; margin-left:6px; }
.login-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
.login-card { width:420px; padding:20px; border-radius:12px; background:#fff; box-shadow:0 8px 30px rgba(0,0,0,0.25); }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-card">
    <h5>TIWALA — SeaCrew Login</h5>
    <div class="mb-2"><input id="loginUser" class="form-control" placeholder="Username"></div>
    <div class="mb-2"><input id="loginPass" type="password" class="form-control" placeholder="Password"></div>
    <div class="d-flex justify-content-between align-items-center">
      <div><input type="checkbox" id="saveCred"> <label for="saveCred">Remember (local only)</label></div>
      <button id="loginBtn" class="btn btn-primary">Sign in</button>
    </div>
    <div class="mt-2 small-note" id="loginMsg"></div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation" style="display:none">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY LOG</h4>
  <a href="#" data-target="dashboard">Dashboard</a>
  <a href="#" data-target="vesselJoin">Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew">Arriving Crew</a>
  <a href="#" data-target="dailyUpdates">Daily Updates</a>
  <a href="#" data-target="memo">Memo</a>
  <a href="#" data-target="training">Training</a>
  <a href="#" data-target="pni">P&amp;I / Events</a>
  <hr/>
  <div style="margin-top:6px">
    <div class="small-note" style="color:#cfe8ff;margin-bottom:6px">Useful Tools</div>
    <a href="https://flightaware.com/live/airport/RPLL" target="_blank">Flights — FlightAware (MNL)</a>
    <a href="https://www.msn.com/en-ph/news" target="_blank">News — MSN Philippines</a>
    <a href="https://zoom.earth/" target="_blank">Weather — Zoom Earth</a>
    <a href="https://dmw.gov.ph/" target="_blank">DMW — Dept. of Migrant Workers</a>
    <a href="https://owwa.gov.ph/" target="_blank">OWWA</a>
    <a href="https://marina.gov.ph/" target="_blank">MARINA</a>
  </div>
  <hr/>
</nav>

<!-- Main Content -->
<main class="content" role="main" style="display:none">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <h2>SeaCrew Dashboard</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="syncBtn">Sync now</button>
      <button class="btn btn-outline-danger" id="clearLocalBtn">Clear local</button>
      <button class="btn btn-primary" id="pdfBtn">Monthly PDF</button>
      <button class="btn btn-outline-info" id="logoutBtn">Logout</button>
    </div>
  </div>

  <section id="dashboard" class="section active">
    <div class="card-slim">
      <h5>Quick Overview</h5>
      <div id="overviewCards" class="d-flex flex-wrap gap-3"></div>
    </div>
    <div class="card-slim">
      <h6>ChatBoard (public)</h6>
      <div class="chatboard">
        <div class="chat-log" id="chatLog"></div>
        <div class="chat-inputs">
          <input id="chatName" class="form-control" placeholder="Your name" value="Captain"/>
          <input id="chatMsg" class="form-control" placeholder="Message"/>
          <button class="btn btn-primary" id="chatSendBtn">Send</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Other sections like Vessel Join / Arrivals / Updates / Memo / Training / PnI -->
  <section id="vesselJoin" class="section" style="display:none"></section>
  <section id="arrivingCrew" class="section" style="display:none"></section>
  <section id="dailyUpdates" class="section" style="display:none"></section>
  <section id="memo" class="section" style="display:none"></section>
  <section id="training" class="section" style="display:none"></section>
  <section id="pni" class="section" style="display:none"></section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbw_rEHqI_e8c5C6_fYVZlnvLDE5FuCasSlBl0BVgkex1Hm-HrWnU21KYkIblNf8tcV8/exec"; // <-- replace with your deployed GAS URL

// ---------------- LOGIN ----------------
const loginOverlay = document.getElementById("loginOverlay");
const sidebar = document.querySelector(".sidebar");
const mainContent = document.querySelector(".content");
const loginMsg = document.getElementById("loginMsg");

document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const username = document.getElementById("loginUser").value;
  const password = document.getElementById("loginPass").value;

  try {
    const res = await fetch(`${GAS_URL}?action=auth&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=cb`);
    const text = await res.text();
    const data = JSON.parse(text.replace(/^cb\(/,"").replace(/\);$/,""));

    if(data.status==="success"){
      loginOverlay.style.display="none";
      sidebar.style.display="block";
      mainContent.style.display="block";
      loadAllSections();
    } else loginMsg.textContent = data.message;
  } catch(e){ loginMsg.textContent = "Login failed"; console.error(e); }
});

// ---------------- NAVIGATION ----------------
document.querySelectorAll(".sidebar a[data-target]").forEach(a=>{
  a.addEventListener("click", e=>{
    e.preventDefault();
    const target = a.getAttribute("data-target");
    document.querySelectorAll(".section").forEach(s=>s.style.display="none");
    document.getElementById(target).style.display="block";
    document.querySelectorAll(".sidebar a").forEach(link=>link.classList.remove("active"));
    a.classList.add("active");
  });
});

// ---------------- CHAT ----------------
const chatLog = document.getElementById("chatLog");
document.getElementById("chatSendBtn").addEventListener("click", async ()=>{
  const name = document.getElementById("chatName").value || "Captain";
  const msg = document.getElementById("chatMsg").value;
  if(!msg) return;
  try{
    await fetch(`${GAS_URL}?action=append_uid&sheet=ChatBoard&row=${encodeURIComponent(JSON.stringify([Date.now(),name,msg]))}&callback=cb`);
    document.getElementById("chatMsg").value="";
    loadChatBoard();
  }catch(e){ console.error(e); }
});

async function loadChatBoard(){
  try{
    const res = await fetch(`${GAS_URL}?action=fetch&sheet=ChatBoard&callback=cb`);
    const text = await res.text();
    const data = JSON.parse(text.replace(/^cb\(/,"").replace(/\);$/,""));
    if(data.status==="success"){
      chatLog.innerHTML = data.data.map(r=>`<div><b>${r[1]}</b>: ${r[2]}</div>`).join("");
      chatLog.scrollTop = chatLog.scrollHeight;
    }
  }catch(e){ console.error(e); }
}

// ---------------- FETCH / INIT SECTIONS ----------------
async function loadAllSections(){
  const sections = ["vesselJoin","arrivingCrew","dailyUpdates","memo","training","pni"];
  for(const s of sections){
    try{
      const res = await fetch(`${GAS_URL}?action=fetch&sheet=${s}&callback=cb`);
      const text = await res.text();
      const data = JSON.parse(text.replace(/^cb\(/,"").replace(/\);$/,""));
      if(data.status==="success"){
        // populate preview table or form list
        console.log(`Loaded ${s}`,data.data);
      }
    }catch(e){ console.error(e); }
  }
  loadChatBoard();
}

// ---------------- PDF ----------------
document.getElementById("pdfBtn").addEventListener("click", ()=>{
  // for simplicity, just export the overview section
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:"landscape" });
  doc.text("SeaCrew Monthly Report",10,10);
  doc.save("SeaCrew_Monthly_Report.pdf");
});
</script>
</body>
</html>
