<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SeaCrew Dashboard — Daily Routine Log</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- jsPDF + AutoTable (for PDF export) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
    .sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
    .sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
    .sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
    .sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
    .sidebar a.active { background:#072033; color:#fff; }
    .content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
    .card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
    .small-note { font-size:0.9rem; color:#666; }
    .preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
    .entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
    .entry-meta { color:#444; font-size:0.95rem; }
    .form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .form-row .form-control { min-width:140px; }
    .entry-actions button { margin-left:6px; }
    .fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }

    /* layout for list rows */
    .row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
    .row-entry .left { flex:1; }
    .row-entry .right { display:flex; gap:8px; align-items:center; }

    /* Chatboard */
    .chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
    .chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
    .chat-inputs { display:flex; gap:8px; align-items:center; }

    /* responsive */
    @media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
    @media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }

    /* some small helpers */
    .btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
    .badge-synced { font-size:0.75rem; color:#0b6; margin-left:6px; }
    .login-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .login-card { width:420px; padding:20px; border-radius:12px; background:#fff; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
  </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 style="margin:0">TIWALA — SeaCrew Login</h5>
      <img src="" alt="" style="width:36px;opacity:.4"/>
    </div>
    <div>
      <div class="mb-2"><input id="loginUser" class="form-control" placeholder="Username"></div>
      <div class="mb-2"><input id="loginPass" type="password" class="form-control" placeholder="Password"></div>
      <div class="d-flex justify-content-between align-items-center">
        <div><input type="checkbox" id="saveCred"> <label for="saveCred">Remember (local only)</label></div>
        <div><button id="loginBtn" class="btn btn-primary">Sign in</button></div>
      </div>
      <div class="mt-2 small-note" id="loginMsg"></div>
    </div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>
  <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')"><i class="fa-solid fa-circle-info"></i> Help / User Guide</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <!-- External links requested -->
  <div style="margin-top:6px">
    <div class="small-note" style="color:#cfe8ff;margin-bottom:6px">Useful Tools</div>
    <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
    <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
    <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
    <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
    <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
    <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>
  </div>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 style="margin:0">SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Apps Script web app: <strong>DAILY ROUTINE LOG</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
      <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
      <button class="btn btn-outline-info" id="logoutBtn" style="display:none" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- DASHBOARD (previews + chatboard) -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <!-- Previews columns -->
      <div class="col-md-8">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h5 style="margin:0">Quick Overview</h5>
            <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card-slim">
                <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                <div class="preview-table" id="vesselPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                <div class="preview-table" id="arrivalsPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                <div class="preview-table" id="updatesPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                <div class="preview-table" id="memoPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                <div class="preview-table" id="trainingPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                <div class="preview-table" id="pniPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Chatboard / Sticky -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>ChatBoard (public view)</h6>
          <div class="chatboard">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
              <input id="chatMsg" class="form-control" placeholder="Message" />
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
            <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
          </div>
        </div>

        <div class="card-slim mt-3">
          <h6>Sticky / Quick Note</h6>
          <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
            <button class="btn btn-primary" onclick="saveSticky()">Save</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ---------- Sections: Vessel Join / Arrivals / Updates / Memo / Training / PNI ---------- -->
  <!-- Vessel Join -->
  <section id="vesselJoin" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Vessel Crew Joining</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="vjVessel">
        <input class="form-control" placeholder="Port" id="vjPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
        <input class="form-control" placeholder="Rank" id="vjRank">
        <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
        <input class="form-control" placeholder="Flight" id="vjFlight">
        <button class="btn btn-success" id="vjAddBtn">Add</button>
        <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
      </div>
    </div>

    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    <div id="t_list" class="card-slim"></div>
  </section>

  <!-- PnI -->
  <section id="pni" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>P&amp;I / Events</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="pSubject">
        <input class="form-control" placeholder="Details" id="pDetails">
        <input class="form-control" type="date" id="pDate">
        <button class="btn btn-success" id="pAddBtn">Add</button>
        <button class="btn btn-secondary" id="pResetBtn">Reset</button>
      </div>
    </div>
    <div id="p_list" class="card-slim"></div>
  </section>

  <!-- HELP / USER GUIDE -->
  <section id="helpSection" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>User Guide / Help</h4>
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('helpSection','User_Guide')">Export PDF</button>
    </div>

    <div class="card-slim" style="font-size:14px; line-height:1.5">
      <h5>SeaCrew Dashboard — Daily Routine Log (User Guide)</h5>
      <ol>
        <li>Login using your Username and Password (from Users sheet).</li>
        <li>Use the sidebar to navigate sections. Add entries in the form at the top of each section.</li>
        <li>To edit an entry, click the edit (pencil) icon — the form will populate. Update then press "Update".</li>
        <li>To delete an entry, click the trash icon and confirm. Deleted entries are removed from the sheet.</li>
        <li>ChatBoard posts a message to the ChatBoard sheet (sound and visual alert when new messages arrive).</li>
        <li>Press "Sync now" to manually sync. Auto-sync occurs every 15 seconds.</li>
        <li>Monthly PDF generates consolidated report (landscape, font-size 8) and includes a GM signature page.</li>
      </ol>
      <p class="small-note">If you want deletions to be archived (not permanently removed), ask me and I'll implement an "Archive" sheet behavior instead of deleting rows.</p>
    </div>
  </section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<script>
/* ===== SeaCrew Dashboard — Robust Client Script =====
   - Login (users sheet)
   - Add / Edit / Update / Delete (archive)
   - Previews show active only
   - Chatboard live (not included in PDF)
   - Monthly PDF includes archived entries
   - Auto-sync and manual sync
   - Inline edit + Delete in previews
   - Extra logging + error messages
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw--x_wiJ6Vm9CICyE7k-SebrcLytHhvfe4w31BtEN17FvGtG0f6zqLn96sSgV4ra2l/exec";
const SHEET_MAP = {
  vesselJoin: "Vessel_join",
  arrivingCrew: "Arrivals",
  dailyUpdates: "Updates",
  memo: "Memo",
  training: "Training",
  pni: "Pni",
  chatBoard: "ChatBoard",
  users: "Users",
  archivePrefix: "Archive_"
};

let currentUser = null;
let localData = {};         // cached full sheet rows (including archived)
let syncInterval = null;
let chatPollInterval = null;
let lastChatTs = 0;

// ---------- Utility UI helpers ----------
function showLogin(){ document.getElementById('loginOverlay').style.display='flex'; }
function hideLogin(){ document.getElementById('loginOverlay').style.display='none'; }
function showToast(msg, type='info'){ console.log(`[TOAST] ${msg}`); const el = document.getElementById('loginMsg'); if(el) el.innerText = msg; }

// ---------- Robust JSONP helper ----------
function jsonp(url, callback, timeoutMs=10000){
  const cbName = "cb_" + Math.floor(Math.random()*1e9);
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    let timedOut = false;
    const timer = setTimeout(()=> {
      timedOut = true;
      cleanup();
      const err = new Error('JSONP timeout');
      console.error(err, url);
      reject(err);
    }, timeoutMs);

    function cleanup(){
      clearTimeout(timer);
      try{ delete window[cbName]; } catch(e){ window[cbName] = undefined; }
      if(script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = function(res){
      if(timedOut) return;
      cleanup();
      resolve(res);
      if (typeof callback === 'function') callback(res);
    };

    // ensure callback=callback is present to be replaced
    script.src = url.replace("callback=callback", `callback=${cbName}`);
    script.onerror = function(e){
      if(timedOut) return;
      cleanup();
      const err = new Error('JSONP script error');
      console.error('JSONP script error', e, url);
      reject(err);
    };
    document.body.appendChild(script);
  });
}

// ---------- LOGIN ----------
async function login(){
  const username = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value.trim();
  const msg = document.getElementById('loginMsg');
  msg.innerText = '';
  if(!username || !password){ msg.innerText = "Enter username and password"; return; }
  const url = `${SCRIPT_URL}?action=auth&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=callback`;
  try{
    const res = await jsonp(url);
    if(res && (res.status === "success" || res.success)){
      currentUser = res.username || username;
      hideLogin();
      document.getElementById('logoutBtn').style.display = "inline-block";
      showToast(`Welcome, ${currentUser}`);
      startAutoSync();
      startChatPolling();
      await loadAllPreviews();
    } else {
      msg.innerText = (res && (res.message || res.error)) || "Login failed";
      console.warn("Auth failed response:", res);
    }
  } catch(err){
    msg.innerText = "Login error — check console (network/endpoint).";
    console.error("Login error", err);
  }
}
document.getElementById('loginBtn')?.addEventListener('click', login);
document.getElementById('logoutBtn')?.addEventListener('click', ()=> {
  logout();
});

// ---------- LOGOUT ----------
function logout(){
  currentUser = null;
  document.getElementById('logoutBtn').style.display = "none";
  showLogin();
  stopAutoSync();
  stopChatPolling();
  clearLocalPreviewDisplays();
  showToast('Logged out');
}

// ---------- FETCH sheet ----------
async function fetchSheet(section){
  try{
    const sheet = SHEET_MAP[section];
    const url = `${SCRIPT_URL}?action=fetch&sheet=${encodeURIComponent(sheet)}&callback=callback`;
    const res = await jsonp(url);
    if(res && res.success) return res.data || [];
    // some backends return success true directly
    if(res && Array.isArray(res)) return res;
    console.warn('fetchSheet unexpected response', section, res);
    return [];
  } catch(err){
    console.error('fetchSheet error', section, err);
    return [];
  }
}

// ---------- LOAD ALL PREVIEWS ----------
async function loadAllPreviews(){
  // fetch each non-users, non-chatBoard sheet
  const keys = Object.keys(SHEET_MAP).filter(k => !['users','chatBoard','archivePrefix'].includes(k));
  await Promise.all(keys.map(async (sec) => {
    const data = await fetchSheet(sec);
    // normalize: ensure each row has uid and archived boolean
    const norm = (data || []).map(r => {
      // try to ensure archived field exists and uid exists
      r.archived = !!(r.archived === true || r.archived === 'TRUE' || r.archived === 'true' || r.archived === 1 || r.archived === '1');
      if(!r.uid) r.uid = r.uid || r.id || (r._uid || r._id) || null;
      return r;
    });
    localData[sec] = norm;
    renderPreview(sec, norm.filter(r => !r.archived));
  }));
  document.getElementById('lastSync') && (document.getElementById('lastSync').innerText = new Date().toLocaleString());
}

// ---------- RENDER PREVIEW (with inline edit + delete) ----------
function renderPreview(section, data){
  const containerMap = {
    vesselJoin:'vesselPreviewSmall',
    arrivingCrew:'arrivalsPreviewSmall',
    dailyUpdates:'updatesPreviewSmall',
    memo:'memoPreviewSmall',
    training:'trainingPreviewSmall',
    pni:'pniPreviewSmall'
  };
  const countMap = {
    vesselJoin:'countVessel',
    arrivingCrew:'countArrivals',
    dailyUpdates:'countUpdates',
    memo:'countMemo',
    training:'countTraining',
    pni:'countPNI'
  };
  const containerId = containerMap[section];
  const countId = countMap[section];
  if(!containerId) return;
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if(!data || data.length === 0){
    container.innerHTML = '<small>No entries</small>';
    if(countId) document.getElementById(countId).innerText = '0';
    return;
  }
  data.slice(-5).forEach(row => {
    const div = document.createElement('div');
    div.className = 'row-entry';
    // build inputs for editable fields (skip uid, archived)
    const leftHtml = Object.keys(row).filter(k => !['uid','archived'].includes(k)).map(k => {
      // escape double quotes
      const v = row[k] !== undefined && row[k] !== null ? String(row[k]).replace(/"/g,'&quot;') : '';
      return `<input class="form-control form-control-sm edit-field" data-key="${k}" value="${v}" style="display:inline-block; width:120px; margin-right:6px;" />`;
    }).join('');
    div.innerHTML = `
      <div class="left">${leftHtml}</div>
      <div class="right">
        <button class="btn btn-sm btn-primary editBtn" title="Save">Save</button>
        <button class="btn btn-sm btn-danger delBtn" title="Delete (archive)">Delete</button>
      </div>
    `;
    // Save handler
    div.querySelector('.editBtn').addEventListener('click', async () => {
      if(!currentUser) return alert("Login required");
      const inputs = div.querySelectorAll('.edit-field');
      const values = {};
      inputs.forEach(i => { values[i.dataset.key] = i.value; });
      try {
        await updateEntry(section, row.uid, values);
        showToast('Saved');
      } catch(e){ alert('Update failed - check console'); console.error(e); }
    });
    // Delete handler (archive)
    div.querySelector('.delBtn').addEventListener('click', async () => {
      if(!currentUser) return alert("Login required");
      if(!confirm('Archive this entry?')) return;
      try {
        await archiveEntry(section, row.uid);
        showToast('Archived');
      } catch(e){ alert('Archive failed - check console'); console.error(e); }
    });
    container.appendChild(div);
  });
  if(countId) document.getElementById(countId).innerText = String(data.length);
}

// ---------- ADD ENTRY generic ----------
async function addEntry(section, obj){
  if(!currentUser) return alert("Login required");
  const sheet = SHEET_MAP[section];
  // send JSON string in data param to keep flexible
  const url = `${SCRIPT_URL}?action=append_uid&sheet=${encodeURIComponent(sheet)}&data=${encodeURIComponent(JSON.stringify(obj))}&user=${encodeURIComponent(currentUser)}&callback=callback`;
  try{
    const res = await jsonp(url);
    if(res && (res.success || res.status === 'success')){
      await loadAllPreviews();
      return res;
    } else {
      console.warn('addEntry response', res);
      throw new Error('Add failed');
    }
  } catch(err){
    console.error('addEntry error', err);
    throw err;
  }
}

// ---------- UPDATE ENTRY generic ----------
async function updateEntry(section, uid, values){
  if(!currentUser) throw new Error('Login required');
  const sheet = SHEET_MAP[section];
  const url = `${SCRIPT_URL}?action=update_uid&sheet=${encodeURIComponent(sheet)}&uid=${encodeURIComponent(uid)}&data=${encodeURIComponent(JSON.stringify(values))}&user=${encodeURIComponent(currentUser)}&callback=callback`;
  try{
    const res = await jsonp(url);
    if(res && (res.success || res.status === 'success')) {
      await loadAllPreviews();
      return res;
    } else {
      console.warn('updateEntry response', res);
      throw new Error('Update failed');
    }
  } catch(err){
    console.error('updateEntry error', err);
    throw err;
  }
}

// ---------- ARCHIVE ENTRY (delete -> archive) ----------
async function archiveEntry(section, uid){
  if(!currentUser) throw new Error('Login required');
  const sheet = SHEET_MAP[section];
  // Backend expected to move row to Archive_<SheetName>
  const archiveSheet = SHEET_MAP.archivePrefix + sheet;
  const url = `${SCRIPT_URL}?action=archive_uid&sheet=${encodeURIComponent(sheet)}&uid=${encodeURIComponent(uid)}&archiveSheet=${encodeURIComponent(archiveSheet)}&user=${encodeURIComponent(currentUser)}&callback=callback`;
  try{
    const res = await jsonp(url);
    if(res && (res.success || res.status === 'success')) {
      await loadAllPreviews();
      return res;
    } else {
      console.warn('archiveEntry response', res);
      throw new Error('Archive failed');
    }
  } catch(err){
    console.error('archiveEntry error', err);
    throw err;
  }
}

// ---------- CHATBOARD: polling and send ----------
async function loadChatBoard(){
  try{
    const sheet = SHEET_MAP.chatBoard;
    const url = `${SCRIPT_URL}?action=fetch&sheet=${encodeURIComponent(sheet)}&callback=callback`;
    const res = await jsonp(url);
    const messages = (res && res.success && res.data) ? res.data : (Array.isArray(res) ? res : []);
    renderChat(messages);
    return messages;
  } catch(err){
    console.error('loadChatBoard error', err);
    return [];
  }
}
function startChatPolling(){
  stopChatPolling();
  loadChatBoard();
  chatPollInterval = setInterval(loadChatBoard, 10000);
}
function stopChatPolling(){ if(chatPollInterval) { clearInterval(chatPollInterval); chatPollInterval = null; } }

function renderChat(messages){
  const log = document.getElementById('chatLog');
  if(!log) return;
  // normalize timestamps
  messages = (messages || []).slice(-200).map(m => {
    let ts = m.timestamp || m.date || m.time || m.createdAt || m.dt;
    return {...m, ts: ts ? Date.parse(ts) || 0 : 0};
  }).sort((a,b) => a.ts - b.ts);
  log.innerHTML = '';
  let newMsg = false;
  messages.forEach(m => {
    const when = m.ts ? new Date(m.ts).toLocaleString() : '';
    const div = document.createElement('div');
    div.innerHTML = `<strong>${m.name || m.sender || 'Anon'}</strong>: ${m.message || m.msg || m.text || ''} <small style="color:#888">[${when}]</small>`;
    log.appendChild(div);
    if(m.ts > lastChatTs) newMsg = true;
  });
  if(messages.length) lastChatTs = messages[messages.length - 1].ts || lastChatTs;
  if(newMsg){
    try{ const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); audio.play(); } catch(e){}
    log.scrollTop = log.scrollHeight;
  }
}

// send chat
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'chatSendBtn'){
    (async ()=>{
      if(!currentUser){ alert('Login required'); return; }
      const name = document.getElementById('chatName').value.trim() || currentUser;
      const msg = document.getElementById('chatMsg').value.trim();
      if(!msg) return;
      const payload = { name, message: msg, timestamp: new Date().toISOString(), user: currentUser };
      try{
        const url = `${SCRIPT_URL}?action=append_uid&sheet=${encodeURIComponent(SHEET_MAP.chatBoard)}&data=${encodeURIComponent(JSON.stringify(payload))}&user=${encodeURIComponent(currentUser)}&callback=callback`;
        const res = await jsonp(url);
        if(res && (res.success||res.status === 'success')){
          document.getElementById('chatMsg').value = '';
          await loadChatBoard();
        } else {
          console.warn('chat append response', res);
          alert('Chat not sent (see console).');
        }
      } catch(err){
        console.error('chat send error', err);
        alert('Chat send error (see console).');
      }
    })();
  }
});

// ---------- ADD button bindings: create add handlers for each section ----------
function wireAddButtons(){
  // Vessel Join
  document.getElementById('vjAddBtn')?.addEventListener('click', ()=>{
    const obj = {
      vessel: document.getElementById('vjVessel').value,
      port: document.getElementById('vjPort').value,
      noOfCrew: document.getElementById('vjNo').value,
      rank: document.getElementById('vjRank').value,
      departDate: document.getElementById('vjDate').value,
      flight: document.getElementById('vjFlight').value
    };
    addEntry('vesselJoin', obj).then(()=>{ ['vjVessel','vjPort','vjNo','vjRank','vjDate','vjFlight'].forEach(id=>document.getElementById(id).value=''); }).catch(()=>{});
  });
  // Arriving Crew
  document.getElementById('acAddBtn')?.addEventListener('click', ()=>{
    const obj = {
      vessel: document.getElementById('acVessel').value,
      port: document.getElementById('acPort').value,
      noOfCrew: document.getElementById('acNo').value,
      rank: document.getElementById('acRank').value,
      arrivalDate: document.getElementById('acDate').value,
      flight: document.getElementById('acFlight').value
    };
    addEntry('arrivingCrew', obj).then(()=>{ ['acVessel','acPort','acNo','acRank','acDate','acFlight'].forEach(id=>document.getElementById(id).value=''); }).catch(()=>{});
  });
  // Daily Updates
  document.getElementById('duAddBtn')?.addEventListener('click', ()=>{
    const obj = {
      title: document.getElementById('duTitle').value,
      details: document.getElementById('duDetails').value,
      date: document.getElementById('duDate').value
    };
    addEntry('dailyUpdates', obj).then(()=>{ ['duTitle','duDetails','duDate'].forEach(id=>document.getElementById(id).value=''); }).catch(()=>{});
  });
  // Memo
  document.getElementById('mAddBtn')?.addEventListener('click', ()=>{
    const obj = {
      title: document.getElementById('mTitle').value,
      details: document.getElementById('mDetails').value,
      date: document.getElementById('mDate').value
    };
    addEntry('memo', obj).then(()=>{ ['mTitle','mDetails','mDate'].forEach(id=>document.getElementById(id).value=''); }).catch(()=>{});
  });
  // Training
  document.getElementById('tAddBtn')?.addEventListener('click', ()=>{
    const obj = {
      subject: document.getElementById('tSubject').value,
      details: document.getElementById('tDetails').value,
      date: document.getElementById('tDate').value
    };
    addEntry('training', obj).then(()=>{ ['tSubject','tDetails','tDate'].forEach(id=>document.getElementById(id).value=''); }).catch(()=>{});
  });
  // PnI
  document.getElementById('pAddBtn')?.addEventListener('click', ()=>{
    const obj = {
      subject: document.getElementById('pSubject').value,
      details: document.getElementById('pDetails').value,
      date: document.getElementById('pDate').value
    };
    addEntry('pni', obj).then(()=>{ ['pSubject','pDetails','pDate'].forEach(id=>document.getElementById(id).value=''); }).catch(()=>{});
  });
}
wireAddButtons();

// ---------- PDF export (includes archived only when specified) ----------
async function printSectionPDF(section, filename='report', includeArchived=true){
  // fetch fresh data for both active + archive if includeArchived
  try{
    let data = await fetchSheet(section);
    data = data.map(r=> ({...r, archived: !!(r.archived === true || r.archived === 'TRUE' || r.archived === 'true')} ));
    if(!includeArchived) data = data.filter(r => !r.archived);
    // if includeArchived true, we also fetch Archive_<sheet> to be safe
    if(includeArchived){
      const archiveSheetName = SHEET_MAP.archivePrefix + SHEET_MAP[section];
      const archiveUrl = `${SCRIPT_URL}?action=fetch&sheet=${encodeURIComponent(archiveSheetName)}&callback=callback`;
      try{
        const arcRes = await jsonp(archiveUrl);
        const arcData = (arcRes && arcRes.success && Array.isArray(arcRes.data)) ? arcRes.data : (Array.isArray(arcRes) ? arcRes : []);
        if(Array.isArray(arcData) && arcData.length) data = data.concat(arcData.map(r=>({...r, archived:true})));
      }catch(e){ console.warn('Archive fetch failed (maybe no archive sheet)', e); }
    }
    if(!data || data.length === 0){ alert('No data to export'); return; }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape' });
    doc.setFontSize(8);
    // build columns from keys (exclude archived)
    const cols = Object.keys(data[0]).filter(k => k !== 'archived');
    const rows = data.map(r => cols.map(c => r[c] === undefined || r[c] === null ? '' : String(r[c])));
    doc.autoTable({ head: [cols], body: rows, styles: { fontSize: 8 } });
    // GM signature page
    doc.addPage();
    doc.setFontSize(12);
    doc.text("GENERAL MANAGER SIGNATURE PAGE", 20, 40);
    doc.save(`${filename}.pdf`);
  }catch(e){
    console.error('printSectionPDF error', e);
    alert('Export failed — check console');
  }
}

// ---------- Auto-sync control ----------
function startAutoSync(){ if(syncInterval) clearInterval(syncInterval); syncInterval = setInterval(loadAllPreviews, 15000); loadAllPreviews(); }
function stopAutoSync(){ if(syncInterval) { clearInterval(syncInterval); syncInterval = null; } }
function manualSync(){ loadAllPreviews(); }

// ---------- Sticky note ----------
function saveSticky(){
  const val = document.getElementById('stickyNote')?.value || '';
  localStorage.setItem('stickyNote', val);
}
document.getElementById('stickyNote')?.addEventListener('blur', saveSticky);

// ---------- Helper to clear preview UI after logout ----------
function clearLocalPreviewDisplays(){
  const map = ['vesselPreviewSmall','arrivalsPreviewSmall','updatesPreviewSmall','memoPreviewSmall','trainingPreviewSmall','pniPreviewSmall'];
  map.forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = ''; });
  ['countVessel','countArrivals','countUpdates','countMemo','countTraining','countPNI'].forEach(id=>{ const e=document.getElementById(id); if(e) e.innerText='0'; });
}

// ---------- On DOM ready ----------
document.addEventListener('DOMContentLoaded', ()=>{
  // show sticky
  const saved = localStorage.getItem('stickyNote');
  if(saved) document.getElementById('stickyNote').value = saved;
  // Always show login first
  showLogin();
  // wire the manual sync / clear local used by your UI
  document.querySelector('button[onclick="manualSync()"]')?.addEventListener('click', manualSync);
  document.querySelector('button[onclick="clearAllLocal()"]')?.addEventListener('click', ()=>{
    if(confirm('Clear local cached previews?')){ localData = {}; clearLocalPreviewDisplays(); }
  });
  // wire print button (existing HTML calls printSectionPDF('dashboard','SeaCrew_Monthly_Report',true);)
  window.printSectionPDF = printSectionPDF;
  // expose other functions globally for HTML onclicks
  window.navToElement = function(s){ document.querySelectorAll('.section').forEach(sec=>sec.style.display='none'); const el=document.getElementById(s); if(el) el.style.display='block'; };
  window.manualSync = manualSync;
  window.clearAllLocal = function(){ if(confirm('Clear all local storage (sticky notes will be preserved)?')){ Object.keys(localStorage).forEach(k=>{ if(k!=='stickyNote') localStorage.removeItem(k); }); clearLocalPreviewDisplays(); } };
  window.printSectionPDF = printSectionPDF;
});
</script>
