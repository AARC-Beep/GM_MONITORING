<!-- PART 1: HEAD + CSS -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SeaCrew Dashboard — Daily Routine Log</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- jsPDF + AutoTable (for PDF export) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
.sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
.sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
.sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
.sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
.sidebar a.active { background:#072033; color:#fff; }
.content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
.card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
.small-note { font-size:0.9rem; color:#666; }
.preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
.entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
.entry-meta { color:#444; font-size:0.95rem; }
.form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.form-row .form-control { min-width:140px; }
.entry-actions button { margin-left:6px; }
.fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }

/* layout for list rows */
.row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
.row-entry .left { flex:1; }
.row-entry .right { display:flex; gap:8px; align-items:center; }

/* Chatboard */
.chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
.chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
.chat-inputs { display:flex; gap:8px; align-items:center; }

/* responsive */
@media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
@media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }

/* some small helpers */
.btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
</style>
<!-- PART 2: BODY / LAYOUT -->
<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <!-- External links requested -->
  <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
  <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
  <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
  <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
  <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
  <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 style="margin:0">SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Apps Script web app: <strong>DAILY ROUTINE LOG</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
      <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
    </div>
  </div>

  <!-- DASHBOARD (previews + chatboard) -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <!-- Previews columns -->
      <div class="col-md-8">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h5 style="margin:0">Quick Overview</h5>
            <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card-slim">
                <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                <div class="preview-table" id="vesselPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                <div class="preview-table" id="arrivalsPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                <div class="preview-table" id="updatesPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                <div class="preview-table" id="memoPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                <div class="preview-table" id="trainingPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                <div class="preview-table" id="pniPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Chatboard / Sticky -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>ChatBoard (public view)</h6>
          <div class="chatboard">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
              <input id="chatMsg" class="form-control" placeholder="Message" />
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
            <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
          </div>
        </div>

        <div class="card-slim mt-3">
          <h6>Sticky / Quick Note</h6>
          <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
            <button class="btn btn-primary" onclick="saveSticky()">Save</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ---------- Sections: Vessel Join / Arrivals / Updates / Memo / Training / PNI ---------- -->
  <!-- Vessel Join -->
  <section id="vesselJoin" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Vessel Crew Joining</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="vjVessel">
        <input class="form-control" placeholder="Port" id="vjPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
        <input class="form-control" placeholder="Rank" id="vjRank">
        <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
        <input class="form-control" placeholder="Flight" id="vjFlight">
        <button class="btn btn-success" id="vjAddBtn">Add</button>
        <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
      </div>
    </div>

    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    <div id="t_list" class="card-slim"></div>
  </section>

  <!-- PnI -->
  <section id="pni" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>P&amp;I / Events</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="pSubject">
        <input class="form-control" placeholder="Details" id="pDetails">
        <input class="form-control" type="date" id="pDate">
        <button class="btn btn-success" id="pAddBtn">Add</button>
        <button class="btn btn-secondary" id="pResetBtn">Reset</button>
      </div>
    </div>
    <div id="p_list" class="card-slim"></div>
  </section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- PART 3: FIXED JAVASCRIPT -->
<script>
/* ============ CONFIG ============ */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxBAGVWUE5ROI3EdL6ywHOlStybmlMVbS5Xp2aHsYf7laE5wrde4KF8HsJ57sEdioiT/exec';

/* Storage and mapping */
const SECTIONS = {
  vj:   { key:'vesselJoin', sheet:'Vessel_Join' },
  ac:   { key:'arrivingCrew', sheet:'Arrivals' },
  du:   { key:'dailyUpdates', sheet:'Updates' },
  memo: { key:'memo', sheet:'Memo' },
  tr:   { key:'training', sheet:'Training' },
  pni:  { key:'pni', sheet:'Pni' },
  chat: { key:'chatboard', sheet:'ChatBoard' }
};

/* ============ LOCAL STORAGE ============ */
function saveLocal(key, arr){ localStorage.setItem(key, JSON.stringify(arr||[])); }
function loadLocal(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }

/* ============ GENERAL UTILS ============ */
function fmtDate(d){ if(!d) return ""; const dt=new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString(); }
function escapeHtml(x){ if(!x) return ''; return String(x).replace(/[&<>\"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s])); }

/* ============ NAVIGATION ============ */
function navTo(e,id){
  e && e.preventDefault();
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
  const link=[...document.querySelectorAll('.sidebar a')].find(a=>a.dataset.target===id);
  if(link) link.classList.add('active');
}
function navToElement(id){ navTo(null,id); window.scrollTo({top:0,behavior:'smooth'}); }

/* ============ JSONP REQUEST ============ */
let __jsonp_counter = 0;
function jsonpRequest(params={}, timeout=8000){
  return new Promise((resolve,reject)=>{
    __jsonp_counter++;
    const callback = "__jsonp_cb_"+Date.now()+"_"+__jsonp_counter;
    params.callback = callback;

    const query = Object.keys(params).map(k=>`${encodeURIComponent(k)}=${encodeURIComponent(params[k])}`).join("&");
    const url = SCRIPT_URL + "?" + query;

    const script = document.createElement("script");
    script.src = url;
    script.async = true;

    let timer = setTimeout(()=>cleanup("timeout"), timeout);

    function cleanup(reason){
      clearTimeout(timer);
      delete window[callback];
      if(script.parentNode) script.parentNode.removeChild(script);
      if(reason==="timeout") reject(new Error("JSONP timeout"));
    }

    window[callback] = data => { cleanup(); resolve(data); };
    script.onerror = ()=>{ cleanup(); reject(new Error("JSONP script error")); };

    document.head.appendChild(script);
  });
}

/* ============ SERVER CALLS ============ */
async function callServerGet(sheet){
  try{
    const r = await jsonpRequest({action:'get', sheet});
    return r && r.data ? r.data : [];
  }catch(e){
    console.warn("Get failed", e);
    return [];
  }
}

async function callServerAppend(sheet, rowArray){
  try{
    return await jsonpRequest({action:'append', sheet, row: JSON.stringify(rowArray)});
  }catch(e){
    console.warn("Append failed", e);
    throw e;
  }
}

/* ============ BUILD ROW FORMAT ============ */
function buildRowForSheet(sheetName, payload){
  if(sheetName==='Vessel_Join' || sheetName==='Arrivals'){
    return [
      payload['Timestamp']||'',
      payload['Vessel']||'',
      payload['Port']||'',
      payload['No. of Crew']||payload['No of Crew']||'',
      payload['Rank']||'',
      payload['Date']||'',
      payload['Flight']||''
    ];
  }
  if(sheetName==='ChatBoard'){
    return [
      payload['Timestamp']||'',
      payload['Name']||'',
      payload['Message']||'',
      payload['Date']||''
    ];
  }
  if(sheetName==='Updates' || sheetName==='Memo'){
    return [
      payload['Timestamp']||'',
      payload['Title']||'',
      payload['Details']||'',
      payload['Date']||''
    ];
  }
  if(sheetName==='Training' || sheetName==='Pni'){
    return [
      payload['Timestamp']||'',
      payload['Subject']||'',
      payload['Details']||'',
      payload['Date']||''
    ];
  }
  return Object.values(payload);
}

/* ============ ADD ENTRY (SINGLE SAVE ONLY) ============ */
function addEntry(short){
  const meta = SECTIONS[short];
  const local = loadLocal(meta.key);

  let item = { id: Date.now() };

  /* collect inputs */
  function gv(id){ return document.getElementById(id).value.trim(); }
  function gd(id){ return document.getElementById(id).value; }

  if(short==='vj'){
    item.vessel = gv('vjVessel');
    item.port   = gv('vjPort');
    item.noCrew = gv('vjNo');
    item.rank   = gv('vjRank');
    item.date   = gd('vjDate');
    item.flight = gv('vjFlight');
    if(!item.vessel||!item.port||!item.noCrew||!item.rank||!item.date)
      return alert("Complete all Vessel Joining fields.");
  }

  if(short==='ac'){
    item.vessel = gv('acVessel');
    item.port   = gv('acPort');
    item.noCrew = gv('acNo');
    item.rank   = gv('acRank');
    item.date   = gd('acDate');
    item.flight = gv('acFlight');
    if(!item.vessel||!item.port||!item.noCrew||!item.rank||!item.date)
      return alert("Complete all Arriving Crew fields.");
  }

  if(short==='du'){
    item.title = gv('duTitle');
    item.details = gv('duDetails');
    item.date = gd('duDate');
  }

  if(short==='memo'){
    item.title = gv('mTitle');
    item.details = gv('mDetails');
    item.date = gd('mDate');
  }

  if(short==='tr'){
    item.subject = gv('tSubject');
    item.details = gv('tDetails');
    item.date = gd('tDate');
  }

  if(short==='pni'){
    item.subject = gv('pSubject');
    item.details = gv('pDetails');
    item.date = gd('pDate');
  }

  /* save locally */
  local.push(item);
  saveLocal(meta.key, local);
  renderList(short);
  clearForm(short);

  /* send to Google Sheet ONCE */
  const payload =
    short==='vj' || short==='ac'
      ? { Timestamp:'', Vessel:item.vessel, Port:item.port, 'No. of Crew':item.noCrew, Rank:item.rank, Date:item.date, Flight:item.flight }
      : short==='du' || short==='memo'
        ? { Timestamp:'', Title:item.title, Details:item.details, Date:item.date }
        : { Timestamp:'', Subject:item.subject, Details:item.details, Date:item.date };

  const arr = buildRowForSheet(meta.sheet, payload);

  callServerAppend(meta.sheet, arr)
    .then(()=> syncFromSheet())
    .catch(()=> {});
}

/* ============ RENDERING LISTS ============ */
function renderList(short){
  const meta = SECTIONS[short];
  const list = loadLocal(meta.key);
  const target = {
    vj:'vj_list', ac:'ac_list', du:'du_list',
    memo:'m_list', tr:'t_list', pni:'p_list'
  }[short];

  const el = document.getElementById(target);
  if(!el) return;
  el.innerHTML = '';

  list.forEach(item=>{
    const row = document.createElement('div');
    row.className = 'row-entry';
    const left = document.createElement('div');
    left.className='left';

    if(short==='vj'){
      left.innerHTML =
        `<strong>${escapeHtml(item.vessel)}</strong>
         <div>${escapeHtml(item.port)} · ${item.noCrew} crew · ${escapeHtml(item.rank)}</div>
         <div class="small-note">${fmtDate(item.date)} · ${escapeHtml(item.flight||'')}</div>`;
    }
    if(short==='ac'){
      left.innerHTML =
        `<strong>${escapeHtml(item.vessel)}</strong>
         <div>${escapeHtml(item.port)} · ${item.noCrew} crew · ${escapeHtml(item.rank)}</div>
         <small>${fmtDate(item.date)} · ${escapeHtml(item.flight||'')}</small>`;
    }

    if(short==='du'||short==='memo'){
      left.innerHTML =
        `<strong>${escapeHtml(item.title)}</strong>
         <div>${escapeHtml(item.details)}</div>
         <small>${fmtDate(item.date)}</small>`;
    }

    if(short==='tr'||short==='pni'){
      left.innerHTML =
        `<strong>${escapeHtml(item.subject)}</strong>
         <div>${escapeHtml(item.details)}</div>
         <small>${fmtDate(item.date)}</small>`;
    }

    const right=document.createElement('div');
    right.className='right';

    const del=document.createElement('button');
    del.className='btn btn-sm btn-outline-danger';
    del.innerHTML='<i class="fa-solid fa-trash"></i>';
    del.onclick=()=>deleteEntry(short,item.id);

    right.appendChild(del);
    row.appendChild(left);
    row.appendChild(right);
    el.appendChild(row);
  });

  updateCounts();
}

/* ============ DELETE ENTRY ============ */
function deleteEntry(short,id){
  if(!confirm("Delete this entry?")) return;
  const key = SECTIONS[short].key;
  let list = loadLocal(key);
  list = list.filter(x=>x.id!==id);
  saveLocal(key,list);
  renderList(short);
}

/* ============ CLEAR FORM ============ */
function clearForm(short){
  const ids = {
    vj:['vjVessel','vjPort','vjNo','vjRank','vjDate','vjFlight'],
    ac:['acVessel','acPort','acNo','acRank','acDate','acFlight'],
    du:['duTitle','duDetails','duDate'],
    memo:['mTitle','mDetails','mDate'],
    tr:['tSubject','tDetails','tDate'],
    pni:['pSubject','pDetails','pDate']
  }[short]||[];

  ids.forEach(id=>document.getElementById(id).value='');
}

/* ============ COUNTERS ============ */
function updateCounts(){
  document.getElementById('countVessel').innerText = loadLocal(SECTIONS.vj.key).length;
  document.getElementById('countArrivals').innerText = loadLocal(SECTIONS.ac.key).length;
  document.getElementById('countUpdates').innerText = loadLocal(SECTIONS.du.key).length;
  document.getElementById('countMemo').innerText = loadLocal(SECTIONS.memo.key).length;
  document.getElementById('countTraining').innerText = loadLocal(SECTIONS.tr.key).length;
  document.getElementById('countPNI').innerText = loadLocal(SECTIONS.pni.key).length;
}

/* ============ CHATBOARD ============ */
async function loadChat(){
  const data = await callServerGet("ChatBoard");
  if(!Array.isArray(data)) return;
  const el = document.getElementById("chatLog");
  el.innerHTML = data.reverse()
    .map(r=>`<div><strong>${escapeHtml(r.Name)}</strong><div>${escapeHtml(r.Message)}</div><small>${fmtDate(r.Date)}</small></div>`)
    .join('');
}

function sendChat(){
  const name = document.getElementById("chatName").value.trim() || "Anonymous";
  const msg  = document.getElementById("chatMsg").value.trim();
  if(!msg) return alert("Enter a message");

  const rowArr = buildRowForSheet("ChatBoard", {
    Timestamp:'',
    Name:name,
    Message:msg,
    Date:new Date().toISOString()
  });

  callServerAppend("ChatBoard", rowArr)
    .then(()=>{ document.getElementById("chatMsg").value=''; loadChat(); })
    .catch(()=>{ document.getElementById("chatMsg").value=''; loadChat(); });
}

/* ============ SYNC (ONE-WAY FROM SHEET) ============ */
async function syncFromSheet(){
  const tabs=['Vessel_Join','Arrivals','Updates','Memo','Training','Pni'];
  document.getElementById("lastSync").innerText = new Date().toLocaleString();

  for(const tab of tabs){
    const rows = await callServerGet(tab);
    const key = Object.values(SECTIONS).find(x=>x.sheet===tab).key;

    let mapped=[];
    if(tab==='Vessel_Join' || tab==='Arrivals'){
      mapped = rows.map(r=>({
        id:Date.now()+Math.random(),
        vessel:r.Vessel||'',
        port:r.Port||'',
        noCrew:r["No. of Crew"]||r["No of Crew"]||'',
        rank:r.Rank||'',
        date:r.Date||'',
        flight:r.Flight||''
      }));
    }
    if(tab==='Updates'||tab==='Memo'){
      mapped = rows.map(r=>({
        id:Date.now()+Math.random(),
        title:r.Title||'',
        details:r.Details||'',
        date:r.Date||''
      }));
    }
    if(tab==='Training'||tab==='Pni'){
      mapped = rows.map(r=>({
        id:Date.now()+Math.random(),
        subject:r.Subject||'',
        details:r.Details||'',
        date:r.Date||''
      }));
    }

    saveLocal(key,mapped);
    renderList(Object.keys(SECTIONS).find(k=>SECTIONS[k].sheet===tab));
  }

  loadChat();
}

/* ============ INITIALIZE ============ */
function init(){
  ["vj","ac","du","memo","tr","pni"].forEach(short=>renderList(short));
  loadChat();
  syncFromSheet();

  // ✅ FIXED: NOW ONLY SYNC, NOT RE-APPEND
  setInterval(()=> syncFromSheet(), 15000);
}

window.addEventListener("DOMContentLoaded", init);
</script>

