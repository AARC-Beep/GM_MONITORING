<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SeaCrew Dashboard — Daily Routine Log</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
    .sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
    .sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
    .sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
    .sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
    .sidebar a.active { background:#072033; color:#fff; }
    .content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
    .card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
    .small-note { font-size:0.9rem; color:#666; }
    .preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
    .entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
    .entry-meta { color:#444; font-size:0.95rem; }
    .form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .form-row .form-control { min-width:140px; }
    .entry-actions button { margin-left:6px; }
    .fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }
    .row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
    .row-entry .left { flex:1; }
    .row-entry .right { display:flex; gap:8px; align-items:center; }
    .chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
    .chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
    .chat-inputs { display:flex; gap:8px; align-items:center; }
    @media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
    @media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }
    .btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
    /* login overlay */
    .overlay { position:fixed; inset:0; background: rgba(2,6,23,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .login-box { width:420px; background:#fff; padding:24px; border-radius:12px; box-shadow:0 10px 40px rgba(2,6,23,0.4); }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="overlay" style="display:none">
    <div class="login-box">
      <div class="text-center mb-3">
        <h4 style="margin:0">TIWALA — SeaCrew Dashboard</h4>
        <small class="small-note">Please sign in to continue</small>
      </div>
      <div class="mb-2">
        <label class="form-label">Username</label>
        <input id="loginUser" class="form-control" />
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input id="loginPass" type="password" class="form-control" />
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <div><small id="loginError" class="text-danger"></small></div>
        <div>
          <button class="btn btn-secondary" id="loginCancel">Cancel</button>
          <button class="btn btn-primary" id="loginBtn">Sign in</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <nav class="sidebar" aria-label="Main navigation">
    <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

    <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
    <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
    <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
    <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
    <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
    <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
    <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>
    <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')"><i class="fa-solid fa-circle-info"></i> Help / User Guide</a>

    <hr style="border-color:rgba(255,255,255,0.06)"/>

    <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
    <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
    <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
    <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
    <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
    <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>

    <hr style="border-color:rgba(255,255,255,0.06)"/>
    <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
    <div style="margin-top:12px">
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </nav>

  <!-- Main content -->
  <main class="content" role="main">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <h2 style="margin:0">SeaCrew Dashboard</h2>
        <div class="small-note">Connected to Google Apps Script web app: <strong id="scriptUrlLabel"></strong></div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
        <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
        <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
      </div>
    </div>

    <!-- DASHBOARD (previews + chatboard) -->
    <section id="dashboard" class="section active">
      <div class="row g-3">
        <div class="col-md-8">
          <div class="card-slim">
            <div class="d-flex justify-content-between align-items-center">
              <h5 style="margin:0">Quick Overview</h5>
              <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
            </div>

            <div class="row g-3 mt-3">
              <div class="col-md-6">
                <div class="card-slim">
                  <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                  <div class="preview-table" id="vesselPreviewSmall"></div>
                  <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card-slim">
                  <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                  <div class="preview-table" id="arrivalsPreviewSmall"></div>
                  <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card-slim">
                  <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                  <div class="preview-table" id="updatesPreviewSmall"></div>
                  <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card-slim">
                  <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                  <div class="preview-table" id="memoPreviewSmall"></div>
                  <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card-slim">
                  <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                  <div class="preview-table" id="trainingPreviewSmall"></div>
                  <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card-slim">
                  <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                  <div class="preview-table" id="pniPreviewSmall"></div>
                  <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Chatboard / Sticky -->
        <div class="col-md-4">
          <div class="card-slim">
            <div class="d-flex justify-content-between align-items-center">
              <h6 style="margin:0">ChatBoard (public view)</h6>
              <div><button id="chatBellBtn" class="btn btn-sm btn-outline-secondary" title="Toggle sound"><i id="chatBellIcon" class="fa-solid fa-bell"></i></button></div>
            </div>

            <div class="chatboard mt-3">
              <div class="chat-log" id="chatLog"></div>
              <div class="chat-inputs">
                <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
                <input id="chatMsg" class="form-control" placeholder="Message" />
                <button class="btn btn-primary" id="chatSendBtn">Send</button>
              </div>
              <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
            </div>
          </div>

          <div class="card-slim mt-3">
            <h6>Sticky / Quick Note</h6>
            <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
            <div class="d-flex justify-content-end mt-2">
              <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
              <button class="btn btn-primary" onclick="saveSticky()">Save</button>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Vessel Join -->
    <section id="vesselJoin" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Vessel Crew Joining</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
        </div>
      </div>

      <div class="card-slim mb-3">
        <div class="form-row">
          <input class="form-control" placeholder="Vessel" id="vjVessel">
          <input class="form-control" placeholder="Port" id="vjPort">
          <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
          <input class="form-control" placeholder="Rank" id="vjRank">
          <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
          <input class="form-control" placeholder="Flight" id="vjFlight">

          <button class="btn btn-success" id="vjAddBtn">Add</button>
          <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
        </div>
      </div>

      <div id="vj_list" class="card-slim"></div>
    </section>

    <!-- Arriving Crew -->
    <section id="arrivingCrew" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Arriving Crew</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
        </div>
      </div>

      <div class="card-slim mb-3">
        <div class="form-row">
          <input class="form-control" placeholder="Vessel" id="acVessel">
          <input class="form-control" placeholder="Port" id="acPort">
          <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
          <input class="form-control" placeholder="Rank" id="acRank">
          <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
          <input class="form-control" placeholder="Flight" id="acFlight">
          <button class="btn btn-success" id="acAddBtn">Add</button>
          <button class="btn btn-secondary" id="acResetBtn">Reset</button>
        </div>
      </div>

      <div id="ac_list" class="card-slim"></div>
    </section>

    <!-- Daily Updates -->
    <section id="dailyUpdates" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Daily Updates</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
        </div>
      </div>

      <div class="card-slim mb-3">
        <div class="form-row">
          <input class="form-control" placeholder="Title" id="duTitle">
          <input class="form-control" placeholder="Details" id="duDetails">
          <input class="form-control" type="date" id="duDate">
          <button class="btn btn-success" id="duAddBtn">Add</button>
          <button class="btn btn-secondary" id="duResetBtn">Reset</button>
        </div>
      </div>
      <div id="du_list" class="card-slim"></div>
    </section>

    <!-- Memo -->
    <section id="memo" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Memo</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
        </div>
      </div>

      <div class="card-slim mb-3">
        <div class="form-row">
          <input class="form-control" placeholder="Title" id="mTitle">
          <input class="form-control" placeholder="Details" id="mDetails">
          <input class="form-control" type="date" id="mDate">
          <button class="btn btn-success" id="mAddBtn">Add</button>
          <button class="btn btn-secondary" id="mResetBtn">Reset</button>
        </div>
      </div>
      <div id="m_list" class="card-slim"></div>
    </section>

    <!-- Training -->
    <section id="training" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Training</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
        </div>
      </div>

      <div class="card-slim mb-3">
        <div class="form-row">
          <input class="form-control" placeholder="Subject" id="tSubject">
          <input class="form-control" placeholder="Details" id="tDetails">
          <input class="form-control" type="date" id="tDate">
          <button class="btn btn-success" id="tAddBtn">Add</button>
          <button class="btn btn-secondary" id="tResetBtn">Reset</button>
        </div>
      </div>

      <div id="t_list" class="card-slim"></div>
    </section>

    <!-- PnI -->
    <section id="pni" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>P&amp;I / Events</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
          <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
        </div>
      </div>

      <div class="card-slim mb-3">
        <div class="form-row">
          <input class="form-control" placeholder="Subject" id="pSubject">
          <input class="form-control" placeholder="Details" id="pDetails">
          <input class="form-control" type="date" id="pDate">
          <button class="btn btn-success" id="pAddBtn">Add</button>
          <button class="btn btn-secondary" id="pResetBtn">Reset</button>
        </div>
      </div>

      <div id="p_list" class="card-slim"></div>
    </section>

    <!-- HELP / USER GUIDE -->
    <section id="helpSection" class="section" style="display:none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>User Guide / Help</h4>
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('helpSection','User_Guide')">Export PDF</button>
      </div>

      <div class="card-slim" style="font-size:14px; line-height:1.5">
        <h5>SeaCrew Dashboard — Daily Routine Log (User Guide)</h5>
        <p>This dashboard connects to the SeaCrew Google Sheet. Sign in with your Username & Password as listed in the <strong>Users</strong> sheet.</p>
        <ul>
          <li>Add entries in each section using the form at the top of that section. Click Add to save locally and attempt to sync to Google Sheets.</li>
          <li>Edit: click the pencil icon on an entry. The form fields will populate — Update will save and push to sheet (same UID), not create duplicates.</li>
          <li>Delete: click the trash icon — this moves the row to an archive sheet (Archive_&lt;SheetName&gt;) on the server and removes locally.</li>
          <li>ChatBoard: anyone can post (if permitted). New messages play a bell if enabled.</li>
          <li>Monthly report: exports Archive + current sheet entries so deleted rows still appear in monthly reports.</li>
        </ul>
      </div>
    </section>

    <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PART 3: FULL JAVASCRIPT (CLIENT) -->
  <script>
  /*************************************************************************
   *  Configuration - set your deployed Apps Script URL here (replace)
   *************************************************************************/
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzkykBFEZTIWUZcsCM2Lb0_bUaqGKAQWzxK-2f4IrpP6ekN9iuh6gpGrCSeNU6uvYhc/exec";

  // Sheet mapping (local key, sheet name)
  const SECTIONS = {
    vj: { key:'vesselJoin', sheet:'Vessel_Join' },
    ac: { key:'arrivingCrew', sheet:'Arrivals' },
    du: { key:'dailyUpdates', sheet:'Updates' },
    memo: { key:'memo', sheet:'Memo' },
    tr: { key:'training', sheet:'Training' },
    pni:{ key:'pni', sheet:'Pni' },
    chat:{ key:'chatboard', sheet:'ChatBoard' }
  };

  // UI labels
  document.getElementById('scriptUrlLabel').innerText = SCRIPT_URL;

  /* ---------- local storage helpers ---------- */
  function saveLocal(key, arr){ localStorage.setItem(key, JSON.stringify(arr || [])); }
  function loadLocal(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }

  /* ---------- small utilities ---------- */
  function fmtDate(d){ if(!d) return ""; const dt=new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString(); }
  function escapeHtml(unsafe){ if(!unsafe && unsafe !== 0) return ''; return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;"); }
  function makeUID(){ return 'UID-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }
  function navTo(e, id){ e && e.preventDefault(); document.querySelectorAll('.section').forEach(s=>s.style.display='none'); const el = document.getElementById(id); if(el) el.style.display='block'; document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active')); const link = Array.from(document.querySelectorAll('.sidebar a')).find(a=>a.dataset.target===id); if(link) link.classList.add('active'); }
  function navToElement(id){ navTo(null,id); window.scrollTo({top:0,behavior:'smooth'}); }

  /* ---------- JSONP helper ---------- */
  let __jsonp_counter = 0;
  function jsonpRequest(params = {}, timeout = 9000) {
    return new Promise((resolve, reject) => {
      if(!SCRIPT_URL) return reject(new Error('SCRIPT_URL not set'));
      __jsonp_counter++;
      const cbName = '__jsonp_cb_' + Date.now() + '_' + __jsonp_counter;
      params.callback = cbName;
      const query = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
      const src = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + query;

      const script = document.createElement('script');
      script.src = src;
      script.async = true;

      let timer = setTimeout(()=> {
        cleanup();
        reject(new Error('JSONP timeout'));
      }, timeout);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
        if(script.parentNode) script.parentNode.removeChild(script);
      }

      window[cbName] = function(data){
        cleanup();
        resolve(data);
      };

      script.onerror = function(err){
        cleanup();
        reject(new Error('JSONP script error'));
      };

      document.head.appendChild(script);
    });
  }

  /* ---------- Server wrappers ---------- */
  async function callServerGet(sheetName){
    try{
      const resp = await jsonpRequest({ action: 'get', sheet: sheetName }, 9000);
      if(!resp) return [];
      return resp.data || [];
    } catch(err){
      console.warn('callServerGet error', err);
      return [];
    }
  }
  async function callServerFetchAll(sheetNamesCsv){
    try{
      const resp = await jsonpRequest({ action: 'fetchAll', sheets: sheetNamesCsv }, 12000);
      if(!resp) return {};
      return resp.data || {};
    } catch(e){
      console.warn('fetchAll err', e);
      return {};
    }
  }
  async function callServerAppend(sheetName, rowArray){
    try{
      const resp = await jsonpRequest({ action: 'append', sheet: sheetName, row: JSON.stringify(rowArray) }, 9000);
      return resp;
    } catch(err){
      console.warn('append failed', err);
      throw err;
    }
  }
  async function callServerUpdateUID(sheetName, uid, rowArray){
    try{
      const resp = await jsonpRequest({ action: 'update_uid', sheet: sheetName, uid: uid, row: JSON.stringify(rowArray) }, 9000);
      return resp;
    } catch(err){
      console.warn('update_uid failed', err);
      throw err;
    }
  }
  async function callServerDeleteUID(sheetName, uid){
    try{
      const resp = await jsonpRequest({ action: 'delete_uid', sheet: sheetName, uid: uid }, 9000);
      return resp;
    } catch(err){
      console.warn('delete_uid failed', err);
      throw err;
    }
  }
  async function callServerAuth(username, password){
    try{
      const resp = await jsonpRequest({ action: 'auth', username: username, password: password }, 6000);
      return resp;
    } catch(err){
      console.warn('auth failed', err);
      return { success:false, message: 'Auth error' };
    }
  }

  /* ---------- Build sheet row arrays (header order) ---------- */
  function buildRowForSheet(sheetName, payloadObj){
    if(sheetName === 'Vessel_Join' || sheetName === 'Arrivals'){
      return [
        payloadObj['Timestamp'] || '',
        payloadObj['Vessel'] || '',
        payloadObj['Port'] || '',
        payloadObj['No. of Crew'] || payloadObj['No of Crew'] || '',
        payloadObj['Rank'] || '',
        payloadObj['Date'] || '',
        payloadObj['Flight'] || '',
        payloadObj['UID'] || ''
      ];
    }
    if(sheetName === 'ChatBoard'){
      return [
        payloadObj['Timestamp'] || '',
        payloadObj['Name'] || payloadObj['name'] || '',
        payloadObj['Message'] || payloadObj['message'] || '',
        payloadObj['Date'] || '',
        payloadObj['UID'] || ''
      ];
    }
    if(sheetName === 'Updates' || sheetName === 'Memo'){
      return [
        payloadObj['Timestamp'] || '',
        payloadObj['Title'] || payloadObj['title'] || '',
        payloadObj['Details'] || payloadObj['details'] || '',
        payloadObj['Date'] || '',
        payloadObj['UID'] || ''
      ];
    }
    if(sheetName === 'Training' || sheetName === 'Pni'){
      return [
        payloadObj['Timestamp'] || '',
        payloadObj['Subject'] || payloadObj['subject'] || '',
        payloadObj['Details'] || payloadObj['details'] || '',
        payloadObj['Date'] || '',
        payloadObj['UID'] || ''
      ];
    }
    // fallback
    const arr = Object.values(payloadObj || {});
    arr.push(payloadObj && payloadObj.UID ? payloadObj.UID : '');
    return arr;
  }

  /* ---------- Add / Update / Delete / Render ---------- */
  const editState = { vj:null, ac:null, du:null, memo:null, tr:null, pni:null };

  function addEntry(sectionShort){
    if(!(sectionShort in SECTIONS)) return;
    const meta = SECTIONS[sectionShort];
    const key = meta.key;
    const list = loadLocal(key);

    let item = { id: Date.now() };

    // collect fields
    if(sectionShort === 'vj'){
      item.vessel = document.getElementById('vjVessel').value.trim();
      item.port = document.getElementById('vjPort').value.trim();
      item.noCrew = document.getElementById('vjNo').value.trim();
      item.rank = document.getElementById('vjRank').value.trim();
      item.date = document.getElementById('vjDate').value;
      item.flight = document.getElementById('vjFlight').value.trim();
    } else if(sectionShort === 'ac'){
      item.vessel = document.getElementById('acVessel').value.trim();
      item.port = document.getElementById('acPort').value.trim();
      item.noCrew = document.getElementById('acNo').value.trim();
      item.rank = document.getElementById('acRank').value.trim();
      item.date = document.getElementById('acDate').value;
      item.flight = document.getElementById('acFlight').value.trim();
    } else if(sectionShort === 'du'){
      item.title = document.getElementById('duTitle').value.trim();
      item.details = document.getElementById('duDetails').value.trim();
      item.date = document.getElementById('duDate').value;
    } else if(sectionShort === 'memo'){
      item.title = document.getElementById('mTitle').value.trim();
      item.details = document.getElementById('mDetails').value.trim();
      item.date = document.getElementById('mDate').value;
    } else if(sectionShort === 'tr'){
      item.subject = document.getElementById('tSubject').value.trim();
      item.details = document.getElementById('tDetails').value.trim();
      item.date = document.getElementById('tDate').value;
    } else if(sectionShort === 'pni'){
      item.subject = document.getElementById('pSubject').value.trim();
      item.details = document.getElementById('pDetails').value.trim();
      item.date = document.getElementById('pDate').value;
    }

    // minimal validation
    if(sectionShort==='vj' && (!item.vessel || !item.port || !item.noCrew || !item.rank || !item.date)){
      return alert('Please fill required fields for Vessel Joining (Vessel/Port/No of Crew/Rank/Date).');
    }
    if(sectionShort==='ac' && (!item.vessel || !item.port || !item.noCrew || !item.rank || !item.date)){
      return alert('Please fill required fields for Arriving Crew (Vessel/Port/No of Crew/Rank/Date).');
    }

    // assign UID and mark as not yet synced
    item.uid = makeUID();
    item.synced = false;
    list.push(item);
    saveLocal(key, list);
    renderList(sectionShort);
    clearForm(sectionShort);

    // attempt append to server
    let payloadArray = [];
    const sheetName = meta.sheet;
    if(sectionShort === 'vj' || sectionShort === 'ac'){
      const payloadObj = { 'Timestamp':'', 'Vessel': item.vessel || '', 'Port': item.port || '', 'No. of Crew': item.noCrew || '', 'Rank': item.rank || '', 'Date': item.date || '', 'Flight': item.flight || '', 'UID': item.uid };
      payloadArray = buildRowForSheet(sheetName, payloadObj);
    } else if(sectionShort === 'du' || sectionShort === 'memo'){
      const payloadObj = { 'Timestamp':'', 'Title': item.title || '', 'Details': item.details || '', 'Date': item.date || '', 'UID': item.uid };
      payloadArray = buildRowForSheet(sheetName, payloadObj);
    } else if(sectionShort === 'tr' || sectionShort === 'pni'){
      const payloadObj = { 'Timestamp':'', 'Subject': item.subject || '', 'Details': item.details || '', 'Date': item.date || '', 'UID': item.uid };
      payloadArray = buildRowForSheet(sheetName, payloadObj);
    }

    callServerAppend(sheetName, payloadArray).then(res=>{
      // mark local as synced
      const localList = loadLocal(key);
      const idx = localList.findIndex(x => x.uid === item.uid);
      if(idx >= 0){ localList[idx].synced = true; saveLocal(key, localList); }
      // refresh authoritative data
      syncFromSheet().catch(()=>{});
    }).catch(err=>{
      console.warn('append failed, saved locally for retry on next sync', err);
    });
  }

  function renderList(sectionShort){
    const meta = SECTIONS[sectionShort];
    const key = meta.key;
    const idMap = { vj: 'vj_list', ac: 'ac_list', du: 'du_list', memo: 'm_list', tr: 't_list', pni: 'p_list' };
    const containerEl = document.getElementById(idMap[sectionShort]);
    if(!containerEl) return;
    // filter out empty rows
    const list = loadLocal(key).filter(ep => ep && (ep.vessel || ep.port || ep.title || ep.subject || ep.details || ep.name || ep.message));
    containerEl.innerHTML = '';

    list.forEach(ep => {
      const row = document.createElement('div'); row.className='row-entry';
      const left = document.createElement('div'); left.className='left';
      if(sectionShort === 'vj'){
        left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div>
          <div class="entry-meta">${escapeHtml(ep.port)} · ${escapeHtml(ep.noCrew)} crew · ${escapeHtml(ep.rank)}</div>
          <div class="small-note">Date: ${fmtDate(ep.date)} ${ep.flight? ' · ' + escapeHtml(ep.flight):''}${ep.synced? ' · (synced)':''}</div>`;
      } else if(sectionShort === 'ac'){
        left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div>
          <div class="entry-meta">${escapeHtml(ep.port)} · ${escapeHtml(ep.noCrew)} crew · ${escapeHtml(ep.rank)}</div>
          <div class="small-note">Arrival: ${fmtDate(ep.date)} ${ep.flight? ' · ' + escapeHtml(ep.flight):''}${ep.synced? ' · (synced)':''}</div>`;
      } else if(sectionShort === 'du' || sectionShort === 'memo'){
        const title = escapeHtml(ep.title || '');
        left.innerHTML = `<div style="font-weight:700">${title}</div><div class="small-note">${escapeHtml(ep.details)}</div><div class="small-note">${fmtDate(ep.date)}${ep.synced? ' · (synced)':''}</div>`;
      } else if(sectionShort === 'tr' || sectionShort === 'pni'){
        const title = escapeHtml(ep.subject || '');
        left.innerHTML = `<div style="font-weight:700">${title}</div><div class="small-note">${escapeHtml(ep.details)}</div><div class="small-note">${fmtDate(ep.date)}${ep.synced? ' · (synced)':''}</div>`;
      }

      const right = document.createElement('div'); right.className='right';
      const editBtn = document.createElement('button'); editBtn.className='btn btn-sm btn-outline-primary'; editBtn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
      editBtn.onclick = ()=> startEdit(sectionShort, ep.id);
      const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-outline-danger'; delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      delBtn.onclick = ()=> deleteEntry(sectionShort, ep.id);
      right.appendChild(editBtn); right.appendChild(delBtn);

      row.appendChild(left); row.appendChild(right);
      containerEl.appendChild(row);
    });

    updateSmallPreview(sectionShort); updateCounts();
  }

  function updateSmallPreview(sectionShort){
    const key = SECTIONS[sectionShort].key;
    const list = loadLocal(key);
    const previewIdMap = { vj:'vesselPreviewSmall', ac:'arrivalsPreviewSmall', du:'updatesPreviewSmall', memo:'memoPreviewSmall', tr:'trainingPreviewSmall', pni:'pniPreviewSmall' };
    const previewEl = document.getElementById(previewIdMap[sectionShort]);
    if(!previewEl) return;
    const last3 = list.slice(-3).reverse();
    previewEl.innerHTML = last3.map(item=>{
      if(sectionShort==='vj') return `<div><strong>${escapeHtml(item.vessel)}</strong> — ${escapeHtml(item.port)} · ${escapeHtml(item.noCrew)} crew · ${escapeHtml(item.rank)}${item.synced? ' · (synced)':''}</div>`;
      if(sectionShort==='ac') return `<div><strong>${escapeHtml(item.vessel)}</strong> — ${escapeHtml(item.port)} · ${escapeHtml(item.noCrew)} crew · ${escapeHtml(item.rank)}${item.synced? ' · (synced)':''}</div>`;
      if(sectionShort==='du') return `<div><strong>${escapeHtml(item.title)}</strong> — ${fmtDate(item.date)}<div class="small-note">${escapeHtml(item.details)}</div></div>`;
      if(sectionShort==='memo') return `<div><strong>${escapeHtml(item.title)}</strong> — ${fmtDate(item.date)}</div>`;
      if(sectionShort==='tr') return `<div><strong>${escapeHtml(item.subject)}</strong> — ${fmtDate(item.date)}</div>`;
      if(sectionShort==='pni') return `<div><strong>${escapeHtml(item.subject)}</strong> — ${fmtDate(item.date)}</div>`;
      return '';
    }).join('');
  }

  function updateCounts(){
    document.getElementById('countVessel').innerText = loadLocal(SECTIONS.vj.key).length;
    document.getElementById('countArrivals').innerText = loadLocal(SECTIONS.ac.key).length;
    document.getElementById('countUpdates').innerText = loadLocal(SECTIONS.du.key).length;
    document.getElementById('countMemo').innerText = loadLocal(SECTIONS.memo.key).length;
    document.getElementById('countTraining').innerText = loadLocal(SECTIONS.tr.key).length;
    document.getElementById('countPNI').innerText = loadLocal(SECTIONS.pni.key).length;
  }

  function clearSection(sectionId){
    if(!confirm('Clear ALL entries for this section (local only)?')) return;
    const short = mapSectionIdToShort(sectionId);
    if(!short) return;
    localStorage.removeItem(SECTIONS[short].key);
    renderList(short);
  }

  function clearAllLocal(){
    if(!confirm('Clear ALL local data? This will NOT delete your Google Sheet data.')) return;
    Object.keys(SECTIONS).forEach(k => localStorage.removeItem(SECTIONS[k].key));
    Object.keys(SECTIONS).forEach(k => renderList(k));
    updateCounts();
  }

  function mapSectionIdToShort(sectionId){
    if(sectionId==='vesselJoin') return 'vj';
    if(sectionId==='arrivingCrew') return 'ac';
    if(sectionId==='dailyUpdates') return 'du';
    if(sectionId==='memo') return 'memo';
    if(sectionId==='training') return 'tr';
    if(sectionId==='pni') return 'pni';
    return null;
  }

  /* ---------- Delete: local + server (by UID) ---------- */
  function deleteEntry(sectionShort, id){
    const meta = SECTIONS[sectionShort];
    const key = meta.key;
    let list = loadLocal(key);
    const idx = list.findIndex(x => x.id === id);
    if(idx === -1) return;
    if(!confirm('Delete this entry?')) return;

    // capture uid
    const uid = list[idx].uid || list[idx].UID || null;

    // remove locally
    list.splice(idx,1);
    saveLocal(key, list);
    renderList(sectionShort);

    // call server delete by UID if exists
    if(uid){
      callServerDeleteUID(meta.sheet, uid).then(res=>{
        console.log('server delete OK', res);
        syncFromSheet().catch(()=>{});
      }).catch(err=>{
        console.warn('server delete failed, will retry on next sync', err);
      });
    }
  }

  /* ---------- Edit handling ---------- */
  function startEdit(sectionShort, id){
    const key = SECTIONS[sectionShort].key;
    const list = loadLocal(key);
    const item = list.find(x=>x.id === id);
    if(!item) return;
    editState[sectionShort] = { id: item.id, uid: item.uid || item.UID || null };

    if(sectionShort === 'vj'){
      document.getElementById('vjVessel').value = item.vessel || '';
      document.getElementById('vjPort').value = item.port || '';
      document.getElementById('vjNo').value = item.noCrew || '';
      document.getElementById('vjRank').value = item.rank || '';
      document.getElementById('vjDate').value = item.date || '';
      document.getElementById('vjFlight').value = item.flight || '';
      window.scrollTo({top:0,behavior:'smooth'});
    } else if(sectionShort === 'ac'){
      document.getElementById('acVessel').value = item.vessel || '';
      document.getElementById('acPort').value = item.port || '';
      document.getElementById('acNo').value = item.noCrew || '';
      document.getElementById('acRank').value = item.rank || '';
      document.getElementById('acDate').value = item.date || '';
      document.getElementById('acFlight').value = item.flight || '';
      window.scrollTo({top:0,behavior:'smooth'});
    } else if(sectionShort === 'du'){
      document.getElementById('duTitle').value = item.title || '';
      document.getElementById('duDetails').value = item.details || '';
      document.getElementById('duDate').value = item.date || '';
    } else if(sectionShort === 'memo'){
      document.getElementById('mTitle').value = item.title || '';
      document.getElementById('mDetails').value = item.details || '';
      document.getElementById('mDate').value = item.date || '';
    } else if(sectionShort === 'tr'){
      document.getElementById('tSubject').value = item.subject || '';
      document.getElementById('tDetails').value = item.details || '';
      document.getElementById('tDate').value = item.date || '';
    } else if(sectionShort === 'pni'){
      document.getElementById('pSubject').value = item.subject || '';
      document.getElementById('pDetails').value = item.details || '';
      document.getElementById('pDate').value = item.date || '';
    }

    const mapBtn = { vj:'vjAddBtn', ac:'acAddBtn', du:'duAddBtn', memo:'mAddBtn', tr:'tAddBtn', pni:'pAddBtn' };
    const btn = document.getElementById(mapBtn[sectionShort]);
    if(btn){ btn.innerText = 'Update'; btn.classList.remove('btn-success'); btn.classList.add('btn-warning'); }
  }

  function clearForm(sectionShort){
    if(sectionShort==='vj'){ ['vjVessel','vjPort','vjNo','vjRank','vjDate','vjFlight'].forEach(id=>document.getElementById(id).value=''); }
    if(sectionShort==='ac'){ ['acVessel','acPort','acNo','acRank','acDate','acFlight'].forEach(id=>document.getElementById(id).value=''); }
    if(sectionShort==='du'){ ['duTitle','duDetails','duDate'].forEach(id=>document.getElementById(id).value=''); }
    if(sectionShort==='memo'){ ['mTitle','mDetails','mDate'].forEach(id=>document.getElementById(id).value=''); }
    if(sectionShort==='tr'){ ['tSubject','tDetails','tDate'].forEach(id=>document.getElementById(id).value=''); }
    if(sectionShort==='pni'){ ['pSubject','pDetails','pDate'].forEach(id=>document.getElementById(id).value=''); }
    ['vjAddBtn','acAddBtn','duAddBtn','mAddBtn','tAddBtn','pAddBtn'].forEach(id=>{
      const b=document.getElementById(id); if(b){ b.innerText='Add'; b.classList.remove('btn-warning'); b.classList.add('btn-success'); }
    });
    if(sectionShort) editState[sectionShort]=null;
  }

  /* ---------- Wire up buttons ---------- */
  function wireUpButtons(){
    document.getElementById('vjAddBtn').addEventListener('click', ()=> {
      const short='vj';
      if(editState.vj){
        let list = loadLocal(SECTIONS.vj.key);
        const idx = list.findIndex(x=>x.id === editState.vj.id);
        if(idx>=0){
          const uid = list[idx].uid || list[idx].UID || null;
          list[idx].vessel = document.getElementById('vjVessel').value.trim();
          list[idx].port = document.getElementById('vjPort').value.trim();
          list[idx].noCrew = document.getElementById('vjNo').value.trim();
          list[idx].rank = document.getElementById('vjRank').value.trim();
          list[idx].date = document.getElementById('vjDate').value;
          list[idx].flight = document.getElementById('vjFlight').value.trim();
          list[idx].synced = false;
          saveLocal(SECTIONS.vj.key, list);
          renderList('vj');
          // If UID exists call update_uid
          if(uid){
            const payloadObj = { 'Timestamp':'', 'Vessel': list[idx].vessel || '', 'Port': list[idx].port || '', 'No. of Crew': list[idx].noCrew || '', 'Rank': list[idx].rank || '', 'Date': list[idx].date || '', 'Flight': list[idx].flight || '', 'UID': uid };
            const rowArr = buildRowForSheet('Vessel_Join', payloadObj);
            callServerUpdateUID('Vessel_Join', uid, rowArr).then(()=>{ list[idx].synced = true; saveLocal(SECTIONS.vj.key, list); syncFromSheet().catch(()=>{}); }).catch(()=>{});
          }
          clearForm('vj'); editState.vj=null;
        }
      } else { addEntry('vj'); }
    });
    document.getElementById('vjResetBtn').addEventListener('click', ()=> clearForm('vj'));

    document.getElementById('acAddBtn').addEventListener('click', ()=> {
      if(editState.ac){
        let list = loadLocal(SECTIONS.ac.key);
        const idx = list.findIndex(x=>x.id === editState.ac.id);
        if(idx>=0){
          const uid = list[idx].uid || list[idx].UID || null;
          list[idx].vessel = document.getElementById('acVessel').value.trim();
          list[idx].port = document.getElementById('acPort').value.trim();
          list[idx].noCrew = document.getElementById('acNo').value.trim();
          list[idx].rank = document.getElementById('acRank').value.trim();
          list[idx].date = document.getElementById('acDate').value;
          list[idx].flight = document.getElementById('acFlight').value.trim();
          list[idx].synced = false;
          saveLocal(SECTIONS.ac.key, list);
          renderList('ac');
          if(uid){
            const payloadObj = { 'Timestamp':'', 'Vessel': list[idx].vessel || '', 'Port': list[idx].port || '', 'No. of Crew': list[idx].noCrew || '', 'Rank': list[idx].rank || '', 'Date': list[idx].date || '', 'Flight': list[idx].flight || '', 'UID': uid };
            const rowArr = buildRowForSheet('Arrivals', payloadObj);
            callServerUpdateUID('Arrivals', uid, rowArr).then(()=>{ list[idx].synced = true; saveLocal(SECTIONS.ac.key, list); syncFromSheet().catch(()=>{}); }).catch(()=>{});
          }
          clearForm('ac'); editState.ac=null;
        }
      } else { addEntry('ac'); }
    });
    document.getElementById('acResetBtn').addEventListener('click', ()=> clearForm('ac'));

    document.getElementById('duAddBtn').addEventListener('click', ()=> {
      const short = 'du';
      if(editState.du){
        let list = loadLocal(SECTIONS.du.key);
        const idx = list.findIndex(x=>x.id === editState.du.id);
        if(idx>=0){
          const uid = list[idx].uid || list[idx].UID || null;
          list[idx].title = document.getElementById('duTitle').value.trim();
          list[idx].details = document.getElementById('duDetails').value.trim();
          list[idx].date = document.getElementById('duDate').value;
          list[idx].synced = false;
          saveLocal(SECTIONS.du.key, list);
          renderList('du');
          if(uid){
            const payloadObj = { 'Timestamp':'', 'Title': list[idx].title || '', 'Details': list[idx].details || '', 'Date': list[idx].date || '', 'UID': uid };
            const rowArr = buildRowForSheet('Updates', payloadObj);
            callServerUpdateUID('Updates', uid, rowArr).then(()=>{ list[idx].synced = true; saveLocal(SECTIONS.du.key, list); syncFromSheet().catch(()=>{}); }).catch(()=>{});
          }
          clearForm('du'); editState.du=null;
        }
      } else { addEntry('du'); }
    });
    document.getElementById('duResetBtn').addEventListener('click', ()=> clearForm('du'));

    document.getElementById('mAddBtn').addEventListener('click', ()=> {
      const short = 'memo';
      if(editState.memo){
        let list = loadLocal(SECTIONS.memo.key);
        const idx = list.findIndex(x=>x.id === editState.memo.id);
        if(idx>=0){
          const uid = list[idx].uid || list[idx].UID || null;
          list[idx].title = document.getElementById('mTitle').value.trim();
          list[idx].details = document.getElementById('mDetails').value.trim();
          list[idx].date = document.getElementById('mDate').value;
          list[idx].synced = false;
          saveLocal(SECTIONS.memo.key, list);
          renderList('memo');
          if(uid){
            const payloadObj = { 'Timestamp':'', 'Title': list[idx].title || '', 'Details': list[idx].details || '', 'Date': list[idx].date || '', 'UID': uid };
            const rowArr = buildRowForSheet('Memo', payloadObj);
            callServerUpdateUID('Memo', uid, rowArr).then(()=>{ list[idx].synced = true; saveLocal(SECTIONS.memo.key, list); syncFromSheet().catch(()=>{}); }).catch(()=>{});
          }
          clearForm('memo'); editState.memo=null;
        }
      } else { addEntry('memo'); }
    });
    document.getElementById('mResetBtn').addEventListener('click', ()=> clearForm('memo'));

    document.getElementById('tAddBtn').addEventListener('click', ()=> {
      const short='tr';
      if(editState.tr){
        let list = loadLocal(SECTIONS.tr.key);
        const idx = list.findIndex(x=>x.id === editState.tr.id);
        if(idx>=0){
          const uid = list[idx].uid || list[idx].UID || null;
          list[idx].subject = document.getElementById('tSubject').value.trim();
          list[idx].details = document.getElementById('tDetails').value.trim();
          list[idx].date = document.getElementById('tDate').value;
          list[idx].synced = false;
          saveLocal(SECTIONS.tr.key, list);
          renderList('tr');
          if(uid){
            const payloadObj = { 'Timestamp':'', 'Subject': list[idx].subject || '', 'Details': list[idx].details || '', 'Date': list[idx].date || '', 'UID': uid };
            const rowArr = buildRowForSheet('Training', payloadObj);
            callServerUpdateUID('Training', uid, rowArr).then(()=>{ list[idx].synced = true; saveLocal(SECTIONS.tr.key, list); syncFromSheet().catch(()=>{}); }).catch(()=>{});
          }
          clearForm('tr'); editState.tr=null;
        }
      } else { addEntry('tr'); }
    });
    document.getElementById('tResetBtn').addEventListener('click', ()=> clearForm('tr'));

    document.getElementById('pAddBtn').addEventListener('click', ()=> {
      const short='pni';
      if(editState.pni){
        let list = loadLocal(SECTIONS.pni.key);
        const idx = list.findIndex(x=>x.id === editState.pni.id);
        if(idx>=0){
          const uid = list[idx].uid || list[idx].UID || null;
          list[idx].subject = document.getElementById('pSubject').value.trim();
          list[idx].details = document.getElementById('pDetails').value.trim();
          list[idx].date = document.getElementById('pDate').value;
          list[idx].synced = false;
          saveLocal(SECTIONS.pni.key, list);
          renderList('pni');
          if(uid){
            const payloadObj = { 'Timestamp':'', 'Subject': list[idx].subject || '', 'Details': list[idx].details || '', 'Date': list[idx].date || '', 'UID': uid };
            const rowArr = buildRowForSheet('Pni', payloadObj);
            callServerUpdateUID('Pni', uid, rowArr).then(()=>{ list[idx].synced = true; saveLocal(SECTIONS.pni.key, list); syncFromSheet().catch(()=>{}); }).catch(()=>{});
          }
          clearForm('pni'); editState.pni=null;
        }
      } else { addEntry('pni'); }
    });
    document.getElementById('pResetBtn').addEventListener('click', ()=> clearForm('pni'));

    // Chat send
    document.getElementById('chatSendBtn').addEventListener('click', sendChat);
    // login
    document.getElementById('loginBtn').addEventListener('click', doLogin);
    document.getElementById('loginCancel').addEventListener('click', ()=> { document.getElementById('loginOverlay').style.display='none'; });
    document.getElementById('logoutBtn').addEventListener('click', doLogout);

    document.getElementById('chatBellBtn').addEventListener('click', ()=> {
      const on = localStorage.getItem('chatBell') === '1';
      if(on){ localStorage.setItem('chatBell','0'); document.getElementById('chatBellIcon').className='fa-solid fa-bell-slash'; }
      else { localStorage.setItem('chatBell','1'); document.getElementById('chatBellIcon').className='fa-solid fa-bell'; }
    });
  }

  /* ---------- Chatboard ---------- */
  async function loadChat(){
    // Use server data as authority; dedupe by UID
    const data = await callServerGet('ChatBoard');
    if(!Array.isArray(data)) return;
    const seen = new Set();
    // merge server rows (they are in order of sheet)
    const rows = data.map(r => ({ name: r['Name'] || r['name'] || '', message: r['Message'] || r['message'] || '', date: r['Date'] || r['date'] || r['Timestamp'] || '', uid: r['UID'] || r['Uid'] || r['uid'] || '' }));
    const el = document.getElementById('chatLog');
    // detect new messages for bell
    const localSeen = JSON.parse(localStorage.getItem('chat_seen_uids') || "[]");
    const newUIDs = [];
    // render reversed (oldest first)
    const html = rows.reverse().map(row => {
      if(row.uid && !localSeen.includes(row.uid)) newUIDs.push(row.uid);
      return `<div style="margin-bottom:8px"><strong>${escapeHtml(row.name)}</strong><div>${escapeHtml(row.message)}</div><small class="small-note">${fmtDate(row.date)}</small></div>`;
    }).join('');
    el.innerHTML = html;
    el.scrollTop = el.scrollHeight;
    if(newUIDs.length > 0 && localStorage.getItem('chatBell') === '1') playBell();
    // mark seen
    const combined = Array.from(new Set(localSeen.concat(rows.map(r=>r.uid).filter(Boolean))));
    localStorage.setItem('chat_seen_uids', JSON.stringify(combined));
  }

  function playBell(){
    try{
      const audio = new Audio('data:audio/mp3;base64,//uQx...'); // small placeholder silent base64 (browser won't block). You may replace with real file URL.
      // fallback beep via WebAudio
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='sine'; o.frequency.value=880;
      o.connect(g); g.connect(ctx.destination);
      o.start(0); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.3);
      setTimeout(()=>{ o.stop(); }, 350);
    }catch(e){ console.warn('bell err', e); }
  }

  function sendChat(){
    const name = document.getElementById('chatName').value.trim() || 'Anonymous';
    const msg = document.getElementById('chatMsg').value.trim();
    if(!msg) return alert('Please enter a message');
    const key = SECTIONS.chat.key;
    const local = loadLocal(key);
    const uid = makeUID();
    local.push({ id: Date.now(), name, message: msg, date: new Date().toISOString(), uid, synced:false });
    saveLocal(key, local);
    // send to server
    const rowArr = buildRowForSheet('ChatBoard', { Timestamp:'', Name: name, Message: msg, Date: new Date().toISOString(), UID: uid });
    callServerAppend('ChatBoard', rowArr).then(()=> {
      const localAfter = loadLocal(key);
      const idx = localAfter.findIndex(x=>x.uid === uid);
      if(idx >= 0){ localAfter[idx].synced = true; saveLocal(key, localAfter); }
      document.getElementById('chatMsg').value='';
      loadChat().catch(()=>{});
    }).catch(err=>{
      console.warn('chat append failed', err);
      document.getElementById('chatMsg').value='';
      loadChat().catch(()=>{});
    });
  }

  /* ---------- Sync from server (authoritative by UID) ---------- */
  async function syncFromSheet(){
    // get all main tabs at once (faster)
    const tabs = ['Vessel_Join','Arrivals','Updates','Memo','Training','Pni','ChatBoard'];
    const dataObj = await callServerFetchAll(tabs.join(','));
    const now = new Date();
    const lastSyncEl = document.getElementById('lastSync');
    if(lastSyncEl) lastSyncEl.innerText = now.toLocaleString();

    // For each tab, convert server rows -> local arrays keyed by UID
    for(const tab of tabs){
      const rows = dataObj[tab] || [];
      // convert to our local item shape and preserve UID
      const mapped = rows.map(r => {
        const uid = r['UID'] || r['Uid'] || r['uid'] || '';
        if(tab === 'Vessel_Join'){
          return { uid: uid, vessel: r['Vessel']||'', port: r['Port']||'', noCrew: r['No. of Crew']||r['No of Crew']||'', rank: r['Rank']||'', date: r['Date']||r['Timestamp']||'', flight: r['Flight']||'', synced:true, id: Date.now() + Math.floor(Math.random()*100000) };
        }
        if(tab === 'Arrivals'){
          return { uid: uid, vessel: r['Vessel']||'', port: r['Port']||'', noCrew: r['No. of Crew']||r['No of Crew']||'', rank: r['Rank']||'', date: r['Date']||r['Timestamp']||'', flight: r['Flight']||'', synced:true, id: Date.now() + Math.floor(Math.random()*100000) };
        }
        if(tab === 'Updates'){
          return { uid: uid, title: r['Title']||'', details: r['Details']||'', date: r['Date']||r['Timestamp']||'', synced:true, id: Date.now() + Math.floor(Math.random()*100000) };
        }
        if(tab === 'Memo'){
          return { uid: uid, title: r['Title']||'', details: r['Details']||'', date: r['Date']||r['Timestamp']||'', synced:true, id: Date.now() + Math.floor(Math.random()*100000) };
        }
        if(tab === 'Training'){
          return { uid: uid, subject: r['Subject']||'', details: r['Details']||'', date: r['Date']||r['Timestamp']||'', synced:true, id: Date.now() + Math.floor(Math.random()*100000) };
        }
        if(tab === 'Pni'){
          return { uid: uid, subject: r['Subject']||'', details: r['Details']||'', date: r['Date']||r['Timestamp']||'', synced:true, id: Date.now() + Math.floor(Math.random()*100000) };
        }
        if(tab === 'ChatBoard'){
          // handled separately
          return null;
        }
        return null;
      }).filter(Boolean);

      // Save authoritative mapped list into localStorage key
      if(tab === 'Vessel_Join') { saveLocal(SECTIONS.vj.key, mapped); renderList('vj'); }
      if(tab === 'Arrivals')    { saveLocal(SECTIONS.ac.key, mapped); renderList('ac'); }
      if(tab === 'Updates')     { saveLocal(SECTIONS.du.key, mapped); renderList('du'); }
      if(tab === 'Memo')        { saveLocal(SECTIONS.memo.key, mapped); renderList('memo'); }
      if(tab === 'Training')    { saveLocal(SECTIONS.tr.key, mapped); renderList('tr'); }
      if(tab === 'Pni')         { saveLocal(SECTIONS.pni.key, mapped); renderList('pni'); }
      if(tab === 'ChatBoard')   { /* handled below by loadChat() */ }
    }

    // load chat separately so we can do bell and seen tracking
    await loadChat();
  }

  /* ---------- Retry unsynced local appends (use UID) ---------- */
  async function retryLocalAppends(){
    const listToTry = ['vj','ac','du','memo','tr','pni','chat'];
    for(const short of listToTry){
      const meta = SECTIONS[short];
      let arr = loadLocal(meta.key);
      // find items that are not synced or don't have UID on server
      for(let i=0; i<arr.length; i++){
        const item = arr[i];
        if(!item) continue;
        // if item has uid and synced=false -> try update
        if(item.uid && !item.synced){
          try {
            // build row and call update_uid (if server already has uid)
            const row = buildRowForSheet(meta.sheet, mapLocalToPayload(meta.sheet, item));
            await callServerUpdateUID(meta.sheet, item.uid, row);
            item.synced = true;
            saveLocal(meta.key, arr);
          } catch(e){
            // if update failed attempt append (maybe uid missing server-side)
            try {
              const row = buildRowForSheet(meta.sheet, mapLocalToPayload(meta.sheet, item));
              await callServerAppend(meta.sheet, row);
              item.synced = true;
              saveLocal(meta.key, arr);
            } catch(err){}
          }
        }
        // if item has no uid and not synced -> append
        if(!item.uid && !item.synced){
          try {
            item.uid = makeUID();
            const row = buildRowForSheet(meta.sheet, mapLocalToPayload(meta.sheet, item));
            await callServerAppend(meta.sheet, row);
            item.synced = true;
            saveLocal(meta.key, arr);
          } catch(err){}
        }
      }
    }
    await syncFromSheet();
  }

  function mapLocalToPayload(sheetName, item){
    if(sheetName === 'Vessel_Join' || sheetName === 'Arrivals'){
      return { Timestamp:'', Vessel: item.vessel||'', Port: item.port||'', 'No. of Crew': item.noCrew||'', Rank: item.rank||'', Date: item.date||'', Flight: item.flight||'', UID: item.uid||'' };
    }
    if(sheetName === 'Updates' || sheetName === 'Memo'){
      return { Timestamp:'', Title: item.title||'', Details: item.details||'', Date: item.date||'', UID: item.uid||'' };
    }
    if(sheetName === 'Training' || sheetName === 'Pni'){
      return { Timestamp:'', Subject: item.subject||'', Details: item.details||'', Date: item.date||'', UID: item.uid||'' };
    }
    if(sheetName === 'ChatBoard'){
      return { Timestamp:'', Name: item.name||'', Message: item.message||'', Date: item.date||'', UID: item.uid||'' };
    }
    return item;
  }

  /* ---------- PDF export helpers ---------- */
  function printSectionPDF(sectionId, filename, all=false){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:'landscape'});
    doc.setFontSize(12);
    // Title page
    doc.text('SeaCrew Monthly Report', 14, 16);
    doc.setFontSize(10);
    doc.text('Generated: ' + new Date().toLocaleString(), 14, 24);

    if(all){
      // combine Archive_ sheets + current
      // For simplicity, we will export localStorage authoritative copies + note that server archive also exists
      // Vessel Join
      generateSectionPDF(doc, "Vessel Crew Joining", loadLocal(SECTIONS.vj.key), ["Vessel","Port","No. Crew","Rank","Date","Flight"], (r)=>[ r.vessel, r.port, r.noCrew, r.rank, fmtDate(r.date), r.flight || "" ]);
      // Arrivals
      generateSectionPDF(doc, "Arriving Crew", loadLocal(SECTIONS.ac.key), ["Vessel","Port","No. Crew","Rank","Arrival","Flight"], (r)=>[ r.vessel, r.port, r.noCrew, r.rank, fmtDate(r.date), r.flight || "" ]);
      // Updates
      generateSectionPDF(doc, "Daily Updates", loadLocal(SECTIONS.du.key), ["Title","Details","Date"], (r)=>[ r.title, r.details, fmtDate(r.date) ]);
      // Memo
      generateSectionPDF(doc, "Memo", loadLocal(SECTIONS.memo.key), ["Title","Details","Date"], (r)=>[ r.title, r.details, fmtDate(r.date) ]);
      // Training
      generateSectionPDF(doc, "Training", loadLocal(SECTIONS.tr.key), ["Subject","Details","Date"], (r)=>[ r.subject, r.details, fmtDate(r.date) ]);
      // P&I
      generateSectionPDF(doc, "P&I / Events", loadLocal(SECTIONS.pni.key), ["Subject","Details","Date"], (r)=>[ r.subject, r.details, fmtDate(r.date) ]);

      // signature block
      doc.addPage('landscape');
      doc.setFontSize(12);
      doc.text("Prepared By:", 14, 30);
      doc.setFontSize(14);
      doc.text("__________________________________", 14, 50);
      doc.text("General Manager", 14, 58);

      doc.save(filename + ".pdf");
      return;
    }

    // single-section export
    const short = mapSectionIdToShort(sectionId);
    if(!short) { alert('Unknown section'); return; }
    const list = loadLocal(SECTIONS[short].key) || [];
    if(list.length === 0){ alert('No entries to print'); return; }

    let headers=[], rows=[];
    if(short === 'vj'){ headers=["Vessel","Port","No. Crew","Rank","Date","Flight"]; rows = list.map(r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']); }
    if(short === 'ac'){ headers=["Vessel","Port","No. Crew","Rank","Arrival","Flight"]; rows = list.map(r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']); }
    if(short === 'du'){ headers=["Title","Details","Date"]; rows = list.map(r=>[r.title,r.details,fmtDate(r.date)]); }
    if(short === 'memo'){ headers=["Title","Details","Date"]; rows = list.map(r=>[r.title,r.details,fmtDate(r.date)]); }
    if(short === 'tr'){ headers=["Subject","Details","Date"]; rows = list.map(r=>[r.subject,r.details,fmtDate(r.date)]); }
    if(short === 'pni'){ headers=["Subject","Details","Date"]; rows = list.map(r=>[r.subject,r.details,fmtDate(r.date)]); }

    doc.autoTable({
      head: [headers],
      body: rows,
      startY: 28,
      styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak' },
      headStyles: { fillColor: [0, 51, 102], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [240, 240, 240] }
    });
    doc.save(filename + ".pdf");
  }

  function generateSectionPDF(doc, sectionTitle, list, headers, rowMapper){
    if(!list || list.length === 0) return;
    doc.addPage('landscape');
    doc.setFontSize(12);
    doc.text(sectionTitle, 14, 18);
    const rows = list.map(rowMapper);
    doc.autoTable({
      head: [headers],
      body: rows,
      startY: 26,
      styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
      headStyles: { fillColor: [0, 51, 102], textColor: 255, fontStyle: 'bold' },
      alternateRowStyles: { fillColor: [230, 230, 230] }
    });
  }

  /* ---------- Login / Auth ---------- */
  function showLogin(){
    document.getElementById('loginOverlay').style.display = 'flex';
  }
  function hideLogin(){ document.getElementById('loginOverlay').style.display = 'none'; }

  async function doLogin(){
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    if(!u || !p){ document.getElementById('loginError').innerText = 'Enter credentials'; return; }
    document.getElementById('loginError').innerText = 'Signing in...';
    const res = await callServerAuth(u,p);
    if(res && res.success){
      localStorage.setItem('seacrew_user', JSON.stringify({ username: u, role: res.role || 'user' }));
      document.getElementById('loginError').innerText = '';
      hideLogin();
      initAfterAuth();
    } else {
      document.getElementById('loginError').innerText = res && res.message ? res.message : 'Invalid credentials';
    }
  }

  function doLogout(){
    if(confirm('Logout?')){ localStorage.removeItem('seacrew_user'); showLogin(); }
  }

  function initAfterAuth(){
    // show dashboard and start syncing
    syncFromSheet().catch(()=>{});
    retryLocalAppends().catch(()=>{});
    setInterval(()=>{ syncFromSheet().catch(()=>{}); retryLocalAppends().catch(()=>{}); }, 15000);
  }

  /* ---------- Sticky ---------- */
  function saveSticky(){
    const val = document.getElementById('stickyNote').value || '';
    localStorage.setItem('stickyNote', val);
    alert('Saved locally');
  }

  /* ---------- Init ---------- */
  function init(){
    wireUpButtons();
    // default bell on
    if(!localStorage.getItem('chatBell')) localStorage.setItem('chatBell','1');

    // populate sticky
    const saved = localStorage.getItem('stickyNote'); if(saved) document.getElementById('stickyNote').value = saved;

    // render any existing local data
    Object.keys(SECTIONS).forEach(k=>{
      if(k==='chat') return;
      renderList(k);
    });

    // show login if no session
    const session = localStorage.getItem('seacrew_user');
    if(!session){
      showLogin();
    } else {
      hideLogin();
      initAfterAuth();
    }
  }

  window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
