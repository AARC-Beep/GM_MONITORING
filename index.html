<!-- PART 1: HEAD + CSS -->
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SeaCrew Dashboard — Daily Routine Log</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- jsPDF + AutoTable (for PDF export) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
.sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
.sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
.sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
.sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
.sidebar a.active { background:#072033; color:#fff; }
.content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
.card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
.small-note { font-size:0.9rem; color:#666; }
.preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
.entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
.entry-meta { color:#444; font-size:0.95rem; }
.form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.form-row .form-control { min-width:140px; }
.entry-actions button { margin-left:6px; }
.fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }

/* layout for list rows */
.row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
.row-entry .left { flex:1; }
.row-entry .right { display:flex; gap:8px; align-items:center; }

/* Chatboard */
.chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
.chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
.chat-inputs { display:flex; gap:8px; align-items:center; }

/* responsive */
@media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
@media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }

/* some small helpers */
.btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
</style>
<!-- PART 2: BODY / LAYOUT -->
<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>
  <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')"> <i class="fa-solid fa-circle-question"></i> Help / User Guide</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <!-- External links requested -->
  <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
  <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
  <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
  <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
  <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
  <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 style="margin:0">SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Apps Script web app: <strong>DAILY ROUTINE LOG</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
      <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
    </div>
  </div>

  <!-- DASHBOARD (previews + chatboard) -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <!-- Previews columns -->
      <div class="col-md-8">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h5 style="margin:0">Quick Overview</h5>
            <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card-slim">
                <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                <div class="preview-table" id="vesselPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                <div class="preview-table" id="arrivalsPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                <div class="preview-table" id="updatesPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                <div class="preview-table" id="memoPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                <div class="preview-table" id="trainingPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                <div class="preview-table" id="pniPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Chatboard / Sticky -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>ChatBoard (public view)</h6>
          <div class="chatboard">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
              <input id="chatMsg" class="form-control" placeholder="Message" />
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
            <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
          </div>
        </div>

        <div class="card-slim mt-3">
          <h6>Sticky / Quick Note</h6>
          <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
            <button class="btn btn-primary" onclick="saveSticky()">Save</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ---------- Sections: Vessel Join / Arrivals / Updates / Memo / Training / PNI ---------- -->
  <!-- Vessel Join -->
 <section id="vesselJoin" class="section" style="display:none">

  <!-- header buttons -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4>Vessel Crew Joining</h4>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
      <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
    </div>
  </div>

  <div class="card-slim mb-3">
    <div class="form-row">
      <input class="form-control" placeholder="Vessel" id="vjVessel">
      <input class="form-control" placeholder="Port" id="vjPort">
      <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
      <input class="form-control" placeholder="Rank" id="vjRank">
      <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
      <input class="form-control" placeholder="Flight" id="vjFlight">

      <button class="btn btn-success" id="vjAddBtn">Add</button>
      <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
    </div>
  </div>

  <div id="vj_list" class="card-slim"></div>
</section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    
    <div id="t_list" class="card-slim"></div>
   </section>

 <!-- PnI -->
<section id="pni" class="section" style="display:none">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4>P&amp;I / Events</h4>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
      <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
    </div>
  </div>

  <div id="p_list"></div>
</section>

 <!-- HELP / USER GUIDE -->
<section id="helpSection" class="section" style="display:none">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4>User Guide / Help</h4>
    <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('helpSection','User_Guide')">
      Export PDF
    </button>
  </div>

  <div class="card-slim" style="font-size:14px; line-height:1.6; padding:15px;">
    <h5>SeaCrew Dashboard — User Guide</h5>
    <p>Welcome to the SeaCrew Monitoring System. This guide explains how to operate every module.</p>

    <h6>1. Vessel Joining</h6>
    <p>Use this section to record outgoing crew details…</p>

    <h6>2. Arriving Crew</h6>
    <p>Records incoming crew data…</p>

    <h6>3. Daily Updates</h6>
    <p>For general internal updates…</p>

    <h6>4. Memo</h6>
    <p>Upload and share memos…</p>

    <h6>5. Training</h6>
    <p>Record training activity…</p>

    <h6>6. P&amp;I Events</h6>
    <p>Incident or event reporting…</p>

    <h6>7. Chatboard</h6>
    <p>All employees can post messages…</p>

    <hr>
    <p class="small-note">For support, contact GM AARC.</p>
  </div>
</section>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="pSubject">
        <input class="form-control" placeholder="Details" id="pDetails">
        <input class="form-control" type="date" id="pDate">
        <button class="btn btn-success" id="pAddBtn">Add</button>
        <button class="btn btn-secondary" id="pResetBtn">Reset</button>
      </div>
    </div>
    <div id="p_list" class="card-slim"></div>
  </section>

  <div class="fixed-bottom-left">© 2025 THRI/PTSC SeaCrew Dashboard</div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
/* ============================================
 PART 3 — RENDER LIST / EDIT / DELETE / PREVIEW
 For Vessel Join, Arrivals, Updates, Memo, Training, PNI
 ============================================ */

/* Section mapping */
const SECTIONS = {
  vj: { key:'vesselJoin', sheet:'Vessel_Join' },
  ac: { key:'arrivingCrew', sheet:'Arrivals' },
  du: { key:'dailyUpdates', sheet:'Updates' },
  memo:{ key:'memo', sheet:'Memo' },
  tr:  { key:'training', sheet:'Training' },
  pni: { key:'pni', sheet:'Pni' }
};

/* Load local */
function loadLocal(key){
  try{
    return JSON.parse(localStorage.getItem(key)) || [];
  }catch(e){ return []; }
}

/* Save local */
function saveLocal(key, arr){
  localStorage.setItem(key, JSON.stringify(arr));
}

/* Escape HTML */
function escapeHtml(txt){
  if(!txt) return "";
  return txt.replace(/[&<>"]/g, c =>
    ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;" }[c])
  );
}

/* Format date */
function fmtDate(d){
  if(!d) return '';
  return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
}

/* ============================================
    RENDER LIST
============================================ */
function renderList(sectionShort){
  const meta = SECTIONS[sectionShort];
  const key  = meta.key;

  // Filter out corrupted
  const list = loadLocal(key).filter(ep =>
    ep &&
    (ep.vessel || ep.title || ep.subject || ep.details || ep.port)
  );

  const idMap = {
    vj:'vj_list',
    ac:'ac_list',
    du:'du_list',
    memo:'m_list',
    tr:'t_list',
    pni:'p_list'
  };

  const container = document.getElementById(idMap[sectionShort]);
  if(!container) return;
  container.innerHTML = "";

  list.forEach(ep => {
    const row = document.createElement('div');
    row.className = "row-entry";

    const left = document.createElement('div');
    left.className = "left";

    /* --- Render per section --- */
    if(sectionShort === 'vj'){
      left.innerHTML =
        `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div>
         <div class="entry-meta">${escapeHtml(ep.port)} · ${escapeHtml(ep.noCrew)} crew · ${escapeHtml(ep.rank)}</div>
         <div class="small-note">Date: ${fmtDate(ep.date)} ${ep.flight ? "· "+escapeHtml(ep.flight):""} ${ep.synced?"· (synced)":""}</div>`;
    }

    if(sectionShort === 'ac'){
      left.innerHTML =
        `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div>
         <div class="entry-meta">${escapeHtml(ep.port)} · ${escapeHtml(ep.noCrew)} crew · ${escapeHtml(ep.rank)}</div>
         <div class="small-note">${fmtDate(ep.date)} ${ep.flight ? "· "+escapeHtml(ep.flight):""} ${ep.synced?"· (synced)":""}</div>`;
    }

    if(sectionShort === 'du' || sectionShort === 'memo'){
      left.innerHTML =
        `<div style="font-weight:700">${escapeHtml(ep.title)}</div>
         <div class="small-note">${escapeHtml(ep.details)}</div>
         <div class="small-note">${fmtDate(ep.date)} ${ep.synced?"· (synced)":""}</div>`;
    }

    if(sectionShort === 'tr' || sectionShort === 'pni'){
      left.innerHTML =
        `<div style="font-weight:700">${escapeHtml(ep.subject)}</div>
         <div class="small-note">${escapeHtml(ep.details)}</div>
         <div class="small-note">${fmtDate(ep.date)} ${ep.synced?"· (synced)":""}</div>`;
    }

    const right = document.createElement('div');
    right.className = "right";

    /* Edit button */
    const editBtn = document.createElement('button');
    editBtn.className = "btn btn-sm btn-outline-primary";
    editBtn.innerHTML = `<i class="fa-solid fa-pen-to-square"></i>`;
    editBtn.onclick = () => startEdit(sectionShort, ep.uid);

    /* Delete button */
    const delBtn = document.createElement('button');
    delBtn.className = "btn btn-sm btn-outline-danger";
    delBtn.innerHTML = `<i class="fa-solid fa-trash"></i>`;
    delBtn.onclick = () => deleteEntry(sectionShort, ep.uid);

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    row.appendChild(left);
    row.appendChild(right);

    container.appendChild(row);
  });

  updateCounts();
}

/* ============================================
  SMALL PREVIEW (last 3)
============================================ */
function updateSmallPreview(sectionShort){
  // optional — can leave blank if not used
}

/* ============================================
   COUNT INDICATORS
============================================ */
function updateCounts(){
  document.getElementById('countVessel').innerText   = loadLocal("vesselJoin").length;
  document.getElementById('countArrivals').innerText = loadLocal("arrivingCrew").length;
  document.getElementById('countUpdates').innerText  = loadLocal("dailyUpdates").length;
  document.getElementById('countMemo').innerText     = loadLocal("memo").length;
  document.getElementById('countTraining').innerText = loadLocal("training").length;
  document.getElementById('countPNI').innerText      = loadLocal("pni").length;
}

/* ============================================
  DELETE ENTRY
============================================ */
function deleteEntry(sectionShort, uid){
  const key = SECTIONS[sectionShort].key;
  let list = loadLocal(key);
  const idx = list.findIndex(x => x.uid === uid);
  if(idx === -1) return;

  if(!confirm("Delete this entry?")) return;

  list.splice(idx,1);
  saveLocal(key, list);
  renderList(sectionShort);

  // OPTIONAL: call delete_uid backend
}

/* ============================================
  START EDIT
============================================ */
function startEdit(sectionShort, uid){
  const key = SECTIONS[sectionShort].key;
  let list = loadLocal(key);
  const item = list.find(x => x.uid === uid);
  if(!item) return;

  editState[sectionShort] = { uid: item.uid };

  if(sectionShort==='vj'){
    vjVessel.value = item.vessel;
    vjPort.value   = item.port;
    vjNo.value     = item.noCrew;
    vjRank.value   = item.rank;
    vjDate.value   = item.date;
    vjFlight.value = item.flight;
  }

  if(sectionShort==='ac'){
    acVessel.value = item.vessel;
    acPort.value   = item.port;
    acNo.value     = item.noCrew;
    acRank.value   = item.rank;
    acDate.value   = item.date;
    acFlight.value = item.flight;
  }

  if(sectionShort==='du' || sectionShort==='memo'){
    duTitle.value   = item.title;
    duDetails.value = item.details;
    duDate.value    = item.date;
  }

  if(sectionShort==='tr' || sectionShort==='pni'){
    tSubject.value = item.subject;
    tDetails.value = item.details;
    tDate.value    = item.date;
  }

  // Change Add → Update
  const mapBtn = {
    vj: vjAddBtn, ac: acAddBtn, du: duAddBtn,
    memo: mAddBtn, tr: tAddBtn, pni: pAddBtn
  };

  const btn = mapBtn[sectionShort];
  btn.innerText = "Update";
  btn.classList.remove("btn-success");
  btn.classList.add("btn-warning");

  scrollTo(0,0);
}

/* ============================================
  CLEAR FORM
============================================ */
function clearForm(sectionShort){
  if(sectionShort==='vj'){
    ['vjVessel','vjPort','vjNo','vjRank','vjDate','vjFlight']
      .forEach(id => document.getElementById(id).value = "");
  }
  if(sectionShort==='ac'){
    ['acVessel','acPort','acNo','acRank','acDate','acFlight']
      .forEach(id => document.getElementById(id).value = "");
  }
  if(sectionShort==='du'){
    ['duTitle','duDetails','duDate']
      .forEach(id => document.getElementById(id).value = "");
  }
  if(sectionShort==='memo'){
    ['mTitle','mDetails','mDate']
      .forEach(id => document.getElementById(id).value = "");
  }
  if(sectionShort==='tr'){
    ['tSubject','tDetails','tDate']
      .forEach(id => document.getElementById(id).value = "");
  }
  if(sectionShort==='pni'){
    ['pSubject','pDetails','pDate']
      .forEach(id => document.getElementById(id).value = "");
  }

  // Reset button
  ['vjAddBtn','acAddBtn','duAddBtn','mAddBtn','tAddBtn','pAddBtn'].forEach(id=>{
    const b = document.getElementById(id);
    b.innerText = "Add";
    b.classList.remove("btn-warning");
    b.classList.add("btn-success");
  });

  editState[sectionShort] = null;
}
/* ============================================================
   PART 4 — ADD ENTRY / UPDATE ENTRY / SYNC ENGINE
============================================================ */

/* Generate UID */
function generateUID(){
  return "UID-" + Date.now() + "-" + Math.floor(Math.random()*999999);
}

/* Add new entry */
function addEntry(sectionShort){
  const meta = SECTIONS[sectionShort];
  const key  = meta.key;
  const sheet = meta.sheet;

  const ts = new Date().toISOString();
  const uid = generateUID();

  let obj = { timestamp: ts, uid: uid, synced: false };

  if(sectionShort==='vj'){
    obj.vessel = vjVessel.value.trim();
    obj.port   = vjPort.value.trim();
    obj.noCrew = vjNo.value.trim();
    obj.rank   = vjRank.value.trim();
    obj.date   = vjDate.value;
    obj.flight = vjFlight.value.trim();
  }

  if(sectionShort==='ac'){
    obj.vessel = acVessel.value.trim();
    obj.port   = acPort.value.trim();
    obj.noCrew = acNo.value.trim();
    obj.rank   = acRank.value.trim();
    obj.date   = acDate.value;
    obj.flight = acFlight.value.trim();
  }

  if(sectionShort==='du' || sectionShort==='memo'){
    obj.title   = duTitle.value.trim() || mTitle.value.trim();
    obj.details = duDetails.value.trim() || mDetails.value.trim();
    obj.date    = duDate.value || mDate.value;
  }

  if(sectionShort==='tr' || sectionShort==='pni'){
    obj.subject = tSubject.value.trim() || pSubject.value.trim();
    obj.details = tDetails.value.trim() || pDetails.value.trim();
    obj.date    = tDate.value || pDate.value;
  }

  // Save local
  let list = loadLocal(key);
  list.push(obj);
  saveLocal(key, list);

  // Render
  renderList(sectionShort);
  clearForm(sectionShort);

  // Try sync
  sendToServer_Append(sectionShort, obj);
}

/* Update entry */
function updateEntry(sectionShort, uid){
  const key = SECTIONS[sectionShort].key;
  let list = loadLocal(key);
  const idx = list.findIndex(x => x.uid === uid);
  if(idx === -1) return;

  let item = list[idx];
  item.synced = false; // force resync

  if(sectionShort==='vj'){
    item.vessel = vjVessel.value.trim();
    item.port   = vjPort.value.trim();
    item.noCrew = vjNo.value.trim();
    item.rank   = vjRank.value.trim();
    item.date   = vjDate.value;
    item.flight = vjFlight.value.trim();
  }

  if(sectionShort==='ac'){
    item.vessel = acVessel.value.trim();
    item.port   = acPort.value.trim();
    item.noCrew = acNo.value.trim();
    item.rank   = acRank.value.trim();
    item.date   = acDate.value;
    item.flight = acFlight.value.trim();
  }

  if(sectionShort==='du' || sectionShort==='memo'){
    item.title   = duTitle.value.trim() || mTitle.value.trim();
    item.details = duDetails.value.trim() || mDetails.value.trim();
    item.date    = duDate.value || mDate.value;
  }

  if(sectionShort==='tr' || sectionShort==='pni'){
    item.subject = tSubject.value.trim() || pSubject.value.trim();
    item.details = tDetails.value.trim() || pDetails.value.trim();
    item.date    = tDate.value || pDate.value;
  }

  saveLocal(key, list);
  renderList(sectionShort);
  clearForm(sectionShort);

  sendToServer_Update(sectionShort, item);
}

/* Send new entry to Google Sheet */
function sendToServer_Append(sectionShort, obj){
  const sheet = SECTIONS[sectionShort].sheet;

  const row = buildRowForSheet(sectionShort, obj);
  const url =
    GAS_URL +
    "?callback=callback" +
    "&action=append" +
    "&sheet=" + encodeURIComponent(sheet) +
    "&row=" + encodeURIComponent(JSON.stringify(row));

  jsonp(url)
    .then(() => markSynced(sectionShort, obj.uid))
    .catch(() => console.warn("Append failed, will retry later"));
}

/* Send UPDATE to Google Sheet */
function sendToServer_Update(sectionShort, obj){
  const sheet = SECTIONS[sectionShort].sheet;
  const row = buildRowForSheet(sectionShort, obj);

  const url =
    GAS_URL +
    "?callback=callback" +
    "&action=update_uid" +
    "&sheet=" + encodeURIComponent(sheet) +
    "&uid=" + encodeURIComponent(obj.uid) +
    "&row=" + encodeURIComponent(JSON.stringify(row));

  jsonp(url)
    .then(() => markSynced(sectionShort, obj.uid))
    .catch(() => console.warn("Update failed, will retry later"));
}

/* Build row based on sheet structure */
function buildRowForSheet(sectionShort, item){
  if(sectionShort==='vj' || sectionShort==='ac'){
    return [
      item.timestamp,
      item.vessel,
      item.port,
      item.noCrew,
      item.rank,
      item.date,
      item.flight,
      item.uid
    ];
  }

  if(sectionShort==='du' || sectionShort==='memo'){
    return [
      item.timestamp,
      item.title,
      item.details,
      item.date,
      item.uid
    ];
  }

  if(sectionShort==='tr' || sectionShort==='pni'){
    return [
      item.timestamp,
      item.subject,
      item.details,
      item.date,
      item.uid
    ];
  }

  return [];
}

/* Mark entry as synced */
function markSynced(sectionShort, uid){
  const key = SECTIONS[sectionShort].key;
  let list = loadLocal(key);
  const idx = list.findIndex(x => x.uid === uid);
  if(idx === -1) return;

  list[idx].synced = true;
  saveLocal(key, list);
  renderList(sectionShort);
}

/* Retry unsynced every 10 seconds */
setInterval(() => {
  Object.keys(SECTIONS).forEach(short => {
    const key = SECTIONS[short].key;
    let list = loadLocal(key);

    list
      .filter(x => x.synced !== true)
      .forEach(x => {
        if(x.uid){
          // try update OR append depending if exists in sheet
          sendToServer_Update(short, x);
        } else {
          sendToServer_Append(short, x);
        }
      });
  });
}, 10000);
/* ============================================================
   PART 5 — BUTTON WIRING + INITIALIZATION
============================================================ */

const editState = {
  vj:null, ac:null, du:null, memo:null, tr:null, pni:null
};

/* JSONP helper */
function jsonp(url){
  return new Promise((resolve, reject) => {
    const cb = "cb_" + Math.random().toString(36).substring(2);
    window[cb] = (data) => {
      delete window[cb];
      document.body.removeChild(script);
      if(data && data.success) resolve(data);
      else reject(data);
    };
    const script = document.createElement("script");
    script.src = url.replace("callback=callback", "callback="+cb);
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

/* Button wiring */
function wireUpButtons(){

  /* VESSEL JOIN */
  vjAddBtn.addEventListener("click", ()=>{
    if(editState.vj) updateEntry("vj", editState.vj.uid);
    else addEntry("vj");
  });
  vjResetBtn.addEventListener("click", ()=> clearForm("vj"));

  /* ARRIVALS */
  acAddBtn.addEventListener("click", ()=>{
    if(editState.ac) updateEntry("ac", editState.ac.uid);
    else addEntry("ac");
  });
  acResetBtn.addEventListener("click", ()=> clearForm("ac"));

  /* UPDATES */
  duAddBtn.addEventListener("click", ()=>{
    if(editState.du) updateEntry("du", editState.du.uid);
    else addEntry("du");
  });
  duResetBtn.addEventListener("click", ()=> clearForm("du"));

  /* MEMO */
  mAddBtn.addEventListener("click", ()=>{
    if(editState.memo) updateEntry("memo", editState.memo.uid);
    else addEntry("memo");
  });
  mResetBtn.addEventListener("click", ()=> clearForm("memo"));

  /* TRAINING */
  tAddBtn.addEventListener("click", ()=>{
    if(editState.tr) updateEntry("tr", editState.tr.uid);
    else addEntry("tr");
  });
  tResetBtn.addEventListener("click", ()=> clearForm("tr"));

  /* PNI */
  pAddBtn.addEventListener("click", ()=>{
    if(editState.pni) updateEntry("pni", editState.pni.uid);
    else addEntry("pni");
  });
  pResetBtn.addEventListener("click", ()=> clearForm("pni"));
}

/* On load */
document.addEventListener("DOMContentLoaded", ()=>{
  wireUpButtons();

  renderList("vj");
  renderList("ac");
  renderList("du");
  renderList("memo");
  renderList("tr");
  renderList("pni");

  updateCounts();
});
