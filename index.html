<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeaCrew Dashboard — Daily Routine Log</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- jsPDF + AutoTable (for PDF export) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
  :root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
  .sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
  .sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
  .sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
  .sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
  .sidebar a.active { background:#072033; color:#fff; }
  .content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
  .card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
  .small-note { font-size:0.9rem; color:#666; }
  .preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
  .entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
  .entry-meta { color:#444; font-size:0.95rem; }
  .form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .form-row .form-control { min-width:140px; }
  .entry-actions button { margin-left:6px; }
  .fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }
  .row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
  .row-entry .left { flex:1; }
  .row-entry .right { display:flex; gap:8px; align-items:center; }
  .chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
  .chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
  .chat-inputs { display:flex; gap:8px; align-items:center; }
  @media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
  @media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }
  .btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
  .badge-synced { color: #0b6623; font-weight:600; margin-left:8px }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:3000">
  <div class="card p-4" style="width:420px;border-radius:12px">
    <div class="text-center mb-3">
      <h4 style="margin:0">TIWALA — SeaCrew Dashboard</h4>
      <small class="small-note">Sign in to continue</small>
    </div>

    <div class="mb-2">
      <label class="form-label">Username</label>
      <input id="loginUsername" class="form-control" />
    </div>
    <div class="mb-3">
      <label class="form-label">Password</label>
      <input id="loginPassword" type="password" class="form-control" />
    </div>

    <div class="d-flex justify-content-between align-items-center">
      <div><button class="btn btn-outline-secondary" id="loginResetBtn">Reset</button></div>
      <div>
        <button class="btn btn-primary" id="loginBtn">Sign in</button>
      </div>
    </div>
    <div class="mt-2 small-note">If you have no account, contact admin.</div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>
  <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')"><i class="fa-solid fa-circle-info"></i> Help / User Guide</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <!-- External links requested -->
  <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
  <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
  <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
  <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
  <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
  <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 style="margin:0">SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Apps Script web app: <strong>DAILY ROUTINE LOG</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
      <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
    </div>
  </div>

  <!-- DASHBOARD (previews + chatboard) -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <!-- Previews columns -->
      <div class="col-md-8">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h5 style="margin:0">Quick Overview</h5>
            <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card-slim">
                <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                <div class="preview-table" id="vesselPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                <div class="preview-table" id="arrivalsPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                <div class="preview-table" id="updatesPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                <div class="preview-table" id="memoPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                <div class="preview-table" id="trainingPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                <div class="preview-table" id="pniPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Chatboard / Sticky -->
      <div class="col-md-4">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h6 style="margin:0">ChatBoard (public view)</h6>
            <div><i id="chatBell" class="fa-solid fa-bell" style="color:#888"></i></div>
          </div>
          <div class="chatboard mt-2">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
              <input id="chatMsg" class="form-control" placeholder="Message" />
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
            <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
          </div>
        </div>

        <div class="card-slim mt-3">
          <h6>Sticky / Quick Note</h6>
          <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
            <button class="btn btn-primary" onclick="saveSticky()">Save</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ---------- Sections: Vessel Join / Arrivals / Updates / Memo / Training / PNI ---------- -->
  <!-- Vessel Join -->
  <section id="vesselJoin" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Vessel Crew Joining</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="vjVessel">
        <input class="form-control" placeholder="Port" id="vjPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
        <input class="form-control" placeholder="Rank" id="vjRank">
        <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
        <input class="form-control" placeholder="Flight" id="vjFlight">

        <button class="btn btn-success" id="vjAddBtn">Add</button>
        <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
      </div>
    </div>

    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    
    <div id="t_list" class="card-slim"></div>
   </section>

 <!-- PnI -->
<section id="pni" class="section" style="display:none">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4>P&amp;I / Events</h4>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
      <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
    </div>
  </div>

  <div class="card-slim mb-3">
    <div class="form-row">
      <input class="form-control" placeholder="Subject" id="pSubject">
      <input class="form-control" placeholder="Details" id="pDetails">
      <input class="form-control" type="date" id="pDate">
      <button class="btn btn-success" id="pAddBtn">Add</button>
      <button class="btn btn-secondary" id="pResetBtn">Reset</button>
    </div>
  </div>
  <div id="p_list" class="card-slim"></div>
</section>

  <!-- HELP / USER GUIDE -->
  <section id="helpSection" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>User Guide / Help</h4>
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('helpSection','User_Guide')">Export PDF</button>
    </div>

    <div class="card-slim" style="font-size:14px; line-height:1.5">
      <h5>SeaCrew Dashboard — Daily Routine Log</h5>
      <p>This guide explains how to use the dashboard: login, add/update/delete entries, chatboard and monthly report.</p>
      <ol>
        <li>Login with your Username / Password (stored in the Users sheet).</li>
        <li>Use the left sidebar to navigate sections.</li>
        <li>Only Admins can edit/archive entries; Users can add only (role enforced after login).</li>
        <li>Delete moves entries to Archive_&lt;SheetName&gt; so monthly reports still include deleted items.</li>
      </ol>
    </div>
  </section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================================================================
   PART 3 — FINAL JAVASCRIPT (LOGIN + CRUD + SYNC + CHATBOARD)
   Fully compatible with updated Apps Script backend (Nov 2025)
================================================================ */

/* ================================================================
   A. GLOBAL VARIABLES
================================================================ */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwhdSxp2SD3rsLMGkj7XbADruQffto46bPLkfM3lkgOI90-5qHGIFAbyTLfvXXgdgck/exec";   // ← replace with your Script URL
let CURRENT_USER = null;
let DB = {
  Vessel_Join: [],
  Arrivals: [],
  Updates: [],
  Memo: [],
  Training: [],
  Pni: [],
  ChatBoard: []
};

/* Utility: fetch wrapper */
async function api(action, params = {}) {
  const query = new URLSearchParams({ action, ...params }).toString();
  const url = `${WEB_APP_URL}?${query}&callback=cb`;

  return new Promise((resolve) => {
    window.cb = (resp) => resolve(resp);
    const s = document.createElement("script");
    s.src = url;
    document.body.appendChild(s);
  });
}

/* Generate UID */
function makeUID() {
  return "UID-" + Date.now() + "-" + Math.floor(Math.random() * 99999);
}

/* ================================================================
   B. LOGIN SYSTEM (FIXED)
================================================================ */
async function callServerAuth(username, password) {
  return await api("auth", { username, password });
}

function setupLogin() {
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const u = document.getElementById("loginUsername").value.trim();
    const p = document.getElementById("loginPassword").value.trim();

    if (!u || !p) {
      alert("Enter username and password");
      return;
    }

    const resp = await callServerAuth(u, p);

    if (resp && resp.success) {
      CURRENT_USER = {
        username: resp.username,
        role: resp.role
      };

      document.getElementById("loginScreen").style.display = "none";

      await syncFromSheet();
      renderAll();

    } else {
      alert(resp.message || "Invalid credentials");
    }
  });

  document.getElementById("loginResetBtn").addEventListener("click", () => {
    document.getElementById("loginUsername").value = "";
    document.getElementById("loginPassword").value = "";
  });
}

/* ================================================================
   C. SERVER COMMUNICATION
================================================================ */

/* Fetch full dataset */
async function syncFromSheet() {
  const resp = await api("fetchall", { sheets: "Vessel_Join,Arrivals,Updates,Memo,Training,Pni,ChatBoard" });
  if (resp.ok) {
    DB = resp.data;
  }
  document.getElementById("lastSync").innerText = new Date().toLocaleTimeString();
}

/* Append row */
async function appendRow(sheet, payload) {
  payload.UID = makeUID();
  return await api("append_uid", {
    sheet,
    payload: JSON.stringify(payload)
  });
}

/* Update row */
async function updateRow(sheet, payload) {
  return await api("update_uid", {
    sheet,
    payload: JSON.stringify(payload)
  });
}

/* Delete row → moves to Archive_<sheet> */
async function deleteRow(sheet, uid) {
  return await api("delete_uid", { sheet, uid });
}

/* ================================================================
   D. RENDERING + CRUD + CHATBOARD + BUTTONS
================================================================ */

function renderAll() {
  renderPreview("Vessel_Join", "vesselPreviewSmall", "countVessel");
  renderPreview("Arrivals", "arrivalsPreviewSmall", "countArrivals");
  renderPreview("Updates", "updatesPreviewSmall", "countUpdates");
  renderPreview("Memo", "memoPreviewSmall", "countMemo");
  renderPreview("Training", "trainingPreviewSmall", "countTraining");
  renderPreview("Pni", "pniPreviewSmall", "countPNI");

  renderSectionList("Vessel_Join", "vj_list");
  renderSectionList("Arrivals", "ac_list");
  renderSectionList("Updates", "du_list");
  renderSectionList("Memo", "m_list");
  renderSectionList("Training", "t_list");
  renderSectionList("Pni", "p_list");

  renderChatBoard();
}

/* Preview renderer */
function renderPreview(sheetName, divID, countID) {
  const div = document.getElementById(divID);
  const data = DB[sheetName] || [];

  document.getElementById(countID).innerText = data.length;

  let html = "<table class='table table-sm'><tbody>";
  data.slice(-5).forEach(r => {
    html += `<tr><td>${Object.values(r)[0] || ""}</td><td>${r.Date || ""}</td></tr>`;
  });
  html += "</tbody></table>";

  div.innerHTML = html;
}

/* Section List Rendering */
function renderSectionList(sheet, containerID) {
  const box = document.getElementById(containerID);
  const list = DB[sheet] || [];

  box.innerHTML = list.map(entry => `
    <div class="row-entry">
      <div class="left">${Object.values(entry).join(" — ")}</div>
      <div class="right">
        <button class="btn btn-sm btn-danger" onclick="handleDelete('${sheet}','${entry.UID}')">Delete</button>
      </div>
    </div>
  `).join("");
}

/* ChatBoard rendering */
function renderChatBoard() {
  const log = document.getElementById("chatLog");
  const msgs = DB.ChatBoard || [];

  log.innerHTML = msgs.map(m => `
    <div><strong>${m.Name}:</strong> ${m.Message} <small>(${m.Timestamp})</small></div>
  `).join("");
}

/* ChatBoard send */
async function sendChatMessage() {
  const name = document.getElementById("chatName").value.trim();
  const msg = document.getElementById("chatMsg").value.trim();

  if (!name || !msg) return;

  const payload = {
    Name: name,
    Message: msg,
    Timestamp: new Date().toLocaleString(),
    UID: makeUID()
  };

  await appendRow("ChatBoard", payload);
  await syncFromSheet();
  renderChatBoard();

  document.getElementById("chatMsg").value = "";
}

/* Delete handler */
async function handleDelete(sheet, uid) {
  if (!confirm("Move to archive?")) return;

  const resp = await deleteRow(sheet, uid);
  if (resp.ok) {
    await syncFromSheet();
    renderAll();
  } else {
    alert("Delete failed: " + resp.msg);
  }
}

/* Navigation */
function navTo(e, target) {
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  document.getElementById(target).style.display = "block";

  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  e.target.classList.add("active");
}

function navToElement(id) {
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
}

/* Sync button */
async function manualSync() {
  await syncFromSheet();
  renderAll();
}

/* Sticky note */
function saveSticky() {
  localStorage.setItem("stickyNote", document.getElementById("stickyNote").value);
}

/* Initialize */
function init() {
  setupLogin();
  document.getElementById("chatSendBtn").onclick = sendChatMessage;
}

document.addEventListener("DOMContentLoaded", init);

<!-- PART 4/4: SERVER HELPERS + SYNC (PASTE AFTER PART 3) -->
<script>
/* =========================
   Unified JSONP + Server helpers (matches AppsScript actions)
   ========================= */

async function callServerRaw(params = {}, timeout = 12000) {
  // params: object of key=>value, must include at least action
  // uses existing jsonpRequest helper defined earlier
  try {
    // if caller passed 'action' in different case, normalize to server expected ones where possible
    if (params.action) {
      const a = String(params.action).toLowerCase();
      if (a === 'get' || a === 'fetch') params.action = 'fetch';
      if (a === 'fetchall' || a === 'fetch_all' || a === 'fetchall') params.action = 'fetchAll';
      if (a === 'append' || a === 'append_uid') params.action = 'append_uid';
      if (a === 'update' || a === 'update_uid') params.action = 'update_uid';
      if (a === 'delete' || a === 'delete_uid') params.action = 'delete_uid';
      if (a === 'auth') params.action = 'auth';
    }
    const resp = await jsonpRequest(params, timeout);
    // server returns { ok: true/false, msg: "...", data: ... } in your Apps Script
    return resp || { ok:false, msg:'no response' };
  } catch (err) {
    console.warn('callServerRaw error', err);
    return { ok:false, msg: (err && err.message) ? err.message : String(err) };
  }
}

async function callServerFetchAll(sheetList) {
  // expects array of sheet names
  if (!Array.isArray(sheetList)) sheetList = (sheetList||'').split(',').map(s=>s.trim()).filter(Boolean);
  if (!sheetList.length) return {};
  const sheetsParam = sheetList.join(',');
  const resp = await callServerRaw({ action: 'fetchAll', sheets: sheetsParam }, 15000);
  if (!resp || !resp.ok) {
    // attempt fallback in case older server used different shape
    if (resp && resp.data) return resp.data;
    console.warn('fetchAll failed', resp);
    return {};
  }
  return resp.data || {};
}

async function callServerFetch(sheetName) {
  const resp = await callServerRaw({ action: 'fetch', sheet: sheetName }, 12000);
  if (!resp || !resp.ok) {
    if (Array.isArray(resp.data)) return resp.data;
    console.warn('fetch failed', resp);
    return [];
  }
  return resp.data || [];
}

async function callServerAppend(sheetName, payloadObj) {
  // payloadObj should be an object with header keys -> values (including UID)
  const resp = await callServerRaw({ action: 'append_uid', sheet: sheetName, payload: JSON.stringify(payloadObj) }, 12000);
  return resp;
}

async function callServerUpdate(sheetName, payloadObj) {
  // requires payloadObj.UID to be present
  const resp = await callServerRaw({ action: 'update_uid', sheet: sheetName, payload: JSON.stringify(payloadObj) }, 12000);
  return resp;
}

async function callServerDelete(sheetName, uid) {
  const resp = await callServerRaw({ action: 'delete_uid', sheet: sheetName, uid: uid }, 12000);
  return resp;
}

async function callServerAuth(username, password) {
  return await callServerRaw({ action: 'auth', username: username, password: password }, 10000);
}

/* =========================
   Robust sync: merge server canonical data with local unsynced entries
   ========================= */

async function syncFromServer() {
  const tabs = ['Vessel_Join','Arrivals','Updates','Memo','Training','Pni','ChatBoard'];

  // show last sync
  try { document.getElementById('lastSync').innerText = new Date().toLocaleString(); } catch(e){}

  // fetch everything from server
  const serverAll = await callServerFetchAll(tabs);

  // Helper to merge per sheet
  for (const sname of tabs) {
    const sectionShort = mapServerSheetToShort(sname);
    const localKey = sectionShort ? SECTIONS[sectionShort].key : null;
    if (!localKey) continue;

    const serverRows = (serverAll && serverAll[sname]) ? serverAll[sname] : [];
    // normalize server rows into objects with UID property
    const serverMapped = serverRows.map(r => {
      // r may be an object mapping headers to values (if server out worked)
      const uid = r['UID'] || r['Uid'] || r['uid'] || r['ID'] || null;
      return Object.assign({}, r, { UID: uid });
    });

    // Build uid set for easy lookup
    const serverUIDs = new Set(serverMapped.map(r=>r.UID).filter(Boolean));

    // Load local list (could be synced from previous runs)
    const localList = loadLocal(localKey) || [];

    // Partition local into synced and unsynced
    const unsyncedLocal = localList.filter(it => !it.synced || !it.uid);
    const syncedLocal = localList.filter(it => it.synced && it.uid && serverUIDs.has(it.uid));

    // For each unsynced local item:
    // - if it has a uid that exists on server, mark as synced and drop local copy (server will be canonical)
    // - if it has uid not on server: attempt to append to server
    for (const item of unsyncedLocal) {
      // ensure uid exists
      if (!item.uid) item.uid = makeUID();

      if (serverUIDs.has(item.uid)) {
        // server has it — treat server row as canonical; mark synced
        item.synced = true;
        // nothing to send
      } else {
        // try append to server (rebuild payload by sheet)
        try {
          const payloadObj = buildPayloadObjForSheet(sname, item);
          const resp = await callServerAppend(sname, payloadObj);
          if (resp && resp.ok) {
            item.synced = true;
            serverUIDs.add(item.uid);
            // Optionally push the appended row into serverMapped so it's included below
            serverMapped.push(Object.assign({}, payloadObj, { UID: item.uid }));
          } else {
            // leave unsynced to retry later
            console.warn('append attempt failed for', item, resp);
          }
        } catch (e) {
          console.warn('append error', e);
        }
      }
    }

    // Now choose canonical list to save locally:
    // prefer serverMapped (canonical), but keep local items that server doesn't have (should be very few)
    const merged = [];
    const addedUID = new Set();

    // Add server rows first (with normalized fields)
    for (const r of serverMapped) {
      const normalized = normalizeServerRowToLocal(sname, r);
      normalized.synced = true;
      normalized.uid = r.UID || r.uid || makeUID();
      normalized.uid && addedUID.add(normalized.uid);
      merged.push(normalized);
    }

    // Add any local items that server didn't have (and are unsynced and not duplicates)
    for (const l of localList) {
      if (l.uid && addedUID.has(l.uid)) continue;
      // keep local record (may be unsynced)
      merged.push(Object.assign({}, l, { uid: l.uid || l.uid, synced: !!l.synced }));
    }

    // Save merged back to localStorage using your existing key naming
    // Your code uses lower-case 'uid' property in local storage; ensure consistency
    const localToSave = merged.map(x => {
      // convert canonicalized fields to match earlier UI expectations (uid, vessel, port, etc)
      return convertCanonicalToLocal(sectionShort, x);
    });

    saveLocal(localKey, localToSave);
    // render lists (the renderList function uses the SECTIONS keys)
    try { renderList(sectionShort); } catch(e){ console.warn('renderList error', e); }
  }

  // finally reload chat properly
  try { loadChat(); } catch(e){ console.warn('loadChat error', e); }
}

/* =========================
   Helpers used by sync
   ========================= */

function mapServerSheetToShort(sheetName){
  // map exact sheet name to your local short code in SECTIONS
  if (sheetName === 'Vessel_Join') return 'vj';
  if (sheetName === 'Arrivals') return 'ac';
  if (sheetName === 'Updates') return 'du';
  if (sheetName === 'Memo') return 'memo';
  if (sheetName === 'Training') return 'tr';
  if (sheetName === 'Pni') return 'pni';
  if (sheetName === 'ChatBoard') return 'chat';
  return null;
}

function buildPayloadObjForSheet(sheetName, localItem) {
  // create a payload object matching the Apps Script header keys
  // must include UID field
  const uid = localItem.uid || localItem.UID || makeUID();
  if (sheetName === 'Vessel_Join' || sheetName === 'Arrivals') {
    return {
      Timestamp: localItem.date || localItem.Timestamp || '',
      Vessel: localItem.vessel || localItem.Vessel || '',
      Port: localItem.port || localItem.Port || '',
      'No. of Crew': localItem.noCrew || localItem['No. of Crew'] || localItem.No || '',
      Rank: localItem.rank || localItem.Rank || '',
      Date: localItem.date || localItem.Date || '',
      Flight: localItem.flight || localItem.Flight || '',
      UID: uid
    };
  }
  if (sheetName === 'ChatBoard') {
    return {
      Timestamp: localItem.date || localItem.Timestamp || new Date().toISOString(),
      Name: localItem.name || localItem.Name || '',
      Message: localItem.message || localItem.Message || '',
      Date: localItem.date || '',
      UID: uid
    };
  }
  if (sheetName === 'Updates' || sheetName === 'Memo') {
    return {
      Timestamp: localItem.date || localItem.Timestamp || '',
      Title: localItem.title || localItem.Title || '',
      Details: localItem.details || localItem.Details || '',
      Date: localItem.date || '',
      UID: uid
    };
  }
  if (sheetName === 'Training' || sheetName === 'Pni') {
    return {
      Timestamp: localItem.date || localItem.Timestamp || '',
      Subject: localItem.subject || localItem.Subject || '',
      Details: localItem.details || localItem.Details || '',
      Date: localItem.date || '',
      UID: uid
    };
  }
  // fallback: send whole object
  const copy = Object.assign({}, localItem);
  copy.UID = uid;
  return copy;
}

function normalizeServerRowToLocal(sheetName, row) {
  // Convert server row object to a simpler local shape used by the UI
  const uid = row['UID'] || row['Uid'] || row['uid'] || row['ID'] || null;
  if (sheetName === 'Vessel_Join') {
    return { uid: uid, vessel: row['Vessel']||'', port: row['Port']||'', noCrew: row['No. of Crew']||row['No of Crew']||'', rank: row['Rank']||'', date: row['Date']||row['Timestamp']||'', flight: row['Flight']||'', synced: true };
  }
  if (sheetName === 'Arrivals') {
    return { uid: uid, vessel: row['Vessel']||'', port: row['Port']||'', noCrew: row['No. of Crew']||row['No of Crew']||'', rank: row['Rank']||'', date: row['Date']||row['Timestamp']||'', flight: row['Flight']||'', synced: true };
  }
  if (sheetName === 'Updates' || sheetName === 'Memo') {
    return { uid: uid, title: row['Title']||'', details: row['Details']||'', date: row['Date']||row['Timestamp']||'', synced: true };
  }
  if (sheetName === 'Training' || sheetName === 'Pni') {
    return { uid: uid, subject: row['Subject']||'', details: row['Details']||'', date: row['Date']||row['Timestamp']||'', synced: true };
  }
  if (sheetName === 'ChatBoard') {
    return { uid: uid, name: row['Name']||'', message: row['Message']||'', date: row['Date']||row['Timestamp']||'', synced: true };
  }
  // fallback: return as-is
  const copy = Object.assign({}, row);
  copy.uid = uid;
  copy.synced = true;
  return copy;
}

function convertCanonicalToLocal(sectionShort, canonical) {
  // Ensure the returned object matches earlier local storage field names used by renderList
  // canonical can have uid or UID, and generic field names
  const x = Object.assign({}, canonical);
  // normalize uid property name
  x.uid = x.uid || x.UID || x.UID === 0 ? x.UID : x.uid;
  x.synced = !!x.synced;
  // map to the expected field names for each section
  if (sectionShort === 'vj' || sectionShort === 'ac') {
    return { uid: x.uid, vessel: x.vessel||x.Vessel||'', port: x.port||x.Port||'', noCrew: x.noCrew||x['No. of Crew']||x['No of Crew']||'', rank: x.rank||x.Rank||'', date: x.date||x.Date||x.Timestamp||'', flight: x.flight||x.Flight||'', synced: x.synced };
  }
  if (sectionShort === 'du' || sectionShort === 'memo') {
    return { uid: x.uid, title: x.title||x.Title||'', details: x.details||x.Details||'', date: x.date||x.Date||x.Timestamp||'', synced: x.synced };
  }
  if (sectionShort === 'tr' || sectionShort === 'pni') {
    return { uid: x.uid, subject: x.subject||x.Subject||'', details: x.details||x.Details||'', date: x.date||x.Date||x.Timestamp||'', synced: x.synced };
  }
  if (sectionShort === 'chat') {
    return { uid: x.uid, name: x.name||x.Name||'', message: x.message||x.Message||'', date: x.date||x.Date||x.Timestamp||'', synced: x.synced };
  }
  // default passthrough
  return x;
}

/* =========================
   Make syncFromServer the canonical sync entrypoint and wire to existing UI
   ========================= */

window.syncFromSheet = window.syncFromServer = syncFromServer;

// Replace older manualSync wrapper to use the new sync
window.manualSync = async function(){
  try {
    await syncFromServer();
    await retryLocalAppends(); // attempt resends for any still unsynced items
    alert('Sync complete.');
  } catch (e) {
    console.error('manualSync error', e);
    alert('Sync error (see console).');
  }
};

// End of PART 4/4
</script>
</body>
</html>
