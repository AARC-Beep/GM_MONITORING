<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaCrew Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
body { display: flex; min-height: 100vh; margin: 0; }
.sidebar { width: 220px; background: #343a40; color: white; }
.sidebar a { display: block; padding: 10px 15px; color: white; text-decoration: none; }
.sidebar a:hover { background: #495057; }
.main { flex: 1; padding: 20px; }
</style>
</head>
<body>

<div class="sidebar">
    <h4 class="text-center py-3">SeaCrew</h4>
    <a href="#" data-sheet="Vessel_Join">Vessel Join</a>
    <a href="#" data-sheet="Arrivals">Arrivals</a>
    <a href="#" data-sheet="Updates">Updates</a>
    <a href="#" data-sheet="Memo">Memo</a>
    <a href="#" data-sheet="Training">Training</a>
    <a href="#" data-sheet="Pni">Pni</a>
    <a href="#" data-sheet="ChatBoard">ChatBoard</a>
    <a href="#" data-sheet="Users">Users</a>
    <hr>
    <a href="https://flightaware.com" target="_blank">FlightAware</a>
    <a href="https://weather.com" target="_blank">Weather</a>
    <a href="https://dmw.gov" target="_blank">DMW</a>
    <a href="https://marina.gov.ph" target="_blank">Marina</a>
</div>

<div class="main">
    <h3>Login</h3>
    <div class="mb-3">
        <input type="text" id="username" class="form-control" placeholder="Username">
    </div>
    <div class="mb-3">
        <input type="password" id="password" class="form-control" placeholder="Password">
    </div>
    <button id="loginbtn" class="btn btn-primary mb-3">Login</button>

    <h4>Sheet Data</h4>
    <div id="dataContainer"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw_rEHqI_e8c5C6_fYVZlnvLDE5FuCasSlBl0BVgkex1Hm-HrWnU21KYkIblNf8tcV8/exec"; // Replace with your GAS Web App URL

// -------------------------------
// Safe JSON parse
// -------------------------------
function safeJSONParse(rawData) {
    try {
        const jsonMatch = rawData.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error("No JSON found");
        return JSON.parse(jsonMatch[0]);
    } catch (err) {
        console.error("JSON parse failed:", err, rawData);
        return null;
    }
}

// -------------------------------
// Login
// -------------------------------
document.getElementById("loginbtn")?.addEventListener("click", async () => {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    if (!username || !password) return alert("Enter username and password");

    try {
        const response = await fetch(`${SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
        const data = safeJSONParse(await response.text());
        if (data?.status === "ok") {
            alert(`Login successful! Role: ${data.role}`);
        } else {
            alert(data?.message || "Login failed");
        }
    } catch (err) {
        console.error(err);
        alert("Login request failed");
    }
});

// -------------------------------
// Fetch all rows
// -------------------------------
async function fetchAll(sheetName) {
    try {
        const response = await fetch(`${SCRIPT_URL}?action=fetchAll&sheet=${sheetName}`);
        const data = safeJSONParse(await response.text());
        return data?.data || [];
    } catch (err) {
        console.error(err);
        return [];
    }
}

// -------------------------------
// Append, Update, Delete
// -------------------------------
async function appendData(sheetName, record) {
    const params = new URLSearchParams({ action:"append", sheet:sheetName, record:JSON.stringify(record) });
    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
    const data = safeJSONParse(await response.text());
    return data?.status === "ok";
}

async function updateData(sheetName, uid, record) {
    const params = new URLSearchParams({ action:"update", sheet:sheetName, uid, record:JSON.stringify(record) });
    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
    const data = safeJSONParse(await response.text());
    return data?.status === "ok";
}

async function deleteData(sheetName, uid) {
    const params = new URLSearchParams({ action:"delete", sheet:sheetName, uid });
    const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
    const data = safeJSONParse(await response.text());
    return data?.status === "ok";
}

// -------------------------------
// Handle sidebar clicks
// -------------------------------
document.querySelectorAll(".sidebar a[data-sheet]").forEach(link => {
    link.addEventListener("click", async (e) => {
        e.preventDefault();
        const sheet = link.getAttribute("data-sheet");
        const rows = await fetchAll(sheet);
        const container = document.getElementById("dataContainer");
        if (rows.length === 0) {
            container.innerHTML = "<p>No data found.</p>";
            return;
        }
        let html = `<table class="table table-bordered"><thead><tr>`;
        Object.keys(rows[0]).forEach(h => html += `<th>${h}</th>`);
        html += `</tr></thead><tbody>`;
        rows.forEach(r => {
            html += "<tr>";
            Object.values(r).forEach(v => html += `<td>${v}</td>`);
            html += "</tr>";
        });
        html += "</tbody></table>`;
        container.innerHTML = html;
    });
});
</script>

</body>
</html>
