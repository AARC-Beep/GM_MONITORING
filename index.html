<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeaCrew Dashboard — Daily Routine Log</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- jsPDF + AutoTable (for PDF export) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
  :root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
  .sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
  .sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
  .sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
  .sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
  .sidebar a.active { background:#072033; color:#fff; }
  .content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
  .card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
  .small-note { font-size:0.9rem; color:#666; }
  .preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
  .entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
  .entry-meta { color:#444; font-size:0.95rem; }
  .form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .form-row .form-control { min-width:140px; }
  .entry-actions button { margin-left:6px; }
  .fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }
  .row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
  .row-entry .left { flex:1; }
  .row-entry .right { display:flex; gap:8px; align-items:center; }
  .chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
  .chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
  .chat-inputs { display:flex; gap:8px; align-items:center; }
  @media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
  @media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }
  .btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
  .badge-synced { color: #0b6623; font-weight:600; margin-left:8px }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-screen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:3000">
  <div class="card p-4" style="width:420px;border-radius:12px">
    <div class="text-center mb-3">
      <h4 style="margin:0">TIWALA — SeaCrew Dashboard</h4>
      <small class="small-note">Sign in to continue</small>
    </div>

    <div class="mb-2">
      <label class="form-label">Username</label>
      <input id="loginUsername" class="form-control" />
    </div>
    <div class="mb-3">
      <label class="form-label">Password</label>
      <input id="loginPassword" type="password" class="form-control" />
    </div>

    <div class="d-flex justify-content-between align-items-center">
      <div><button class="btn btn-outline-secondary" id="loginResetBtn">Reset</button></div>
      <div>
        <button class="btn btn-primary" id="loginBtn">Sign in</button>
      </div>
    </div>
    <div class="mt-2 small-note">If you have no account, contact admin.</div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>
  <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')"><i class="fa-solid fa-circle-info"></i> Help / User Guide</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <!-- External links requested -->
  <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
  <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
  <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
  <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
  <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
  <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 style="margin:0">SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Apps Script web app: <strong>DAILY ROUTINE LOG</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
      <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
    </div>
  </div>

  <!-- DASHBOARD (previews + chatboard) -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <!-- Previews columns -->
      <div class="col-md-8">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h5 style="margin:0">Quick Overview</h5>
            <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card-slim">
                <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                <div class="preview-table" id="vesselPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                <div class="preview-table" id="arrivalsPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                <div class="preview-table" id="updatesPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                <div class="preview-table" id="memoPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                <div class="preview-table" id="trainingPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                <div class="preview-table" id="pniPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Chatboard / Sticky -->
      <div class="col-md-4">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h6 style="margin:0">ChatBoard (public view)</h6>
            <div><i id="chatBell" class="fa-solid fa-bell" style="color:#888"></i></div>
          </div>
          <div class="chatboard mt-2">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
              <input id="chatMsg" class="form-control" placeholder="Message" />
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
            <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
          </div>
        </div>

        <div class="card-slim mt-3">
          <h6>Sticky / Quick Note</h6>
          <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
            <button class="btn btn-primary" onclick="saveSticky()">Save</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ---------- Sections: Vessel Join / Arrivals / Updates / Memo / Training / PNI ---------- -->
  <!-- Vessel Join -->
  <section id="vesselJoin" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Vessel Crew Joining</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="vjVessel">
        <input class="form-control" placeholder="Port" id="vjPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
        <input class="form-control" placeholder="Rank" id="vjRank">
        <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
        <input class="form-control" placeholder="Flight" id="vjFlight">

        <button class="btn btn-success" id="vjAddBtn">Add</button>
        <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
      </div>
    </div>

    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    
    <div id="t_list" class="card-slim"></div>
   </section>

 <!-- PnI -->
<section id="pni" class="section" style="display:none">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4>P&amp;I / Events</h4>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
      <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
    </div>
  </div>

  <div class="card-slim mb-3">
    <div class="form-row">
      <input class="form-control" placeholder="Subject" id="pSubject">
      <input class="form-control" placeholder="Details" id="pDetails">
      <input class="form-control" type="date" id="pDate">
      <button class="btn btn-success" id="pAddBtn">Add</button>
      <button class="btn btn-secondary" id="pResetBtn">Reset</button>
    </div>
  </div>
  <div id="p_list" class="card-slim"></div>
</section>

  <!-- HELP / USER GUIDE -->
  <section id="helpSection" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>User Guide / Help</h4>
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('helpSection','User_Guide')">Export PDF</button>
    </div>

    <div class="card-slim" style="font-size:14px; line-height:1.5">
      <h5>SeaCrew Dashboard — Daily Routine Log</h5>
      <p>This guide explains how to use the dashboard: login, add/update/delete entries, chatboard and monthly report.</p>
      <ol>
        <li>Login with your Username / Password (stored in the Users sheet).</li>
        <li>Use the left sidebar to navigate sections.</li>
        <li>Only Admins can edit/archive entries; Users can add only (role enforced after login).</li>
        <li>Delete moves entries to Archive_&lt;SheetName&gt; so monthly reports still include deleted items.</li>
      </ol>
    </div>
  </section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

// SeaCrew Dashboard - Robust Hybrid Client Sync (LocalStorage + Safe Server Upsert)
// Paste this entire <script> block into your HTML (replace existing long script).

(function(){
  // ========== CONFIG ==========
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx76OVKtoDUmVBqmS5gt0CykqkS6aWVDTtZ-5zFMgT4w5VwdpadTdok0Z-gZHZWM52-/exec"; // your deployed webapp URL
  const SYNC_INTERVAL_MS = 15000; // 15s safe loop
  const JSONP_TIMEOUT = 12000;
  const MAX_RETRY_ATTEMPTS = 5;

  // sheet names and local keys (exact headers assumed)
  const SECTIONS = {
    vj: { key: 'vesselJoin', sheet: 'Vessel_Join', headers: ['Timestamp','Vessel','Port','No. of Crew','Rank','Date','Flight','UID'] },
    ac: { key: 'arrivingCrew', sheet: 'Arrivals',    headers: ['Timestamp','Vessel','Port','No. of Crew','Rank','Date','Flight','UID'] },
    du: { key: 'dailyUpdates', sheet: 'Updates',   headers: ['Timestamp','Title','Details','Date','UID'] },
    memo:{ key: 'memo', sheet: 'Memo',             headers: ['Timestamp','Title','Details','Date','UID'] },
    tr:  { key: 'training', sheet: 'Training',     headers: ['Timestamp','Subject','Details','Date','UID'] },
    pni: { key: 'pni', sheet: 'Pni',               headers: ['Timestamp','Subject','Details','Date','UID'] },
    chat:{ key: 'chatboard', sheet: 'ChatBoard',   headers: ['Timestamp','Name','Message','Date','UID'] }
  };

  // ========== State & helpers ==========
  let REQUEST_LOCK = false;           // prevents concurrent sync cycles
  let __jsonp_counter = 0;

  function saveLocal(key, arr){ localStorage.setItem(key, JSON.stringify(arr||[])); }
  function loadLocal(key){ try{ return JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){ return []; } }
  function makeUID(){ return 'UID-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }
  function nowISO(){ return new Date().toISOString(); }

  // format for small UI touches
  function fmtDate(d){ if(!d) return ''; const dt = new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString(); }
  function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // ========== JSONP with timeout & single callback registration ==========
  function jsonpRequest(params={}, timeout=JSONP_TIMEOUT){
    return new Promise((resolve,reject)=>{
      if(!SCRIPT_URL) return reject(new Error('SCRIPT_URL not set'));
      __jsonp_counter++;
      const cbName = '__jsonp_cb_' + Date.now() + '_' + __jsonp_counter;
      params.callback = cbName;
      const query = Object.keys(params).map(k=>encodeURIComponent(k)+'='+encodeURIComponent(params[k])).join('&');
      const src = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + query;

      const script = document.createElement('script');
      script.src = src;
      script.async = true;

      let timer = setTimeout(()=>{
        cleanup();
        reject(new Error('JSONP timeout'));
      }, timeout);

      function cleanup(){ clearTimeout(timer); try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; } if(script.parentNode) script.parentNode.removeChild(script); }

      window[cbName] = function(data){ cleanup(); resolve(data); };
      script.onerror = function(){ cleanup(); reject(new Error('JSONP script error')); };

      document.head.appendChild(script);
    });
  }

  // ========== Server helpers (try multiple action names for compatibility) ==========
  async function callServerFetchAll(sheets){
    // try fetchall then fetchAll
    try{ const r = await jsonpRequest({ action:'fetchall', sheets: sheets.join(',') }); return r || {}; }catch(e){}
    try{ const r = await jsonpRequest({ action:'fetchAll', sheets: sheets.join(',') }); return r || {}; }catch(e){ console.warn('fetchAll failed', e); return {}; }
  }

  async function callServerGet(sheet){
    try{ const r = await jsonpRequest({ action:'get', sheet: sheet }); return (r && r.data) ? r.data : r || [];}catch(e){ try{ const r = await jsonpRequest({ action:'fetch', sheet: sheet }); return (r && r.data)? r.data: []; }catch(err){ console.warn('callServerGet failed', err); return []; }}
  }

  async function callServerAppend(sheet, rowArray){
    const payload = { action:'append_uid', sheet: sheet, row: JSON.stringify(rowArray) };
    try{ return await jsonpRequest(payload); }catch(e){ // fallback to append
      try{ return await jsonpRequest({ action:'append', sheet: sheet, row: JSON.stringify(arrayToObject(rowArray, SECTIONS // generic ) ) }); }catch(err){ throw e; }
    }
  }

  async function callServerUpdateByUID(sheet, uid, rowArray){
    try{ return await jsonpRequest({ action:'update_uid', sheet: sheet, uid: uid, row: JSON.stringify(rowArray) }); }catch(e){ try{ return await jsonpRequest({ action:'update', sheet: sheet, uid: uid, row: JSON.stringify(rowArray) }); }catch(err){ throw e; } }
  }

  async function callServerDeleteByUID(sheet, uid){
    try{ return await jsonpRequest({ action:'delete_uid', sheet: sheet, uid: uid }); }catch(e){ try{ return await jsonpRequest({ action:'delete', sheet: sheet, uid: uid }); }catch(err){ throw e; } }
  }

  // helper to convert row array to object using known headers (used in fallback)
  function arrayToObject(arr, section){
    try{
      const headers = section && section.headers ? section.headers.slice() : [];
      const obj = {};
      for(let i=0;i<headers.length && i<arr.length;i++){ obj[headers[i]] = arr[i]; }
      return obj;
    }catch(e){ return {}; }
  }

  // build row arrays using exact headers for a section
  function buildRow(sectionKey, payload){
    const S = Object.values(SECTIONS).find(s => s.sheet === sectionKey);
    if(!S) return Object.values(payload || {});
    return S.headers.map(h => payload[h] || payload[normalizeHeader(h)] || '');
  }

  function normalizeHeader(h){ return String(h).replace(/\s|\.|\-/g,'').toLowerCase(); }

  // ========== Safe lock wrapper ==========
  function withLock(fn){
    if(REQUEST_LOCK) return Promise.resolve();
    REQUEST_LOCK = true;
    return Promise.resolve().then(fn).catch(e=>{ console.warn('withLock error',e); }).finally(()=>{ REQUEST_LOCK = false; });
  }

  // ========== CRUD helpers (local + server) ==========
  function addLocal(sectionShort, item){
    const key = SECTIONS[sectionShort].key; const arr = loadLocal(key);
    if(!item.uid) item.uid = makeUID(); item.synced = false; item._attempts = 0;
    arr.push(item); saveLocal(key, arr);
  }

  async function sendOneLocal(sectionShort, item){
    const meta = SECTIONS[sectionShort];
    if(!meta) return;

    // create payload object keyed by header names
    const headers = meta.headers.slice();
    const payloadObj = {};
    // map based on known form fields
    if(sectionShort === 'vj' || sectionShort === 'ac'){
      payloadObj['Timestamp'] = '';
      payloadObj['Vessel'] = item.vessel || '';
      payloadObj['Port'] = item.port || '';
      payloadObj['No. of Crew'] = item.noCrew || item['No. of Crew'] || '';
      payloadObj['Rank'] = item.rank || '';
      payloadObj['Date'] = item.date || '';
      payloadObj['Flight'] = item.flight || '';
      payloadObj['UID'] = item.uid;
    } else if(sectionShort === 'du' || sectionShort === 'memo'){
      payloadObj['Timestamp']=''; payloadObj['Title']= item.title||''; payloadObj['Details']= item.details||''; payloadObj['Date']=item.date||''; payloadObj['UID']=item.uid;
    } else if(sectionShort === 'tr' || sectionShort === 'pni'){
      payloadObj['Timestamp']=''; payloadObj['Subject']= item.subject||''; payloadObj['Details']= item.details||''; payloadObj['Date']=item.date||''; payloadObj['UID']=item.uid;
    } else if(sectionShort === 'chat'){
      payloadObj['Timestamp']=''; payloadObj['Name']= item.name||''; payloadObj['Message']= item.message||''; payloadObj['Date']= item.date|| nowISO(); payloadObj['UID']= item.uid;
    } else {
      // generic - convert item props to headers
      headers.forEach(h => payloadObj[h] = item[h] || '');
    }

    const rowArr = headers.map(h => payloadObj[h] || '');

    try{
      await callServerAppend(meta.sheet, rowArr);
      return { ok:true };
    }catch(e){ return { ok:false, error:e }; }
  }

  async function retryLocalAppends(){
    // Go section by section; attempt to send only one item per section per sync to avoid spikes
    const sections = Object.keys(SECTIONS);
    for(const short of sections){
      const meta = SECTIONS[short]; const arr = loadLocal(meta.key);
      let changed=false;
      for(let i=0;i<arr.length;i++){
        const item = arr[i]; if(!item || item.synced) continue;
        // prevent endless retries
        item._attempts = (item._attempts||0) + 1;
        try{
          const res = await sendOneLocal(short, item);
          if(res.ok){ arr[i].synced = true; arr[i]._attempts = 0; changed = true; break; /* send one and continue next section */ }
        }catch(e){ /* ignore, continue next item */ }
        if(item._attempts > MAX_RETRY_ATTEMPTS){ /* drop after too many attempts */ arr[i]._failed = true; changed = true; }
      }
      if(changed) saveLocal(meta.key, arr);
    }
  }

  async function syncFromSheet(){
    const tabs = Object.values(SECTIONS).map(s=>s.sheet);
    const all = await callServerFetchAll(tabs);
    // map server rows into local lists (server wins)
    Object.keys(SECTIONS).forEach(k => {
      const meta = SECTIONS[k]; const sheet = meta.sheet; const serverData = all && (all[sheet] || all[sheet.toLowerCase()] || all[sheet.replace(/_/g,'')]);
      if(!serverData) return; // no data
      const mapped = serverData.map(r => {
        // map using exact headers when present
        const uid = r['UID']|| r['Uid']|| r['uid'] || makeUID();
        if(k==='vj' || k==='ac') return { uid: uid, vessel: r['Vessel']||'', port: r['Port']||'', noCrew: r['No. of Crew']|| r['No of Crew']||'', rank: r['Rank']||'', date: r['Date']|| r['Timestamp']||'', flight: r['Flight']||'', synced:true };
        if(k==='du' || k==='memo') return { uid: uid, title: r['Title']||'', details: r['Details']||'', date: r['Date']|| r['Timestamp']||'', synced:true };
        if(k==='tr' || k==='pni') return { uid: uid, subject: r['Subject']||'', details: r['Details']||'', date: r['Date']|| r['Timestamp']||'', synced:true };
        if(k==='chat') return { uid: uid, name: r['Name']||'', message: r['Message']||'', date: r['Date']|| r['Timestamp']||'', synced:true };
        return { uid: uid, ...r, synced:true };
      });
      // Save mapped into local - but preserve unsent local items (merge by uid)
      const localNow = loadLocal(meta.key) || [];
      const unsent = localNow.filter(x=> !x.synced);
      const merged = mapped.slice();
      // append unsent local items that server doesn't have (keep them at end)
      unsent.forEach(u => { if(!merged.find(m=>m.uid===u.uid)) merged.push(u); });
      saveLocal(meta.key, merged);
    });
  }

  // ========== UI rendering (minimal but functional) ==========
  function renderList(sectionShort){
    const meta = SECTIONS[sectionShort]; const key = meta.key; const list = loadLocal(key) || [];
    const idMap = { vj:'vj_list', ac:'ac_list', du:'du_list', memo:'m_list', tr:'t_list', pni:'p_list', chat:'chat_list' };
    const container = document.getElementById(idMap[sectionShort]); if(!container) return;
    container.innerHTML = '';
    list.slice().reverse().forEach(item => {
      const div = document.createElement('div'); div.className='row-entry';
      let left=''; if(sectionShort==='vj' || sectionShort==='ac') left = `<div style="font-weight:700">${escapeHtml(item.vessel)}</div><div class="entry-meta">${escapeHtml(item.port)} · ${escapeHtml(item.noCrew)} crew · ${escapeHtml(item.rank)}</div><div class="small-note">${fmtDate(item.date)} ${item.flight? ' · ' + escapeHtml(item.flight):''}${item.synced? ' · (synced)':''}</div>`;
      else if(sectionShort==='du' || sectionShort==='memo') left = `<div style="font-weight:700">${escapeHtml(item.title)}</div><div class="small-note">${escapeHtml(item.details)}</div><div class="small-note">${fmtDate(item.date)}${item.synced? ' · (synced)':''}</div>`;
      else if(sectionShort==='tr' || sectionShort==='pni') left = `<div style="font-weight:700">${escapeHtml(item.subject)}</div><div class="small-note">${escapeHtml(item.details)}</div><div class="small-note">${fmtDate(item.date)}${item.synced? ' · (synced)':''}</div>`;
      else if(sectionShort==='chat') left = `<div style="font-weight:700">${escapeHtml(item.name)}</div><div>${escapeHtml(item.message)}</div><div class="small-note">${fmtDate(item.date)}</div>`;

      const right = document.createElement('div'); right.className='right';
      const editBtn = document.createElement('button'); editBtn.className='btn btn-sm btn-outline-primary'; editBtn.innerHTML='<i class="fa-solid fa-pen-to-square"></i>'; editBtn.onclick = ()=> startEdit(sectionShort, item.uid);
      const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-outline-danger'; delBtn.innerHTML='<i class="fa-solid fa-trash"></i>'; delBtn.onclick = ()=> deleteEntry(sectionShort, item.uid);
      right.appendChild(editBtn); right.appendChild(delBtn);

      div.innerHTML = `<div class="left">${left}</div>`;
      div.appendChild(right);
      container.appendChild(div);
    });
  }

  function renderAll(){ Object.keys(SECTIONS).forEach(k=>{ if(k==='chat') renderChatPreview(); else renderList(k); }); }

  // chat preview small
  function renderChatPreview(){ const key=SECTIONS.chat.key; const arr = loadLocal(key) || []; const el = document.getElementById('chatLog'); if(!el) return; el.innerHTML = arr.slice().reverse().map(it=>`<div style="margin-bottom:8px"><strong>${escapeHtml(it.name)}</strong><div>${escapeHtml(it.message)}</div><small class="small-note">${fmtDate(it.date)}</small></div>`).join(''); }

  // ========== Edit/Delete flows ==========
  function startEdit(sectionShort, uid){ const meta=SECTIONS[sectionShort]; const arr = loadLocal(meta.key)||[]; const item = arr.find(x=>x.uid===uid); if(!item) return alert('Item not found'); // populate forms (assumes same ids as before)
    if(sectionShort==='vj'){ document.getElementById('vjVessel').value=item.vessel||''; document.getElementById('vjPort').value=item.port||''; document.getElementById('vjNo').value=item.noCrew||''; document.getElementById('vjRank').value=item.rank||''; document.getElementById('vjDate').value=item.date||''; document.getElementById('vjFlight').value=item.flight||''; document.getElementById('vjAddBtn').innerText='Update'; document.getElementById('vjAddBtn').dataset.edit=uid; }
    if(sectionShort==='ac'){ document.getElementById('acVessel').value=item.vessel||''; document.getElementById('acPort').value=item.port||''; document.getElementById('acNo').value=item.noCrew||''; document.getElementById('acRank').value=item.rank||''; document.getElementById('acDate').value=item.date||''; document.getElementById('acFlight').value=item.flight||''; document.getElementById('acAddBtn').innerText='Update'; document.getElementById('acAddBtn').dataset.edit=uid; }
    if(sectionShort==='du'){ document.getElementById('duTitle').value=item.title||''; document.getElementById('duDetails').value=item.details||''; document.getElementById('duDate').value=item.date||''; document.getElementById('duAddBtn').innerText='Update'; document.getElementById('duAddBtn').dataset.edit=uid; }
    if(sectionShort==='memo'){ document.getElementById('mTitle').value=item.title||''; document.getElementById('mDetails').value=item.details||''; document.getElementById('mDate').value=item.date||''; document.getElementById('mAddBtn').innerText='Update'; document.getElementById('mAddBtn').dataset.edit=uid; }
    if(sectionShort==='tr'){ document.getElementById('tSubject').value=item.subject||''; document.getElementById('tDetails').value=item.details||''; document.getElementById('tDate').value=item.date||''; document.getElementById('tAddBtn').innerText='Update'; document.getElementById('tAddBtn').dataset.edit=uid; }
    if(sectionShort==='pni'){ document.getElementById('pSubject').value=item.subject||''; document.getElementById('pDetails').value=item.details||''; document.getElementById('pDate').value=item.date||''; document.getElementById('pAddBtn').innerText='Update'; document.getElementById('pAddBtn').dataset.edit=uid; }
  }

  async function deleteEntry(sectionShort, uid){ if(!confirm('Delete this entry? (Admins only)')) return; const meta = SECTIONS[sectionShort]; let arr = loadLocal(meta.key) || []; const idx = arr.findIndex(x=>x.uid===uid); if(idx===-1) return alert('Item not found locally'); // remove locally
    const removed = arr.splice(idx,1)[0]; saveLocal(meta.key, arr); renderList(sectionShort);
    // attempt server delete (archive)
    await withLock(async ()=>{ try{ await callServerDeleteByUID(meta.sheet, uid); }catch(e){ console.warn('delete on server failed', e); } });
  }

  // ========== Button wiring (simplified) ==========
  function wireUp(){
    // VJ add/update
    const vjAdd = document.getElementById('vjAddBtn'); if(vjAdd){ vjAdd.addEventListener('click', async ()=>{
      const editUid = vjAdd.dataset.edit || null;
      const item = { vessel: document.getElementById('vjVessel').value.trim(), port: document.getElementById('vjPort').value.trim(), noCrew: document.getElementById('vjNo').value.trim(), rank: document.getElementById('vjRank').value.trim(), date: document.getElementById('vjDate').value, flight: document.getElementById('vjFlight').value };
      if(!item.vessel||!item.port||!item.noCrew||!item.rank||!item.date) return alert('Please fill required fields');
      if(editUid){ // update local
        const arr = loadLocal(SECTIONS.vj.key); const idx = arr.findIndex(x=>x.uid===editUid); if(idx>=0){ arr[idx] = Object.assign(arr[idx], item); arr[idx].synced = false; saveLocal(SECTIONS.vj.key, arr); vjAdd.innerText='Add'; delete vjAdd.dataset.edit; }
        // attempt server update via lock
        await withLock(async ()=>{ const payloadArr = buildRow(SECTIONS.vj.sheet, { 'Timestamp':'','Vessel':item.vessel,'Port':item.port,'No. of Crew':item.noCrew,'Rank':item.rank,'Date':item.date,'Flight':item.flight,'UID':editUid }); try{ await callServerUpdateByUID(SECTIONS.vj.sheet, editUid, payloadArr); const now = loadLocal(SECTIONS.vj.key); const i = now.findIndex(x=>x.uid===editUid); if(i>=0){ now[i].synced = true; saveLocal(SECTIONS.vj.key, now); } }catch(e){ console.warn('update failed',e); } });
      }else{ // add
        item.uid = makeUID(); item.synced = false; addLocal('vj', item); renderList('vj'); // try to send one now
        await withLock(async ()=>{ try{ await sendOneLocal('vj', item); const now = loadLocal(SECTIONS.vj.key); const i = now.findIndex(x=>x.uid===item.uid); if(i>=0){ now[i].synced = true; saveLocal(SECTIONS.vj.key, now); } }catch(e){ /* will retry later */ } });
      }
    }); }

    // AC add/update - same structure as VJ
    const acAdd = document.getElementById('acAddBtn'); if(acAdd){ acAdd.addEventListener('click', async ()=>{
      const editUid = acAdd.dataset.edit || null;
      const item = { vessel: document.getElementById('acVessel').value.trim(), port: document.getElementById('acPort').value.trim(), noCrew: document.getElementById('acNo').value.trim(), rank: document.getElementById('acRank').value.trim(), date: document.getElementById('acDate').value, flight: document.getElementById('acFlight').value };
      if(!item.vessel||!item.port||!item.noCrew||!item.rank||!item.date) return alert('Please fill required fields');
      if(editUid){ const arr=loadLocal(SECTIONS.ac.key); const idx=arr.findIndex(x=>x.uid===editUid); if(idx>=0){ arr[idx]=Object.assign(arr[idx],item); arr[idx].synced=false; saveLocal(SECTIONS.ac.key,arr); acAdd.innerText='Add'; delete acAdd.dataset.edit; }
        await withLock(async ()=>{ const payloadArr = buildRow(SECTIONS.ac.sheet, { 'Timestamp':'','Vessel':item.vessel,'Port':item.port,'No. of Crew':item.noCrew,'Rank':item.rank,'Date':item.date,'Flight':item.flight,'UID':editUid }); try{ await callServerUpdateByUID(SECTIONS.ac.sheet, editUid, payloadArr); const now=loadLocal(SECTIONS.ac.key); const i=now.findIndex(x=>x.uid===editUid); if(i>=0){ now[i].synced=true; saveLocal(SECTIONS.ac.key, now); } }catch(e){ console.warn('update failed',e); } });
      }else{ item.uid = makeUID(); addLocal('ac', item); renderList('ac'); await withLock(async ()=>{ try{ await sendOneLocal('ac', item); const now = loadLocal(SECTIONS.ac.key); const i = now.findIndex(x=>x.uid===item.uid); if(i>=0){ now[i].synced = true; saveLocal(SECTIONS.ac.key, now); } }catch(e){} }); }
    }); }

    // DU, MEMO, TR, PNI simplified add/update
    const mapSimple = [ ['du','duAddBtn',['duTitle','duDetails','duDate'],'title','details'], ['memo','mAddBtn',['mTitle','mDetails','mDate'],'title','details'], ['tr','tAddBtn',['tSubject','tDetails','tDate'],'subject','details'], ['pni','pAddBtn',['pSubject','pDetails','pDate'],'subject','details'] ];
    mapSimple.forEach(([short, btnId, fields, field1, field2])=>{
      const btn = document.getElementById(btnId); if(!btn) return;
      btn.addEventListener('click', async ()=>{
        const editUid = btn.dataset.edit || null;
        const obj = {};
        obj[field1] = document.getElementById(fields[0]).value.trim(); obj[field2] = document.getElementById(fields[1]).value.trim(); obj.date = document.getElementById(fields[2]).value;
        if(!obj[field1] || !obj[field2] || !obj.date) return alert('Please fill required fields');
        if(editUid){ const arr = loadLocal(SECTIONS[short].key); const idx = arr.findIndex(x=>x.uid===editUid); if(idx>=0){ arr[idx] = Object.assign(arr[idx], obj); arr[idx].synced=false; saveLocal(SECTIONS[short].key, arr); btn.innerText='Add'; delete btn.dataset.edit; }
          await withLock(async ()=>{ const payloadArr = buildRow(SECTIONS[short].sheet, buildPayloadForSimple(short, arr[idx]||obj, editUid)); try{ await callServerUpdateByUID(SECTIONS[short].sheet, editUid, payloadArr); const now = loadLocal(SECTIONS[short].key); const i = now.findIndex(x=>x.uid===editUid); if(i>=0){ now[i].synced = true; saveLocal(SECTIONS[short].key, now); } }catch(e){ console.warn('update failed',e); } });
        }else{ obj.uid = makeUID(); addLocal(short, obj); renderList(short); await withLock(async ()=>{ try{ await sendOneLocal(short, obj); const now = loadLocal(SECTIONS[short].key); const i = now.findIndex(x=>x.uid===obj.uid); if(i>=0){ now[i].synced = true; saveLocal(SECTIONS[short].key, now); } }catch(e){} }); }
      });
    });

    // Chat send
    const chatBtn = document.getElementById('chatSendBtn'); if(chatBtn){ chatBtn.addEventListener('click', async ()=>{
      if(REQUEST_LOCK) return alert('Sending—please wait'); const name = document.getElementById('chatName').value.trim() || 'Anonymous'; const msg = document.getElementById('chatMsg').value.trim(); if(!msg) return alert('Enter a message'); const obj = { name: name, message: msg, date: nowISO(), uid: makeUID() }; addLocal('chat', obj); renderChatPreview(); await withLock(async ()=>{ try{ await sendOneLocal('chat', obj); const now = loadLocal(SECTIONS.chat.key); const i = now.findIndex(x=>x.uid===obj.uid); if(i>=0){ now[i].synced = true; saveLocal(SECTIONS.chat.key, now); } }catch(e){ console.warn('chat send failed', e); } }); document.getElementById('chatMsg').value=''; }); }

  }

  function buildPayloadForSimple(short, item, uid){ if(!item) item={}; if(!uid) uid = item.uid || makeUID(); if(short==='du' || short==='memo') return { 'Timestamp':'','Title': item.title||'','Details': item.details||'','Date': item.date||'','UID': uid }; if(short==='tr' || short==='pni') return { 'Timestamp':'','Subject': item.subject||'','Details': item.details||'','Date': item.date||'','UID': uid }; return {} }

  // ========== Initialization & safe sync loop ==========
  function init(){
    wireUp(); // attach event handlers
    // initial render of any existing local data
    Object.keys(SECTIONS).forEach(k=>{ if(k==='chat') renderChatPreview(); else renderList(k); });

    // safe sync loop
    setInterval(()=>{
      withLock(async ()=>{
        try{ await retryLocalAppends(); }catch(e){ console.warn('retryLocalAppends error', e); }
        try{ await syncFromSheet(); }catch(e){ console.warn('syncFromSheet error', e); }
        renderAll();
      });
    }, SYNC_INTERVAL_MS);

    // first immediate sync on load
    withLock(async ()=>{ await retryLocalAppends(); await syncFromSheet(); renderAll(); });
  }

  // start after DOMContentLoaded
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

  // expose minimal debug API on window for testing
  window.SeaCrewSync = { syncFromSheet, retryLocalAppends, renderAll, loadLocal };
})();
