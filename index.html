<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SeaCrew Dashboard — Daily Routine Log</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- jsPDF + AutoTable (for PDF export) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
    .sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
    .sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
    .sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
    .sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
    .sidebar a.active { background:#072033; color:#fff; }
    .content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
    .card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
    .small-note { font-size:0.9rem; color:#666; }
    .preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
    .entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
    .entry-meta { color:#444; font-size:0.95rem; }
    .form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .form-row .form-control { min-width:140px; }
    .entry-actions button { margin-left:6px; }
    .fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }

    /* layout for list rows */
    .row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
    .row-entry .left { flex:1; }
    .row-entry .right { display:flex; gap:8px; align-items:center; }

    /* Chatboard */
    .chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
    .chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
    .chat-inputs { display:flex; gap:8px; align-items:center; }

    /* responsive */
    @media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
    @media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }

    /* some small helpers */
    .btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
    .badge-synced { font-size:0.75rem; color:#0b6; margin-left:6px; }
    .login-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .login-card { width:420px; padding:20px; border-radius:12px; background:#fff; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
  </style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="login-overlay" style="display:none">
  <div class="login-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 style="margin:0">TIWALA — SeaCrew Login</h5>
      <img src="" alt="" style="width:36px;opacity:.4"/>
    </div>
    <div>
      <div class="mb-2"><input id="loginUser" class="form-control" placeholder="Username"></div>
      <div class="mb-2"><input id="loginPass" type="password" class="form-control" placeholder="Password"></div>
      <div class="d-flex justify-content-between align-items-center">
        <div><input type="checkbox" id="saveCred"> <label for="saveCred">Remember (local only)</label></div>
        <div><button id="loginBtn" class="btn btn-primary">Sign in</button></div>
      </div>
      <div class="mt-2 small-note" id="loginMsg"></div>
    </div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>
  <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')"><i class="fa-solid fa-circle-info"></i> Help / User Guide</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <!-- External links requested -->
  <div style="margin-top:6px">
    <div class="small-note" style="color:#cfe8ff;margin-bottom:6px">Useful Tools</div>
    <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
    <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
    <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
    <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
    <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
    <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>
  </div>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 style="margin:0">SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Apps Script web app: <strong>DAILY ROUTINE LOG</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
      <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
      <button class="btn btn-outline-info" id="logoutBtn" style="display:none" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- DASHBOARD (previews + chatboard) -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <!-- Previews columns -->
      <div class="col-md-8">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h5 style="margin:0">Quick Overview</h5>
            <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card-slim">
                <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                <div class="preview-table" id="vesselPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                <div class="preview-table" id="arrivalsPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                <div class="preview-table" id="updatesPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                <div class="preview-table" id="memoPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                <div class="preview-table" id="trainingPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                <div class="preview-table" id="pniPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Chatboard / Sticky -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>ChatBoard (public view)</h6>
          <div class="chatboard">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
              <input id="chatMsg" class="form-control" placeholder="Message" />
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
            <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
          </div>
        </div>

        <div class="card-slim mt-3">
          <h6>Sticky / Quick Note</h6>
          <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
            <button class="btn btn-primary" onclick="saveSticky()">Save</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ---------- Sections: Vessel Join / Arrivals / Updates / Memo / Training / PNI ---------- -->
  <!-- Vessel Join -->
  <section id="vesselJoin" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Vessel Crew Joining</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="vjVessel">
        <input class="form-control" placeholder="Port" id="vjPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
        <input class="form-control" placeholder="Rank" id="vjRank">
        <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
        <input class="form-control" placeholder="Flight" id="vjFlight">
        <button class="btn btn-success" id="vjAddBtn">Add</button>
        <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
      </div>
    </div>

    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    <div id="t_list" class="card-slim"></div>
  </section>

  <!-- PnI -->
  <section id="pni" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>P&amp;I / Events</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="pSubject">
        <input class="form-control" placeholder="Details" id="pDetails">
        <input class="form-control" type="date" id="pDate">
        <button class="btn btn-success" id="pAddBtn">Add</button>
        <button class="btn btn-secondary" id="pResetBtn">Reset</button>
      </div>
    </div>
    <div id="p_list" class="card-slim"></div>
  </section>

  <!-- HELP / USER GUIDE -->
  <section id="helpSection" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>User Guide / Help</h4>
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('helpSection','User_Guide')">Export PDF</button>
    </div>

    <div class="card-slim" style="font-size:14px; line-height:1.5">
      <h5>SeaCrew Dashboard — Daily Routine Log (User Guide)</h5>
      <ol>
        <li>Login using your Username and Password (from Users sheet).</li>
        <li>Use the sidebar to navigate sections. Add entries in the form at the top of each section.</li>
        <li>To edit an entry, click the edit (pencil) icon — the form will populate. Update then press "Update".</li>
        <li>To delete an entry, click the trash icon and confirm. Deleted entries are removed from the sheet.</li>
        <li>ChatBoard posts a message to the ChatBoard sheet (sound and visual alert when new messages arrive).</li>
        <li>Press "Sync now" to manually sync. Auto-sync occurs every 15 seconds.</li>
        <li>Monthly PDF generates consolidated report (landscape, font-size 8) and includes a GM signature page.</li>
      </ol>
      <p class="small-note">If you want deletions to be archived (not permanently removed), ask me and I'll implement an "Archive" sheet behavior instead of deleting rows.</p>
    </div>
  </section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

/* ============================================================
   SeaCrew Dashboard JS — Full Functionality + Edit/Delete
===============================================================*/

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby0g4xZHcDgS7UQqodhIuqI00PTEyePHjEEiqA2t7xVTptOIF1oLRCA02aQBwwRw5St/exec"; // replace with your deployed Apps Script URL
let currentUser = null;
let autoSyncInterval = null;

/* ---------------- JSONP HELPER ---------------- */
function jsonpRequest(params) {
  return new Promise((resolve, reject) => {
    const callbackName = "cb_" + Math.random().toString(36).substr(2,9);
    params.callback = callbackName;

    window[callbackName] = (data) => { delete window[callbackName]; script.remove(); resolve(data); };
    
    const query = Object.keys(params).map(k => encodeURIComponent(k) + "=" + encodeURIComponent(params[k])).join("&");
    const script = document.createElement("script");
    script.src = `${SCRIPT_URL}?${query}`;
    script.onerror = () => { delete window[callbackName]; script.remove(); reject(new Error("JSONP failed")); };
    document.body.appendChild(script);
  });
}

/* ---------------- LOGIN / LOGOUT ---------------- */
async function login() {
  const username = document.getElementById("loginUser").value.trim();
  const password = document.getElementById("loginPass").value.trim();
  const msgEl = document.getElementById("loginMsg");
  msgEl.textContent = "";

  if(!username || !password) { msgEl.textContent = "Enter username & password"; return; }

  try {
    const res = await jsonpRequest({ action: "auth", username, password });
    if(res.success){
      currentUser = res;
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      setupDashboard();
    } else {
      msgEl.textContent = res.message || "Invalid credentials";
    }
  } catch(err) {
    console.error(err);
    msgEl.textContent = "Login error";
  }
}

function logout() {
  currentUser = null;
  document.getElementById("loginOverlay").style.display = "flex";
  document.getElementById("logoutBtn").style.display = "none";
  if(autoSyncInterval) clearInterval(autoSyncInterval);
}

/* ---------------- NAVIGATION ---------------- */
function navTo(event, sectionId){
  event.preventDefault();
  document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
  document.getElementById(sectionId).style.display = "block";
  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  event.currentTarget.classList.add("active");
}
function navToElement(sectionId){
  document.querySelectorAll(".section").forEach(sec => sec.style.display = "none");
  document.getElementById(sectionId).style.display = "block";
  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  const a = document.querySelector(`.sidebar a[data-target="${sectionId}"]`);
  if(a) a.classList.add("active");
}

/* ---------------- DASHBOARD PREVIEWS ---------------- */
async function loadSectionPreview(sheetName, previewDivId, countSpanId) {
  const res = await jsonpRequest({ action:"fetch", sheet: sheetName });
  const previewDiv = document.getElementById(previewDivId);
  const countSpan = document.getElementById(countSpanId);
  previewDiv.innerHTML = "";
  if(res.success && res.data.length){
    res.data.slice(-5).forEach(row => {
      const el = document.createElement("div");
      el.textContent = Object.values(row).join(" | ");
      previewDiv.appendChild(el);
    });
    countSpan.textContent = res.data.length;
  } else countSpan.textContent = "0";
}

async function loadDashboardData(){
  loadSectionPreview("Vessel_Join","vesselPreviewSmall","countVessel");
  loadSectionPreview("Arrivals","arrivalsPreviewSmall","countArrivals");
  loadSectionPreview("Daily_Updates","updatesPreviewSmall","countUpdates");
  loadSectionPreview("Memo","memoPreviewSmall","countMemo");
  loadSectionPreview("Training","trainingPreviewSmall","countTraining");
  loadSectionPreview("PNI","pniPreviewSmall","countPNI");
}

/* ---------------- SECTION RENDER + EDIT/DELETE ---------------- */
async function renderSection(sheet, listDivId, formFields, resetForm) {
  const res = await jsonpRequest({ action:"fetch", sheet });
  const listDiv = document.getElementById(listDivId);
  listDiv.innerHTML = "";

  if(res.success && res.data.length){
    res.data.forEach(row => {
      const div = document.createElement("div");
      div.className = "row-entry";

      const left = document.createElement("div");
      left.className = "left";
      left.textContent = Object.values(row).join(" | ");

      const right = document.createElement("div");
      right.className = "right";

      // Edit button
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-sm btn-outline-primary";
      editBtn.innerHTML = '<i class="fa-solid fa-pencil"></i>';
      editBtn.addEventListener("click", () => {
        let i=0; 
        for(const id of formFields) document.getElementById(id).value = Object.values(row)[i++] || "";
        // Store UID for update
        window.currentEditUID = row.UID;
        window.currentEditSheet = sheet;
      });

      // Delete button
      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-sm btn-outline-danger";
      delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
      delBtn.addEventListener("click", async () => {
        if(confirm("Delete this entry?")){
          await jsonpRequest({ action:"delete_uid", sheet, uid: row.UID });
          renderSection(sheet,listDivId,formFields,resetForm);
          loadDashboardData();
        }
      });

      right.appendChild(editBtn);
      right.appendChild(delBtn);

      div.appendChild(left);
      div.appendChild(right);
      listDiv.appendChild(div);
    });
  }
}

/* ---------------- SECTION ADD/UPDATE BUTTONS ---------------- */
function setupSectionButtons(sheet, addBtnId, resetBtnId, formFields, listDivId){
  const addBtn = document.getElementById(addBtnId);
  const resetBtn = document.getElementById(resetBtnId);

  addBtn.addEventListener("click", async () => {
    const values = formFields.map(id=>document.getElementById(id).value);
    if(window.currentEditUID && window.currentEditSheet === sheet){
      // update
      await jsonpRequest({ action:"update_uid", sheet, uid: window.currentEditUID, row: JSON.stringify(values) });
      window.currentEditUID = null;
      window.currentEditSheet = null;
    } else {
      await jsonpRequest({ action:"append_uid", sheet, row: JSON.stringify(values) });
    }
    resetForm();
    renderSection(sheet,listDivId,formFields,resetForm);
    loadDashboardData();
  });

  resetBtn.addEventListener("click", resetForm);
}

/* ---------------- RESET FORM HELPERS ---------------- */
function makeResetForm(ids){ return ()=>{ ids.forEach(id=>document.getElementById(id).value=""); window.currentEditUID=null; window.currentEditSheet=null; } }

/* ---------------- CHATBOARD ---------------- */
async function loadChatBoard() {
  const res = await jsonpRequest({ action:"fetch", sheet:"ChatBoard" });
  const logEl = document.getElementById("chatLog");
  logEl.innerHTML = "";
  if(res.success && res.data.length){
    res.data.slice(-20).forEach(r => {
      const div = document.createElement("div");
      div.textContent = `[${r.Date}] ${r.Name}: ${r.Message}`;
      logEl.appendChild(div);
    });
    logEl.scrollTop = logEl.scrollHeight;
  }
}

/* ---------------- STICKY NOTES ---------------- */
function saveSticky(){
  const val = document.getElementById("stickyNote").value;
  localStorage.setItem("stickyNote", val);
}
function loadSticky(){
  const val = localStorage.getItem("stickyNote");
  if(val) document.getElementById("stickyNote").value = val;
}

/* ---------------- MANUAL SYNC ---------------- */
function manualSync(){
  loadDashboardData();
  loadChatBoard();
  loadSticky();
  document.getElementById("lastSync").textContent = new Date().toLocaleTimeString();
}

/* ---------------- AUTO SYNC ---------------- */
function startAutoSync(){
  if(autoSyncInterval) clearInterval(autoSyncInterval);
  autoSyncInterval = setInterval(manualSync,15000);
}

/* ---------------- INITIAL DASHBOARD SETUP ---------------- */
function setupDashboard(){
  loadDashboardData();
  loadChatBoard();
  loadSticky();

  // Setup each section with add/update/reset + edit/delete
  const sections = [
    {sheet:"Vessel_Join", list:"vj_list", form:["vjVessel","vjPort","vjNo","vjRank","vjDate","vjFlight"], add:"vjAddBtn", reset:"vjResetBtn"},
    {sheet:"Arrivals", list:"ac_list", form:["acVessel","acPort","acNo","acRank","acDate","acFlight"], add:"acAddBtn", reset:"acResetBtn"},
    {sheet:"Daily_Updates", list:"du_list", form:["duTitle","duDetails","duDate"], add:"duAddBtn", reset:"duResetBtn"},
    {sheet:"Memo", list:"m_list", form:["mTitle","mDetails","mDate"], add:"mAddBtn", reset:"mResetBtn"},
    {sheet:"Training", list:"t_list", form:["tSubject","tDetails","tDate"], add:"tAddBtn", reset:"tResetBtn"},
    {sheet:"PNI", list:"p_list", form:["pSubject","pDetails","pDate"], add:"pAddBtn", reset:"pResetBtn"}
  ];
  sections.forEach(s=>{
    const resetForm = makeResetForm(s.form);
    setupSectionButtons(s.sheet,s.add,s.reset,s.form,s.list);
    renderSection(s.sheet,s.list,s.form,resetForm);
  });

  // Chatboard send
  document.getElementById("chatSendBtn").addEventListener("click", async () => {
    const name = document.getElementById("chatName").value.trim();
    const msg = document.getElementById("chatMsg").value.trim();
    if(!msg) return;
    const row = { Name: name, Message: msg, Date: new Date().toLocaleString() };
    await jsonpRequest({ action:"append_uid", sheet:"ChatBoard", row: JSON.stringify(Object.values(row)) });
    document.getElementById("chatMsg").value = "";
    loadChatBoard();
  });

  startAutoSync();
}

/* ---------------- EVENT LISTENERS ---------------- */
document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("logoutBtn").addEventListener("click", logout);
window.addEventListener("load", ()=>{
  document.getElementById("loginOverlay").style.display = "flex";
});
