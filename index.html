<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeaCrew Dashboard — Daily Routine Log (FINAL)</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
  :root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
  .sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
  .sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
  .sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
  .sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
  .sidebar a.active { background:#072033; color:#fff; }
  .content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
  .card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
  .small-note { font-size:0.9rem; color:#666; }
  .preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
  .entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
  .entry-meta { color:#444; font-size:0.95rem; }
  .form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .form-row .form-control { min-width:140px; }
  .entry-actions button { margin-left:6px; }
  .fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }
  .row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
  .row-entry .left { flex:1; }
  .row-entry .right { display:flex; gap:8px; align-items:center; }
  .chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
  .chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
  .chat-inputs { display:flex; gap:8px; align-items:center; }
  @media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
  @media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }
  .btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
  </style>
</head>
<body>

<!-- LOGIN MODAL (username+password local server check via Users sheet) -->
<div class="modal" id="loginModal" tabindex="-1" style="display:block; background: rgba(0,0,0,0.45)">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">TIWALA — SeaCrew Login</h5>
      </div>
      <div class="modal-body">
        <div class="mb-2"><input id="loginUser" class="form-control" placeholder="Username"></div>
        <div class="mb-2"><input id="loginPass" class="form-control" placeholder="Password" type="password"></div>
        <div id="loginError" class="text-danger" style="display:none"></div>
        <div class="d-flex justify-content-between mt-3">
          <button class="btn btn-secondary" id="btnGuest">Continue as Guest</button>
          <button class="btn btn-primary" id="btnLogin">Login</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>
  <a href="#" data-target="helpSection" onclick="navTo(event,'helpSection')"><i class="fa-solid fa-circle-info"></i> Help / User Guide</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
  <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
  <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
  <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
  <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
  <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Dashboard auto-syncs every 15s. If offline, entries save locally and will sync when online.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2 style="margin:0">SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Apps Script web app: <strong>DAILY ROUTINE LOG</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="manualSync()"><i class="fa-solid fa-arrows-rotate"></i> Sync now</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear local</button>
      <button class="btn btn-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly PDF</button>
    </div>
  </div>

  <!-- Dashboard -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <div class="col-md-8">
        <div class="card-slim">
          <div class="d-flex justify-content-between align-items-center">
            <h5 style="margin:0">Quick Overview</h5>
            <div><small class="small-note">Last sync: <span id="lastSync">—</span></small></div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <div class="card-slim">
                <h6>Vessel Joining <small class="small-note">(<span id="countVessel">0</span>)</small></h6>
                <div class="preview-table" id="vesselPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('vesselJoin')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Arrivals <small class="small-note">(<span id="countArrivals">0</span>)</small></h6>
                <div class="preview-table" id="arrivalsPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Updates <small class="small-note">(<span id="countUpdates">0</span>)</small></h6>
                <div class="preview-table" id="updatesPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Memo <small class="small-note">(<span id="countMemo">0</span>)</small></h6>
                <div class="preview-table" id="memoPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('memo')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>Training <small class="small-note">(<span id="countTraining">0</span>)</small></h6>
                <div class="preview-table" id="trainingPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('training')">Open</button></div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="card-slim">
                <h6>P&amp;I <small class="small-note">(<span id="countPNI">0</span>)</small></h6>
                <div class="preview-table" id="pniPreviewSmall"></div>
                <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="navToElement('pni')">Open</button></div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card-slim">
          <h6>ChatBoard (public view)</h6>
          <div class="chatboard">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name (visible)" value="Captain" />
              <input id="chatMsg" class="form-control" placeholder="Message" />
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
            <small class="small-note">Only messages posted here are saved to the ChatBoard sheet.</small>
          </div>
        </div>

        <div class="card-slim mt-3">
          <h6>Sticky / Quick Note</h6>
          <textarea id="stickyNote" class="form-control" rows="6" placeholder="Quick note — saved locally only"></textarea>
          <div class="d-flex justify-content-end mt-2">
            <button class="btn btn-outline-secondary me-2" onclick="localStorage.removeItem('stickyNote'); document.getElementById('stickyNote').value='';">Clear</button>
            <button class="btn btn-primary" onclick="saveSticky()">Save</button>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Sections (same as earlier) -->
  <!-- Vessel Join -->
  <section id="vesselJoin" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Vessel Crew Joining</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="vjVessel">
        <input class="form-control" placeholder="Port" id="vjPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
        <input class="form-control" placeholder="Rank" id="vjRank">
        <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
        <input class="form-control" placeholder="Flight" id="vjFlight">

        <button class="btn btn-success" id="vjAddBtn">Add</button>
        <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
      </div>
    </div>

    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    <div id="t_list" class="card-slim"></div>
  </section>

  <!-- PnI -->
  <section id="pni" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>P&amp;I / Events</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All (local)</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="pSubject">
        <input class="form-control" placeholder="Details" id="pDetails">
        <input class="form-control" type="date" id="pDate">
        <button class="btn btn-success" id="pAddBtn">Add</button>
        <button class="btn btn-secondary" id="pResetBtn">Reset</button>
      </div>
    </div>
    <div id="p_list" class="card-slim"></div>
  </section>

  <!-- HELP / USER GUIDE -->
  <section id="helpSection" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>User Guide / Help</h4>
      <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('helpSection','User_Guide')">Export PDF</button>
    </div>
    <div class="card-slim" style="font-size:14px; line-height:1.5">
      <h5>SeaCrew Dashboard — Daily Routine Log</h5>
      <p>This user guide is embedded here. Edit content in the HTML <code>#helpSection</code> area to update.</p>
      <ol>
        <li>Login: use your username / password (managed in the Google Sheet "Users").</li>
        <li>Only Admin users (flagged in Users sheet) can edit/delete across sections.</li>
        <li>Use the "Monthly PDF" button to export consolidated report (landscape, font size 8) and signature block.</li>
      </ol>
    </div>
  </section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<!-- jsPDF + AutoTable (for PDF export) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- PART 3: FINAL JAVASCRIPT (includes login via Users sheet) -->
<script>
/* ============ CONFIG ============ */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzkykBFEZTIWUZcsCM2Lb0_bUaqGKAQWzxK-2f4IrpP6ekN9iuh6gpGrCSeNU6uvYhc/exec';

/* Section mapping (localStorage key, sheet name) */
const SECTIONS = {
  vj: { key:'Vessel_Join_local', sheet:'Vessel_Join' },
  ac: { key:'Arrivals_local', sheet:'Arrivals' },
  du: { key:'Updates_local', sheet:'Updates' },
  memo: { key:'Memo_local', sheet:'Memo' },
  tr: { key:'Training_local', sheet:'Training' },
  pni:{ key:'Pni_local', sheet:'Pni' },
  chat:{ key:'ChatBoard_local', sheet:'ChatBoard' }
};

/* ---------- storage helpers ---------- */
function saveLocal(key, arr){ localStorage.setItem(key, JSON.stringify(arr || [])); }
function loadLocal(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }

/* ---------- util ---------- */
function fmtDate(d){ if(!d) return ""; const dt=new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString(); }
function escapeHtml(unsafe){ if(!unsafe && unsafe !== 0) return ''; return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;"); }
function makeUID(){ return 'UID-' + Date.now() + '-' + Math.floor(Math.random()*1000000); }

/* =============== JSONP helper =============== */
let __jsonp_counter = 0;
function jsonpRequest(params = {}, timeout = 9000) {
  return new Promise((resolve, reject) => {
    if(!SCRIPT_URL) return reject(new Error('SCRIPT_URL not set'));
    __jsonp_counter++;
    const cbName = '__jsonp_cb_' + Date.now() + '_' + __jsonp_counter;
    params.callback = cbName;
    const query = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
    const src = SCRIPT_URL + (SCRIPT_URL.includes('?') ? '&' : '?') + query;

    const script = document.createElement('script');
    script.src = src;
    script.async = true;

    let timer = setTimeout(()=> {
      cleanup();
      reject(new Error('JSONP timeout'));
    }, timeout);

    function cleanup(){
      clearTimeout(timer);
      try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
      if(script.parentNode) script.parentNode.removeChild(script);
    }

    window[cbName] = function(data){ cleanup(); resolve(data); };
    script.onerror = function(err){ cleanup(); reject(new Error('JSONP script error')); };
    document.head.appendChild(script);
  });
}

/* =============== Server helpers =============== */
async function callServerGet(sheetName){
  try{
    const resp = await jsonpRequest({ action: 'get', sheet: sheetName }, 9000);
    if(!resp) return [];
    if(resp.data && Array.isArray(resp.data)) return resp.data;
    if(resp.success && resp.data && Array.isArray(resp.data)) return resp.data;
    if(Array.isArray(resp)) return resp;
    return [];
  } catch(err){ console.warn('callServerGet error', err); return []; }
}

async function callServerAppend(sheetName, rowArray){
  try{
    if(!Array.isArray(rowArray)) throw new Error('append expects an array');
    const resp = await jsonpRequest({ action: 'append', sheet: sheetName, row: JSON.stringify(rowArray) }, 9000);
    return resp;
  } catch(err){ console.warn('append failed', err); throw err; }
}

async function callServerDeleteByUID(sheetName, uid){
  try{
    const resp = await jsonpRequest({ action: 'delete_uid', sheet: sheetName, uid: uid }, 9000);
    return resp;
  } catch(err){ console.warn('delete_uid failed', err); throw err; }
}

/* build row arrays matching headers (UID last) */
function buildRowForSheet(sheetName, payloadObj){
  if(sheetName === 'Vessel_Join' || sheetName === 'Arrivals'){
    return [ payloadObj['Timestamp']||'', payloadObj['Vessel']||'', payloadObj['Port']||'', payloadObj['No. of Crew']||payloadObj['No of Crew']||'', payloadObj['Rank']||'', payloadObj['Date']||'', payloadObj['Flight']||'', payloadObj['UID']||'' ];
  }
  if(sheetName === 'ChatBoard') return [ payloadObj['Timestamp']||'', payloadObj['Name']||payloadObj['name']||'', payloadObj['Message']||payloadObj['message']||'', payloadObj['Date']||'', payloadObj['UID']||'' ];
  if(sheetName === 'Updates' || sheetName === 'Memo') return [ payloadObj['Timestamp']||'', payloadObj['Title']||payloadObj['title']||'', payloadObj['Details']||payloadObj['details']||'', payloadObj['Date']||'', payloadObj['UID']||'' ];
  if(sheetName === 'Training' || sheetName === 'Pni') return [ payloadObj['Timestamp']||'', payloadObj['Subject']||payloadObj['subject']||'', payloadObj['Details']||payloadObj['details']||'', payloadObj['Date']||'', payloadObj['UID']||'' ];
  const arr = Object.values(payloadObj||{}); arr.push(payloadObj && payloadObj.UID?payloadObj.UID:''); return arr;
}

/* =============== Add / Edit / Delete / Render =============== */
const editState = { vj:null, ac:null, du:null, memo:null, tr:null, pni:null };

function addEntry(sectionShort){
  if(!(sectionShort in SECTIONS)) return;
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  const list = loadLocal(key);
  let item = { id: Date.now() };

  if(sectionShort === 'vj'){
    item.vessel = document.getElementById('vjVessel').value.trim();
    item.port = document.getElementById('vjPort').value.trim();
    item.noCrew = document.getElementById('vjNo').value.trim();
    item.rank = document.getElementById('vjRank').value.trim();
    item.date = document.getElementById('vjDate').value;
    item.flight = document.getElementById('vjFlight').value.trim();
  } else if(sectionShort === 'ac'){
    item.vessel = document.getElementById('acVessel').value.trim();
    item.port = document.getElementById('acPort').value.trim();
    item.noCrew = document.getElementById('acNo').value.trim();
    item.rank = document.getElementById('acRank').value.trim();
    item.date = document.getElementById('acDate').value;
    item.flight = document.getElementById('acFlight').value.trim();
  } else if(sectionShort === 'du'){
    item.title = document.getElementById('duTitle').value.trim();
    item.details = document.getElementById('duDetails').value.trim();
    item.date = document.getElementById('duDate').value;
  } else if(sectionShort === 'memo'){
    item.title = document.getElementById('mTitle').value.trim();
    item.details = document.getElementById('mDetails').value.trim();
    item.date = document.getElementById('mDate').value;
  } else if(sectionShort === 'tr'){
    item.subject = document.getElementById('tSubject').value.trim();
    item.details = document.getElementById('tDetails').value.trim();
    item.date = document.getElementById('tDate').value;
  } else if(sectionShort === 'pni'){
    item.subject = document.getElementById('pSubject').value.trim();
    item.details = document.getElementById('pDetails').value.trim();
    item.date = document.getElementById('pDate').value;
  }

  // validations
  if(sectionShort==='vj' && (!item.vessel || !item.port || !item.noCrew || !item.rank || !item.date)) return alert('Please fill required fields for Vessel Joining (Vessel/Port/No of Crew/Rank/Date).');
  if(sectionShort==='ac' && (!item.vessel || !item.port || !item.noCrew || !item.rank || !item.date)) return alert('Please fill required fields for Arriving Crew (Vessel/Port/No of Crew/Rank/Date).');

  // if in edit mode -> update existing record instead of creating
  if(editState[sectionShort]){
    const listNow = loadLocal(key);
    const idx = listNow.findIndex(x=>x.id === editState[sectionShort].id);
    if(idx >= 0){
      // update fields
      Object.assign(listNow[idx], item);
      listNow[idx].synced = false; // mark for re-sync
      saveLocal(key, listNow);
      renderList(sectionShort);
      clearForm(sectionShort);
      editState[sectionShort] = null;
      return; // exit — append not performed when updating locally (retryLocalAppends will sync)
    }
  }

  // assign UID and mark as not yet synced
  item.uid = makeUID(); item.synced = false;
  list.push(item); saveLocal(key, list); renderList(sectionShort); clearForm(sectionShort);

  // build payload and append to server
  const payloadObj = buildPayloadFromItem(sectionShort, item);
  const payloadArr = buildRowForSheet(SECTIONS[sectionShort].sheet, payloadObj);
  callServerAppend(SECTIONS[sectionShort].sheet, payloadArr).then(res=>{
    // mark local item as synced
    const localList = loadLocal(key);
    const i = localList.findIndex(x=>x.uid === item.uid);
    if(i>=0){ localList[i].synced = true; saveLocal(key, localList); }
    syncFromSheet().catch(()=>{});
  }).catch(err=>{ console.warn('append failed', err); });
}

function buildPayloadFromItem(sectionShort, item){
  if(sectionShort==='vj' || sectionShort==='ac'){
    return { Timestamp:'', Vessel:item.vessel||'', Port:item.port||'', 'No. of Crew':item.noCrew||'', Rank:item.rank||'', Date:item.date||'', Flight:item.flight||'', UID:item.uid };
  }
  if(sectionShort==='du' || sectionShort==='memo'){
    return { Timestamp:'', Title:item.title||'', Details:item.details||'', Date:item.date||'', UID:item.uid };
  }
  if(sectionShort==='tr' || sectionShort==='pni'){
    return { Timestamp:'', Subject:item.subject||'', Details:item.details||'', Date:item.date||'', UID:item.uid };
  }
  return { Timestamp:'', UID:item.uid };
}

/* render list — filters out empty rows and avoids duplicates by UID */
function renderList(sectionShort){
  const meta = SECTIONS[sectionShort]; const key = meta.key;
  let list = loadLocal(key) || [];
  // remove corrupted/blank
  list = list.filter(ep => ep && (ep.vessel || ep.port || ep.title || ep.subject || ep.details || ep.name || ep.message));
  // dedupe by uid (keep last)
  const seen = new Map();
  list.forEach(it => { if(it.uid) seen.set(it.uid, it); else seen.set(it.id, it); });
  const deduped = Array.from(seen.values());
  saveLocal(key, deduped);

  const idMap = { vj: 'vj_list', ac: 'ac_list', du: 'du_list', memo: 'm_list', tr: 't_list', pni: 'p_list' };
  const containerEl = document.getElementById(idMap[sectionShort]); if(!containerEl) return;
  containerEl.innerHTML = '';

  deduped.forEach(ep => {
    const row = document.createElement('div'); row.className='row-entry';
    const left = document.createElement('div'); left.className='left';
    if(sectionShort==='vj'){
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div><div class="entry-meta">${escapeHtml(ep.port)} · ${escapeHtml(ep.noCrew)} crew · ${escapeHtml(ep.rank)}</div><div class="small-note">Date: ${fmtDate(ep.date)} ${ep.flight? ' · '+escapeHtml(ep.flight): ''}${ep.synced? ' · (synced)':''}</div>`;
    } else if(sectionShort==='ac'){
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.vessel)}</div><div class="entry-meta">${escapeHtml(ep.port)} · ${escapeHtml(ep.noCrew)} crew · ${escapeHtml(ep.rank)}</div><div class="small-note">Arrival: ${fmtDate(ep.date)} ${ep.flight? ' · '+escapeHtml(ep.flight): ''}${ep.synced? ' · (synced)':''}</div>`;
    } else if(sectionShort==='du' || sectionShort==='memo'){
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.title||'')}</div><div class="small-note">${escapeHtml(ep.details||'')}</div><div class="small-note">${fmtDate(ep.date)}${ep.synced? ' · (synced)':''}</div>`;
    } else if(sectionShort==='tr' || sectionShort==='pni'){
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(ep.subject||'')}</div><div class="small-note">${escapeHtml(ep.details||'')}</div><div class="small-note">${fmtDate(ep.date)}${ep.synced? ' · (synced)':''}</div>`;
    }
    const right = document.createElement('div'); right.className='right';
    const editBtn = document.createElement('button'); editBtn.className='btn btn-sm btn-outline-primary'; editBtn.innerHTML='<i class="fa-solid fa-pen-to-square"></i>';
    editBtn.onclick = ()=> startEdit(sectionShort, ep.id);
    const delBtn = document.createElement('button'); delBtn.className='btn btn-sm btn-outline-danger'; delBtn.innerHTML='<i class="fa-solid fa-trash"></i>';
    delBtn.onclick = ()=> deleteEntry(sectionShort, ep.id);
    right.appendChild(editBtn); right.appendChild(delBtn);
    row.appendChild(left); row.appendChild(right); containerEl.appendChild(row);
  });

  updateSmallPreview(sectionShort);
  updateCounts();
}

function updateSmallPreview(sectionShort){ const key = SECTIONS[sectionShort].key; const list = loadLocal(key); const previewIdMap = { vj:'vesselPreviewSmall', ac:'arrivalsPreviewSmall', du:'updatesPreviewSmall', memo:'memoPreviewSmall', tr:'trainingPreviewSmall', pni:'pniPreviewSmall' }; const previewEl = document.getElementById(previewIdMap[sectionShort]); if(!previewEl) return; const last3 = list.slice(-3).reverse(); previewEl.innerHTML = last3.map(item=>{ if(sectionShort==='vj') return `<div><strong>${escapeHtml(item.vessel)}</strong> — ${escapeHtml(item.port)} · ${escapeHtml(item.noCrew)} crew · ${escapeHtml(item.rank)}${item.synced? ' · (synced)':''}</div>`; if(sectionShort==='ac') return `<div><strong>${escapeHtml(item.vessel)}</strong> — ${escapeHtml(item.port)} · ${escapeHtml(item.noCrew)} crew · ${escapeHtml(item.rank)}${item.synced? ' · (synced)':''}</div>`; if(sectionShort==='du') return `<div><strong>${escapeHtml(item.title)}</strong> — ${fmtDate(item.date)}<div class="small-note">${escapeHtml(item.details)}</div></div>`; if(sectionShort==='memo') return `<div><strong>${escapeHtml(item.title)}</strong> — ${fmtDate(item.date)}</div>`; if(sectionShort==='tr') return `<div><strong>${escapeHtml(item.subject)}</strong> — ${fmtDate(item.date)}</div>`; if(sectionShort==='pni') return `<div><strong>${escapeHtml(item.subject)}</strong> — ${fmtDate(item.date)}</div>`; return ''; }).join(''); }

function updateCounts(){ document.getElementById('countVessel').innerText = loadLocal(SECTIONS.vj.key).length; document.getElementById('countArrivals').innerText = loadLocal(SECTIONS.ac.key).length; document.getElementById('countUpdates').innerText = loadLocal(SECTIONS.du.key).length; document.getElementById('countMemo').innerText = loadLocal(SECTIONS.memo.key).length; document.getElementById('countTraining').innerText = loadLocal(SECTIONS.tr.key).length; document.getElementById('countPNI').innerText = loadLocal(SECTIONS.pni.key).length; }

/* delete entry locally and by UID on server if exists */
function deleteEntry(sectionShort, id){ const meta = SECTIONS[sectionShort]; const key = meta.key; let list = loadLocal(key); const idx = list.findIndex(x=>x.id === id); if(idx===-1) return; if(!confirm('Delete this entry?')) return; const uid = list[idx].uid || list[idx].UID || null; list.splice(idx,1); saveLocal(key,list); renderList(sectionShort); if(uid){ callServerDeleteByUID(meta.sheet, uid).then(()=>{ syncFromSheet().catch(()=>{}); }).catch(err=>{ console.warn('server delete failed', err); }); } }

function startEdit(sectionShort, id){ const key = SECTIONS[sectionShort].key; const list = loadLocal(key); const item = list.find(x=>x.id===id); if(!item) return; editState[sectionShort] = { id: item.id };
  if(sectionShort==='vj'){ document.getElementById('vjVessel').value=item.vessel||''; document.getElementById('vjPort').value=item.port||''; document.getElementById('vjNo').value=item.noCrew||''; document.getElementById('vjRank').value=item.rank||''; document.getElementById('vjDate').value=item.date||''; document.getElementById('vjFlight').value=item.flight||''; window.scrollTo({top:0,behavior:'smooth'}); }
  if(sectionShort==='ac'){ document.getElementById('acVessel').value=item.vessel||''; document.getElementById('acPort').value=item.port||''; document.getElementById('acNo').value=item.noCrew||''; document.getElementById('acRank').value=item.rank||''; document.getElementById('acDate').value=item.date||''; document.getElementById('acFlight').value=item.flight||''; window.scrollTo({top:0,behavior:'smooth'}); }
  if(sectionShort==='du'){ document.getElementById('duTitle').value=item.title||''; document.getElementById('duDetails').value=item.details||''; document.getElementById('duDate').value=item.date||''; }
  if(sectionShort==='memo'){ document.getElementById('mTitle').value=item.title||''; document.getElementById('mDetails').value=item.details||''; document.getElementById('mDate').value=item.date||''; }
  if(sectionShort==='tr'){ document.getElementById('tSubject').value=item.subject||''; document.getElementById('tDetails').value=item.details||''; document.getElementById('tDate').value=item.date||''; }
  if(sectionShort==='pni'){ document.getElementById('pSubject').value=item.subject||''; document.getElementById('pDetails').value=item.details||''; document.getElementById('pDate').value=item.date||''; }
  const mapBtn = { vj:'vjAddBtn', ac:'acAddBtn', du:'duAddBtn', memo:'mAddBtn', tr:'tAddBtn', pni:'pAddBtn' }; const btn=document.getElementById(mapBtn[sectionShort]); if(btn){ btn.innerText='Update'; btn.classList.remove('btn-success'); btn.classList.add('btn-warning'); }
}

function clearForm(sectionShort){ if(sectionShort==='vj'){ ['vjVessel','vjPort','vjNo','vjRank','vjDate','vjFlight'].forEach(id=>document.getElementById(id).value=''); } if(sectionShort==='ac'){ ['acVessel','acPort','acNo','acRank','acDate','acFlight'].forEach(id=>document.getElementById(id).value=''); } if(sectionShort==='du'){ ['duTitle','duDetails','duDate'].forEach(id=>document.getElementById(id).value=''); } if(sectionShort==='memo'){ ['mTitle','mDetails','mDate'].forEach(id=>document.getElementById(id).value=''); } if(sectionShort==='tr'){ ['tSubject','tDetails','tDate'].forEach(id=>document.getElementById(id).value=''); } if(sectionShort==='pni'){ ['pSubject','pDetails','pDate'].forEach(id=>document.getElementById(id).value=''); } ['vjAddBtn','acAddBtn','duAddBtn','mAddBtn','tAddBtn','pAddBtn'].forEach(id=>{ const b=document.getElementById(id); if(b){ b.innerText='Add'; b.classList.remove('btn-warning'); b.classList.add('btn-success'); } }); if(sectionShort) editState[sectionShort]=null; }

/* wire up buttons */
function wireUpButtons(){ document.getElementById('vjAddBtn').addEventListener('click', ()=>{ addEntry('vj'); }); document.getElementById('vjResetBtn').addEventListener('click', ()=> clearForm('vj'));
  document.getElementById('acAddBtn').addEventListener('click', ()=>{ addEntry('ac'); }); document.getElementById('acResetBtn').addEventListener('click', ()=> clearForm('ac'));
  document.getElementById('duAddBtn').addEventListener('click', ()=>{ addEntry('du'); }); document.getElementById('duResetBtn').addEventListener('click', ()=> clearForm('du'));
  document.getElementById('mAddBtn').addEventListener('click', ()=>{ addEntry('memo'); }); document.getElementById('mResetBtn').addEventListener('click', ()=> clearForm('memo'));
  document.getElementById('tAddBtn').addEventListener('click', ()=>{ addEntry('tr'); }); document.getElementById('tResetBtn').addEventListener('click', ()=> clearForm('tr'));
  document.getElementById('pAddBtn').addEventListener('click', ()=>{ addEntry('pni'); }); document.getElementById('pResetBtn').addEventListener('click', ()=> clearForm('pni'));
  document.getElementById('chatSendBtn').addEventListener('click', sendChat);
}

/* Chat */
async function loadChat(){ const data = await callServerGet('ChatBoard'); if(!Array.isArray(data)) return; const rows = data.map(r=>({ name: r['Name']||'', message: r['Message']||'', date: r['Date']||r['Timestamp']||'', uid: r['UID']||'' })); const el=document.getElementById('chatLog'); el.innerHTML = rows.reverse().map(row=>`<div style="margin-bottom:8px"><strong>${escapeHtml(row.name)}</strong><div>${escapeHtml(row.message)}</div><small class="small-note">${fmtDate(row.date)}</small></div>`).join(''); el.scrollTop = el.scrollHeight; }

function sendChat(){ const name=document.getElementById('chatName').value.trim()||'Anonymous'; const msg=document.getElementById('chatMsg').value.trim(); if(!msg) return alert('Please enter a message'); const key=SECTIONS.chat.key; const local=loadLocal(key); const uid=makeUID(); local.push({ id: Date.now(), name, message: msg, date: new Date().toISOString(), uid, synced:false }); saveLocal(key, local); const rowArr = buildRowForSheet('ChatBoard', { Timestamp:'', Name:name, Message:msg, Date:new Date().toISOString(), UID:uid }); callServerAppend('ChatBoard', rowArr).then(()=>{ const la=loadLocal(key); const idx=la.findIndex(x=>x.uid===uid); if(idx>=0){ la[idx].synced=true; saveLocal(key,la); } document.getElementById('chatMsg').value=''; loadChat().catch(()=>{}); }).catch(err=>{ console.warn('chat append failed', err); document.getElementById('chatMsg').value=''; loadChat().catch(()=>{}); }); }

/* sync from server */
async function syncFromSheet(){ const tabs=['Vessel_Join','Arrivals','Updates','Memo','Training','Pni','ChatBoard']; const now=new Date(); const lastSyncEl=document.getElementById('lastSync'); if(lastSyncEl) lastSyncEl.innerText=now.toLocaleString(); for(const tab of tabs){ const data=await callServerGet(tab); if(!Array.isArray(data)) continue; let mapped=[]; if(tab==='Vessel_Join'){ mapped = data.map(r=>({ id: Date.now()+Math.floor(Math.random()*100000), vessel:r['Vessel']||'', port:r['Port']||'', noCrew:r['No. of Crew']||r['No of Crew']||'', rank:r['Rank']||'', date:r['Date']||r['Timestamp']||'', flight:r['Flight']||'', uid:r['UID']||r['Uid']||r['uid']||'', synced:true })); saveLocal(SECTIONS.vj.key,mapped); renderList('vj'); }
  else if(tab==='Arrivals'){ mapped = data.map(r=>({ id: Date.now()+Math.floor(Math.random()*100000), vessel:r['Vessel']||'', port:r['Port']||'', noCrew:r['No. of Crew']||r['No of Crew']||'', rank:r['Rank']||'', date:r['Date']||r['Timestamp']||'', flight:r['Flight']||'', uid:r['UID']||r['Uid']||r['uid']||'', synced:true })); saveLocal(SECTIONS.ac.key,mapped); renderList('ac'); }
  else if(tab==='Updates'){ mapped=data.map(r=>({ id: Date.now()+Math.floor(Math.random()*100000), title:r['Title']||'', details:r['Details']||'', date:r['Date']||r['Timestamp']||'', uid:r['UID']||r['Uid']||r['uid']||'', synced:true })); saveLocal(SECTIONS.du.key,mapped); renderList('du'); }
  else if(tab==='Memo'){ mapped=data.map(r=>({ id: Date.now()+Math.floor(Math.random()*100000), title:r['Title']||'', details:r['Details']||'', date:r['Date']||r['Timestamp']||'', uid:r['UID']||r['Uid']||r['uid']||'', synced:true })); saveLocal(SECTIONS.memo.key,mapped); renderList('memo'); }
  else if(tab==='Training'){ mapped=data.map(r=>({ id: Date.now()+Math.floor(Math.random()*100000), subject:r['Subject']||'', details:r['Details']||'', date:r['Date']||r['Timestamp']||'', uid:r['UID']||r['Uid']||r['uid']||'', synced:true })); saveLocal(SECTIONS.tr.key,mapped); renderList('tr'); }
  else if(tab==='Pni'){ mapped=data.map(r=>({ id: Date.now()+Math.floor(Math.random()*100000), subject:r['Subject']||'', details:r['Details']||'', date:r['Date']||r['Timestamp']||'', uid:r['UID']||r['Uid']||r['uid']||'', synced:true })); saveLocal(SECTIONS.pni.key,mapped); renderList('pni'); }
  else if(tab==='ChatBoard'){ const chatRows=data.map(r=>({ name:r['Name']||'', message:r['Message']||'', date:r['Date']||r['Timestamp']||'', uid:r['UID']||r['Uid']||r['uid']||'' })); const el=document.getElementById('chatLog'); el.innerHTML=chatRows.reverse().map(row=>`<div style="margin-bottom:8px"><strong>${escapeHtml(row.name)}</strong><div>${escapeHtml(row.message)}</div><small class="small-note">${fmtDate(row.date)}</small></div>`).join(''); }
 }
}

async function manualSync(){ try{ await syncFromSheet(); await retryLocalAppends(); alert('Sync complete.'); } catch(err){ console.error('manualSync error', err); alert('Sync error (see console).'); } }

/* retry unsynced local appends */
async function retryLocalAppends(){ const listToTry=['vj','ac','du','memo','tr','pni','chat']; for(const short of listToTry){ const meta=SECTIONS[short]; const arr=loadLocal(meta.key); for(let i=0;i<arr.length;i++){ const item=arr[i]; if(item && item.synced) continue; if(!item.uid) item.uid=makeUID(); const payloadArr = buildRowForSheet(meta.sheet, buildPayloadFromItem(short,item)); try{ await callServerAppend(meta.sheet,payloadArr); const localNow=loadLocal(meta.key); const idxLocal=localNow.findIndex(x=>x.uid===item.uid); if(idxLocal>=0){ localNow[idxLocal].synced=true; saveLocal(meta.key,localNow); } } catch(e){ /* ignore */ } } } await syncFromSheet(); }

/* PDF export (landscape, font 8, GM signature) */
function printSectionPDF(sectionId, filename, all=false){ const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation:'landscape' }); doc.setFontSize(14); if(all){ doc.text('SeaCrew Monthly Report',14,14); // generate each section
  generateSectionPDF(doc,'Vessel Crew Joining', loadLocal(SECTIONS.vj.key), ['Vessel','Port','No. Crew','Rank','Date','Flight'], r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']);
  generateSectionPDF(doc,'Arriving Crew', loadLocal(SECTIONS.ac.key), ['Vessel','Port','No. Crew','Rank','Arrival','Flight'], r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']);
  generateSectionPDF(doc,'Daily Updates', loadLocal(SECTIONS.du.key), ['Title','Details','Date'], r=>[r.title,r.details,fmtDate(r.date)]);
  generateSectionPDF(doc,'Memo', loadLocal(SECTIONS.memo.key), ['Title','Details','Date'], r=>[r.title,r.details,fmtDate(r.date)]);
  generateSectionPDF(doc,'Training', loadLocal(SECTIONS.tr.key), ['Subject','Details','Date'], r=>[r.subject,r.details,fmtDate(r.date)]);
  generateSectionPDF(doc,'P&I Events', loadLocal(SECTIONS.pni.key), ['Subject','Details','Date'], r=>[r.subject,r.details,fmtDate(r.date)]);
  doc.addPage('landscape'); doc.setFontSize(12); doc.text('Prepared By:',14,30); doc.setFontSize(14); doc.text('__________________________________',14,50); doc.text('General Manager',14,58); doc.save(filename+'.pdf'); return; }
  const short = mapSectionIdToShort(sectionId); if(!short){ alert('Unknown section'); return; } const list=loadLocal(SECTIONS[short].key); if(!list||list.length===0){ alert('No entries to print'); return; } doc.setFontSize(14); doc.text(filename.replace(/_/g,' '),14,20); let headers=[], rows=[]; if(short==='vj'){ headers=['Vessel','Port','No. Crew','Rank','Date','Flight']; rows=list.map(r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']); }
  if(short==='ac'){ headers=['Vessel','Port','No. Crew','Rank','Arrival','Flight']; rows=list.map(r=>[r.vessel,r.port,r.noCrew,r.rank,fmtDate(r.date),r.flight||'']); }
  if(short==='du'){ headers=['Title','Details','Date']; rows=list.map(r=>[r.title,r.details,fmtDate(r.date)]); }
  if(short==='memo'){ headers=['Title','Details','Date']; rows=list.map(r=>[r.title,r.details,fmtDate(r.date)]); }
  if(short==='tr'){ headers=['Subject','Details','Date']; rows=list.map(r=>[r.subject,r.details,fmtDate(r.date)]); }
  if(short==='pni'){ headers=['Subject','Details','Date']; rows=list.map(r=>[r.subject,r.details,fmtDate(r.date)]); }
  doc.autoTable({ head:[headers], body:rows, startY:28, styles:{ fontSize:8, cellPadding:3, overflow:'linebreak' }, headStyles:{ fillColor:[0,51,102], textColor:255, fontStyle:'bold' }, alternateRowStyles:{ fillColor:[240,240,240] } }); doc.save(filename+'.pdf'); }

function generateSectionPDF(doc, sectionTitle, list, headers, rowMapper){ if(!list||list.length===0) return; doc.addPage('landscape'); doc.setFontSize(12); doc.text(sectionTitle,14,18); const rows=list.map(rowMapper); doc.autoTable({ head:[headers], body:rows, startY:26, styles:{ fontSize:8, cellPadding:2, overflow:'linebreak' }, headStyles:{ fillColor:[0,51,102], textColor:255, fontStyle:'bold' }, alternateRowStyles:{ fillColor:[230,230,230] } }); }

function saveSticky(){ const val=document.getElementById('stickyNote').value||''; localStorage.setItem('stickyNote',val); alert('Saved locally'); }

/* =============== AUTH (Users sheet) =============== */
async function authUser(username,password){ try{ const res = await jsonpRequest({ action:'get', sheet:'Users' },9000); if(!res || !Array.isArray(res.data)) return { ok:false, error:'Users sheet not found' }; const users = res.data; // headers assumed Username,Password,Role
  const found = users.find(u=> String(u['Username']||u['username']||'').toLowerCase()===String(username).toLowerCase() && String(u['Password']||u['password']||'')===String(password)); if(found) return { ok:true, user: { username: found['Username']||found['username'], role: found['Role']|| found['role'] || 'user' } }; return { ok:false }; } catch(e){ console.warn('auth error',e); return { ok:false, error:'auth failed' }; } }

/* login UI wiring */
document.getElementById('btnLogin').addEventListener('click', async function(){ const u=document.getElementById('loginUser').value.trim(); const p=document.getElementById('loginPass').value.trim(); if(!u||!p){ document.getElementById('loginError').innerText='Enter username & password'; document.getElementById('loginError').style.display='block'; return; } document.getElementById('btnLogin').innerText='Checking...'; const r = await authUser(u,p); document.getElementById('btnLogin').innerText='Login'; if(r.ok){ localStorage.setItem('sc_user', JSON.stringify(r.user)); document.getElementById('loginModal').style.display='none'; init(); } else { document.getElementById('loginError').innerText='Invalid credentials'; document.getElementById('loginError').style.display='block'; } });

/* guest */
document.getElementById('btnGuest').addEventListener('click', function(){ localStorage.setItem('sc_user', JSON.stringify({ username:'Guest', role:'guest' })); document.getElementById('loginModal').style.display='none'; init(); });

/* =============== Init =============== */
function init(){ wireUpButtons(); const saved = localStorage.getItem('stickyNote'); if(saved) document.getElementById('stickyNote').value=saved; // render all local
  Object.keys(SECTIONS).forEach(k=>{ if(k==='chat') return; renderList(k); }); loadChat().catch(()=>{}); syncFromSheet().catch(()=>{}); setInterval(()=>{ syncFromSheet().catch(()=>{}); retryLocalAppends().catch(()=>{}); },15000); }

window.addEventListener('DOMContentLoaded', ()=>{
  // show login modal until authenticated
});
</script>

<!-- =======================
  INSTALL_APPS_SCRIPT (copy this whole block to a new Google Apps Script project and deploy as web app)
  ======================= -->
<pre style="white-space:pre-wrap; background:#111; color:#ddd; padding:12px; border-radius:8px; margin:20px;">
// Google Apps Script (Code.gs)
function outputJSONP(e,obj){ var cb=(e&&e.parameter&&e.parameter.callback)?e.parameter.callback:'callback'; var json=cb+'('+JSON.stringify(obj)+')'; return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JAVASCRIPT); }

function doGet(e){ try{ var params=e.parameter||{}; if(!params.sheet) return outputJSONP(e,{ error:'Missing sheet parameter' }); var sh=getSheet(params.sheet); if(!sh) return outputJSONP(e,{ error:'Sheet not found: '+params.sheet }); var action=(params.action||'').toLowerCase();
  if(action==='get' || action==='fetch'){ var data=getSheetData(sh); return outputJSONP(e,{ success:true, data:data }); }
  if(action==='append'){ if(!params.row) return outputJSONP(e,{ error:'Missing row parameter' }); var row=JSON.parse(params.row); sh.appendRow(row); return outputJSONP(e,{ success:true }); }
  if(action==='update_uid'){ if(!params.uid) return outputJSONP(e,{ error:'Missing uid' }); if(!params.row) return outputJSONP(e,{ error:'Missing row' }); var uid=params.uid; var rowArr=JSON.parse(params.row); var idx=findRowIndexByUID(sh,uid); if(idx===-1) return outputJSONP(e,{ error:'UID not found' }); sh.getRange(idx+2,1,1,rowArr.length).setValues([rowArr]); return outputJSONP(e,{ success:true }); }
  if(action==='delete_uid'){ if(!params.uid) return outputJSONP(e,{ error:'Missing uid' }); var uid2=params.uid; var idx2=findRowIndexByUID(sh,uid2); if(idx2===-1) return outputJSONP(e,{ error:'UID not found' }); sh.deleteRow(idx2+2); return outputJSONP(e,{ success:true }); }
  return outputJSONP(e,{ error:'Unknown action' }); }catch(err){ return outputJSONP(e,{ error:String(err.message||err) }); } }

function getSheet(name){ var ss=SpreadsheetApp.getActiveSpreadsheet(); var sheet=ss.getSheetByName(name); return sheet; }
function getSheetData(sheet){ var values=sheet.getDataRange().getValues(); if(!values||values.length===0) return []; var header=values.shift(); var out=[]; values.forEach(function(row){ var obj={}; for(var i=0;i<header.length;i++){ obj[header[i]] = (row[i]===undefined? '': row[i]); } out.push(obj); }); return out; }
function findRowIndexByUID(sheet,uid){ var values=sheet.getDataRange().getValues(); if(!values||values.length<2) return -1; var header=values[0]; var uidCol=-1; for(var i=0;i<header.length;i++){ if(String(header[i]).toLowerCase()==='uid'){ uidCol=i; break; } } if(uidCol===-1) return -1; for(var r=1;r<values.length;r++){ var cell=values[r][uidCol]; if(String(cell)===String(uid)) return r-1; } return -1; }
</pre>

</body>
</html>
