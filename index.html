<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaCrew Dashboard — Daily Routine Log</title>

<!-- Bootstrap & Font Awesome -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root { --sidebar-width: 260px; --navy:#0b2a4a; --accent:#123855; }
body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f2f6fb; color:#222; }
.sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: var(--navy); color:#fff; padding:18px; overflow:auto; }
.sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
.sidebar a { display:block; color:#cfe8ff; padding:10px 12px; text-decoration:none; border-radius:8px; margin-bottom:6px; font-weight:500; }
.sidebar a:hover { background: rgba(255,255,255,0.05); color:#fff; text-decoration:none; }
.sidebar a.active { background:#072033; color:#fff; }
.content { margin-left: calc(var(--sidebar-width) + 28px); padding:24px; min-height:100vh; }
.card-slim { padding:14px; border-radius:12px; box-shadow:0 6px 18px rgba(9,30,66,0.06); background:#fff; margin-bottom:16px; }
.small-note { font-size:0.9rem; color:#666; }
.preview-table { max-height:200px; overflow:auto; padding:8px; background:#fafbff; border-radius:8px; border:1px solid #eef3fb;}
.entry-card { border:1px solid #e9eef6; border-radius:8px; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; gap:12px; align-items:flex-start; background:#fff; }
.entry-meta { color:#444; font-size:0.95rem; }
.form-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.form-row .form-control { min-width:140px; }
.entry-actions button { margin-left:6px; }
.fixed-bottom-left { position: fixed; left: 18px; bottom: 18px; z-index: 2000; color: #666; }
.row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eef3fb; }
.row-entry .left { flex:1; }
.row-entry .right { display:flex; gap:8px; align-items:center; }
.chatboard { display:flex; flex-direction:column; height:320px; gap:8px; }
.chat-log { flex:1; overflow:auto; padding:8px; border-radius:8px; background:#fbfdff; border:1px solid #eef3fb; }
.chat-inputs { display:flex; gap:8px; align-items:center; }
@media (max-width:900px){ .content{ margin-left:16px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
@media print { .sidebar, button, .entry-actions, form, .chatboard { display:none !important } }
.btn-link-look { background:transparent; border:none; color:var(--accent); text-decoration:underline; padding:0; }
.badge-synced { font-size:0.75rem; color:#0b6; margin-left:6px; }
.login-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
.login-card { width:420px; padding:20px; border-radius:12px; background:#fff; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
</style>
</head>
<body>

<!-- LOGIN OVERLAY -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-card">
    <h5>TIWALA — SeaCrew Login</h5>
    <input id="loginUser" class="form-control mb-2" placeholder="Username">
    <input id="loginPass" type="password" class="form-control mb-2" placeholder="Password">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div><input type="checkbox" id="saveCred"> Remember (local only)</div>
      <button id="loginBtn" class="btn btn-primary">Sign in</button>
    </div>
    <div class="small-note" id="loginMsg"></div>
  </div>
</div>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — DAILY ROUTINE LOG</h4>
  <a href="#" class="active" data-target="dashboard">Dashboard</a>
  <a href="#" data-target="vesselJoin">Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew">Arriving Crew</a>
  <a href="#" data-target="dailyUpdates">Daily Updates</a>
  <a href="#" data-target="memo">Memo</a>
  <a href="#" data-target="training">Training</a>
  <a href="#" data-target="pni">P&amp;I / Events</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <!-- Useful Tools / External Links -->
  <div style="margin-top:6px">
    <div class="small-note" style="color:#cfe8ff;margin-bottom:6px">Useful Tools</div>
    <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
    <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
    <a href="https://zoom.earth/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — Zoom Earth</a>
    <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
    <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA</a>
    <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA</a>
  </div>
</nav>

<!-- Main content -->
<main class="content">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>SeaCrew Dashboard</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" id="syncBtn">Sync now</button>
      <button class="btn btn-outline-danger" id="clearLocalBtn">Clear local</button>
      <button class="btn btn-primary" id="pdfBtn">Monthly PDF</button>
      <button class="btn btn-outline-info" id="logoutBtn" style="display:none">Logout</button>
    </div>
  </div>

  <!-- Dashboard preview -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <div class="col-md-8">
        <div class="card-slim">
          <h5>Quick Overview</h5>
          <div class="row g-3 mt-3">
            <div class="col-md-6" id="vesselPreviewCard"></div>
            <div class="col-md-6" id="arrivalsPreviewCard"></div>
            <div class="col-md-6" id="updatesPreviewCard"></div>
            <div class="col-md-6" id="memoPreviewCard"></div>
            <div class="col-md-6" id="trainingPreviewCard"></div>
            <div class="col-md-6" id="pniPreviewCard"></div>
          </div>
        </div>
      </div>

      <!-- Chatboard -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>ChatBoard (public)</h6>
          <div class="chatboard">
            <div class="chat-log" id="chatLog"></div>
            <div class="chat-inputs">
              <input id="chatName" class="form-control" placeholder="Your name" value="Captain">
              <input id="chatMsg" class="form-control" placeholder="Message">
              <button class="btn btn-primary" id="chatSendBtn">Send</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Example: Vessel Join Section -->
  <section id="vesselJoin" class="section" style="display:none">
    <h4>Vessel Crew Joining</h4>
    <div class="form-row mb-3">
      <input id="vjVessel" class="form-control" placeholder="Vessel">
      <input id="vjPort" class="form-control" placeholder="Port">
      <input id="vjNo" class="form-control" type="number" placeholder="No. of Crew">
      <input id="vjRank" class="form-control" placeholder="Rank">
      <input id="vjDate" class="form-control" type="date" placeholder="Depart Date">
      <input id="vjFlight" class="form-control" placeholder="Flight">
      <button class="btn btn-success" id="vjAddBtn">Add</button>
      <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
    </div>
    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Other sections (arrivingCrew, dailyUpdates, memo, training, pni) will have similar structures -->

</main>

<div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw--x_wiJ6Vm9CICyE7k-SebrcLytHhvfe4w31BtEN17FvGtG0f6zqLn96sSgV4ra2l/exec";
let lastChatLength = 0;

// LOGIN
const loginOverlay = document.getElementById('loginOverlay');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const logoutBtn = document.getElementById('logoutBtn');

function showLogin() { loginOverlay.style.display = 'flex'; }
function hideLogin() { loginOverlay.style.display = 'none'; }

loginBtn.addEventListener('click', async () => {
  const username = document.getElementById('loginUser').value;
  const password = document.getElementById('loginPass').value;
  const res = await fetch(`${SCRIPT_URL}?action=auth&username=${username}&password=${password}`);
  const data = await res.json();
  if (data.status==='success') {
    hideLogin(); logoutBtn.style.display='inline-block';
    loadDashboard();
  } else { loginMsg.textContent = data.message || 'Login failed'; }
});

logoutBtn.addEventListener('click', () => { showLogin(); logoutBtn.style.display='none'; });

// NAVIGATION
document.querySelectorAll('.sidebar a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(a.dataset.target).style.display='block';
    document.querySelectorAll('.sidebar a').forEach(a2=>a2.classList.remove('active'));
    a.classList.add('active');
  });
});

// FETCH DASHBOARD DATA
async function loadDashboard() {
  const sheets=['Vessel_join','Arrivals','Updates','Memo','Training','Pni','ChatBoard','Users'];
  const res = await fetch(`${SCRIPT_URL}?action=fetchall&sheets=${sheets.join(',')}`);
  const data = await res.json();

  // Example: populate vesselPreviewCard
  if(data.Vessel_join){
    let html='';
    data.Vessel_join.forEach((r,i)=>{ html+=`<div class="row-entry"><div class="left">${r[0]} (${r[1]})</div><div class="right">
    <button class="btn btn-sm btn-warning" onclick="editEntry('Vessel_join',${i})">Edit</button>
    <button class="btn btn-sm btn-danger" onclick="deleteEntry('Vessel_join',${i})">Del</button></div></div>`});
    document.getElementById('vesselPreviewCard').innerHTML=html;
  }

  // CHATBOARD ALERT
  if(data.ChatBoard && data.ChatBoard.length>lastChatLength){
    const chatLog=document.getElementById('chatLog');
    chatLog.innerHTML='';
    data.ChatBoard.forEach(c=>{
      const div=document.createElement('div'); div.textContent=`[${c[0]}] ${c[1]}: ${c[2]}`;
      chatLog.appendChild(div);
    });
    chatLog.scrollTop=chatLog.scrollHeight;
    new Audio('https://freesound.org/data/previews/331/331912_3248244-lq.mp3').play();
    lastChatLength=data.ChatBoard.length;
  }
}

// ADD / EDIT / DELETE
async function editEntry(sheet,index){ alert('Populate form to edit entry '+sheet+' '+index); }
async function deleteEntry(sheet,index){
  if(!confirm('Delete this entry?')) return;
  await fetch(`${SCRIPT_URL}?action=delete_uid&sheet=${sheet}&index=${index}`);
  loadDashboard();
}

// CHAT SEND
document.getElementById('chatSendBtn').addEventListener('click', async ()=>{
  const name=document.getElementById('chatName').value;
  const msg=document.getElementById('chatMsg').value;
  if(!msg.trim()) return;
  await fetch(`${SCRIPT_URL}?action=append_uid&sheet=ChatBoard&row=${JSON.stringify([new Date(),name,msg])}`);
  document.getElementById('chatMsg').value='';
  loadDashboard();
});

// PDF EXPORT
document.getElementById('pdfBtn').addEventListener('click', async ()=>{
  const doc = new jspdf.jsPDF('landscape');
  doc.text("SeaCrew Monthly Report",10,10);
  // TODO: Fetch all data and add to doc using autotable
  doc.save('SeaCrew_Monthly_Report.pdf');
});

// AUTO SYNC
document.getElementById('syncBtn').addEventListener('click', loadDashboard);
setInterval(loadDashboard,15000);

showLogin();
  <script>
/* ======================
   SeaCrew Dashboard JS
====================== */

// GLOBALS
let currentUser = null;
let autoSyncInterval = null;

// ----------------------
// NAVIGATION
// ----------------------
function navTo(event, sectionId) {
    event.preventDefault();
    document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
    const target = document.getElementById(sectionId);
    if (target) target.style.display = 'block';

    // Active sidebar link
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    const link = event.currentTarget;
    if (link) link.classList.add('active');
}

function navToElement(sectionId) {
    const link = [...document.querySelectorAll('.sidebar a')].find(a => a.dataset.target === sectionId);
    if (link) navTo({currentTarget: link, preventDefault: ()=>{}}, sectionId);
}

// ----------------------
// LOGIN
// ----------------------
document.getElementById('loginBtn').addEventListener('click', async () => {
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value.trim();
    const msgEl = document.getElementById('loginMsg');

    if (!username || !password) { msgEl.textContent = "Enter username/password"; return; }

    try {
        const resp = await fetch(`${GAS_URL}?action=auth&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
        const data = await resp.json();
        if (data.status === 'success') {
            currentUser = data;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            startAutoSync();
            loadAllSections();
        } else {
            msgEl.textContent = data.message;
        }
    } catch(e) { msgEl.textContent = "Login failed: "+e.message; }
});

document.getElementById('logoutBtn').addEventListener('click', () => {
    currentUser = null;
    document.getElementById('loginOverlay').style.display = 'flex';
    document.getElementById('logoutBtn').style.display = 'none';
    clearInterval(autoSyncInterval);
});

// ----------------------
// ADD / UPDATE / DELETE
// ----------------------
async function addItem(section, rowData) {
    const params = new URLSearchParams({action:'append_uid', sheet:section, row:JSON.stringify(rowData)});
    const resp = await fetch(`${GAS_URL}?${params.toString()}`);
    return await resp.json();
}

async function updateItem(section, uid, rowData) {
    const params = new URLSearchParams({action:'update_uid', sheet:section, uid, row:JSON.stringify(rowData)});
    const resp = await fetch(`${GAS_URL}?${params.toString()}`);
    return await resp.json();
}

async function deleteItem(section, uid) {
    const params = new URLSearchParams({action:'delete_uid', sheet:section, uid});
    const resp = await fetch(`${GAS_URL}?${params.toString()}`);
    return await resp.json();
}

// ----------------------
// FETCH / SYNC
// ----------------------
async function fetchSection(section) {
    const resp = await fetch(`${GAS_URL}?action=fetch&sheet=${section}`);
    const data = await resp.json();
    return (data.status==='success') ? data.data : [];
}

async function fetchAllSections() {
    const sheets = ['Vessel_join','Arrivals','Updates','Memo','Training','Pni','ChatBoard'];
    const resp = await fetch(`${GAS_URL}?action=fetchall&sheets=${sheets.join(',')}`);
    const data = await resp.json();
    return (data.status==='success') ? data.data : {};
}

function startAutoSync() {
    autoSyncInterval = setInterval(loadAllSections, 15000);
}

async function loadAllSections() {
    const allData = await fetchAllSections();
    // Populate preview tables
    populatePreview('vesselJoin','Vessel_join', allData);
    populatePreview('arrivingCrew','Arrivals', allData);
    populatePreview('dailyUpdates','Updates', allData);
    populatePreview('memo','Memo', allData);
    populatePreview('training','Training', allData);
    populatePreview('pni','Pni', allData);

    // Chat alerts
    if(allData.ChatBoard){
        updateChatBoard(allData.ChatBoard);
    }
}

function populatePreview(sectionId, sheetName, allData) {
    const el = document.getElementById(sectionId+'PreviewSmall');
    if(!el || !allData[sheetName]) return;
    el.innerHTML = allData[sheetName].map(r=>Object.values(r).join(' | ')).join('<br>');
}

// ----------------------
// CHATBOARD
// ----------------------
const chatLog = document.getElementById('chatLog');
document.getElementById('chatSendBtn').addEventListener('click', async () => {
    const name = document.getElementById('chatName').value.trim();
    const msg = document.getElementById('chatMsg').value.trim();
    if(!name || !msg) return alert('Enter name & message');
    await addItem('ChatBoard',[name,msg,new Date()]);
    document.getElementById('chatMsg').value='';
    loadAllSections();
});

function updateChatBoard(chatData) {
    chatLog.innerHTML = chatData.map(c=>`<div><b>${c.Name}</b>: ${c.Message}</div>`).join('');
    chatLog.scrollTop = chatLog.scrollHeight;

    // Play sound alert for new messages (optional)
    if(chatData.length > (chatLog.dataset.count || 0)){
        const audio = new Audio('https://www.soundjay.com/button/sounds/button-16.mp3');
        audio.play();
        chatLog.dataset.count = chatData.length;
    }
}

// ----------------------
// MONTHLY PDF (includes archived items)
// ----------------------
async function printSectionPDF(section, filename, monthly=false){
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF('landscape','pt','A4');
    let data = await fetchSection(section);
    if(monthly){
        const archiveResp = await fetch(`${GAS_URL}?action=fetch&sheet=Archive_${section}`);
        const archiveData = await archiveResp.json();
        if(archiveData.status==='success') data = data.concat(archiveData.data);
    }
    const columns = Object.keys(data[0]||{});
    const rows = data.map(r=>columns.map(c=>r[c]));
    doc.autoTable({head:[columns], body:rows, styles:{fontSize:8}});
    doc.save(filename+'.pdf');
}

// ----------------------
// STICKY NOTE
// ----------------------
function saveSticky() {
    localStorage.setItem('stickyNote', document.getElementById('stickyNote').value);
}

function loadSticky() {
    document.getElementById('stickyNote').value = localStorage.getItem('stickyNote')||'';
}

// ----------------------
// INIT
// ----------------------
window.addEventListener('load', ()=>{
    document.getElementById('loginOverlay').style.display='flex';
    loadSticky();
});

</script>
</body>
</html>
