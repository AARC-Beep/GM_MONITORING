<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SeaCrew Dashboard — SeaCrewDB</title>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- jsPDF + AutoTable -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<style>
:root { --sidebar-width: 240px; }
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; background:#f4f6f9; }
.sidebar { width: var(--sidebar-width); position: fixed; left:0; top:0; bottom:0; background: #0b2a4a; color:#fff; padding:16px; overflow:auto; }
.sidebar h4 { margin-bottom:12px; font-weight:600; color:#fff; }
.sidebar a { display:block; color:#cfe8ff; padding:8px 10px; text-decoration:none; border-radius:6px; margin-bottom:6px; }
.sidebar a:hover { background:#123855; color:#fff; text-decoration:none; }
.sidebar a.active { background: rgba(255,255,255,0.06); color:#fff; }
.content { margin-left: calc(var(--sidebar-width) + 24px); padding:20px 28px; min-height:100vh; }
.card-slim { padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); background:#fff; margin-bottom:14px; }
.small-note { font-size:0.9rem; color:#666; }
.preview-table { max-height:220px; overflow:auto; padding:6px; background:#fafafa; border-radius:6px; border:1px solid #eee;}
.entry-card { border:1px solid #e6e6e6; border-radius:6px; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; gap:8px; align-items:flex-start; background:#fff; }
.entry-meta { color:#444; font-size:0.95rem; }
.form-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.form-row .form-control { min-width:120px; }
.entry-actions button { margin-left:6px; }
.fixed-bottom-left { position: fixed; left: 16px; bottom: 16px; z-index: 2000; color: #666; }
@media (max-width:900px){ .content{ margin-left:12px; margin-right:12px } .sidebar{ position:relative; width:100%; } }
@media print { .sidebar, button, .entry-actions, form { display:none !important } }
.row-entry { display:flex; gap:12px; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid #eee; }
.row-entry .left { flex:1; }
.row-entry .right { display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>

<!-- Sidebar -->
<nav class="sidebar" aria-label="Main navigation">
  <h4><i class="fa-solid fa-ship"></i> SeaCrew — PTSC/THRI</h4>

  <a href="#" class="active" data-target="dashboard" onclick="navTo(event,'dashboard')"><i class="fa-solid fa-house"></i> Dashboard</a>
  <a href="#" data-target="vesselJoin" onclick="navTo(event,'vesselJoin')"><i class="fa-solid fa-ship"></i> Vessel Crew Joining</a>
  <a href="#" data-target="arrivingCrew" onclick="navTo(event,'arrivingCrew')"><i class="fa-solid fa-plane-departure"></i> Arriving Crew</a>
  <a href="#" data-target="dailyUpdates" onclick="navTo(event,'dailyUpdates')"><i class="fa-regular fa-calendar-days"></i> Daily Updates</a>
  <a href="#" data-target="memo" onclick="navTo(event,'memo')"><i class="fa-regular fa-sticky-note"></i> Memo</a>
  <a href="#" data-target="training" onclick="navTo(event,'training')"><i class="fa-solid fa-graduation-cap"></i> Training</a>
  <a href="#" data-target="pni" onclick="navTo(event,'pni')"><i class="fa-solid fa-calendar-check"></i> P&amp;I / Events</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>

  <!-- External links -->
  <a href="https://flightaware.com/live/airport/RPLL" target="_blank" rel="noopener"><i class="fa-solid fa-plane"></i> Flights — FlightAware (MNL)</a>
  <a href="https://www.msn.com/en-ph/news" target="_blank" rel="noopener"><i class="fa-solid fa-newspaper"></i> News — MSN Philippines</a>
  <a href="https://www.pagasa.dost.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-cloud-sun"></i> Weather — PAGASA</a>
  <a href="https://dmw.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-passport"></i> DMW — Dept. of Migrant Workers</a>
  <a href="https://owwa.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-people-group"></i> OWWA — Overseas Workers Welfare Admin</a>
  <a href="https://marina.gov.ph/" target="_blank" rel="noopener"><i class="fa-solid fa-anchor"></i> MARINA — Maritime Industry Authority</a>

  <hr style="border-color:rgba(255,255,255,0.06)"/>
  <div class="small-note">Tip: Use Monthly Report to export all sections into one PDF. Sync from Sheet updates the dashboard from your Google Sheet.</div>
</nav>

<!-- Main content -->
<main class="content" role="main">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h2>SeaCrew Dashboard</h2>
      <div class="small-note">Connected to Google Sheet: <strong>SeaCrewDB</strong></div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="syncFromSheet()"><i class="fa-solid fa-arrows-rotate"></i> Sync from Sheet</button>
      <button class="btn btn-outline-danger" onclick="clearAllLocal()"><i class="fa-solid fa-trash-can"></i> Clear Local</button>
      <button class="btn btn-outline-primary" onclick="printSectionPDF('dashboard','SeaCrew_Monthly_Report',true)"><i class="fa-solid fa-file-pdf"></i> Monthly Report (PDF)</button>
    </div>
  </div>

  <!-- DASHBOARD (previews) -->
  <section id="dashboard" class="section active">
    <div class="row g-3">
      <!-- Vessel Joining -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>Vessel Crew Joining</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div><strong id="countVessel">0</strong><div class="small-note">entries</div></div>
            <div><button class="btn btn-sm btn-outline-primary" onclick="navToElement('vesselJoin')">Open</button></div>
          </div>
          <div class="mt-2 preview-table" id="vesselPreviewSmall"></div>
          <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button></div>
        </div>
      </div>

      <!-- Arriving -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>Arriving Crew</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div><strong id="countArrivals">0</strong><div class="small-note">entries</div></div>
            <div><button class="btn btn-sm btn-outline-primary" onclick="navToElement('arrivingCrew')">Open</button></div>
          </div>
          <div class="mt-2 preview-table" id="arrivalsPreviewSmall"></div>
          <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button></div>
        </div>
      </div>

      <!-- Daily Updates -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>Daily Updates</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div><strong id="countUpdates">0</strong><div class="small-note">entries</div></div>
            <div><button class="btn btn-sm btn-outline-primary" onclick="navToElement('dailyUpdates')">Open</button></div>
          </div>
          <div class="mt-2 preview-table" id="updatesPreviewSmall"></div>
          <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button></div>
        </div>
      </div>

      <!-- Memo -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>Memo</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div><strong id="countMemo">0</strong><div class="small-note">entries</div></div>
            <div><button class="btn btn-sm btn-outline-primary" onclick="navToElement('memo')">Open</button></div>
          </div>
          <div class="mt-2 preview-table" id="memoPreviewSmall"></div>
          <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="printSectionPDF('memo','Memo')">Export PDF</button></div>
        </div>
      </div>

      <!-- Training -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>Training</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div><strong id="countTraining">0</strong><div class="small-note">entries</div></div>
            <div><button class="btn btn-sm btn-outline-primary" onclick="navToElement('training')">Open</button></div>
          </div>
          <div class="mt-2 preview-table" id="trainingPreviewSmall"></div>
          <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="printSectionPDF('training','Training')">Export PDF</button></div>
        </div>
      </div>

      <!-- P&I -->
      <div class="col-md-4">
        <div class="card-slim">
          <h6>P&amp;I / Events</h6>
          <div class="d-flex justify-content-between align-items-center">
            <div><strong id="countPNI">0</strong><div class="small-note">entries</div></div>
            <div><button class="btn btn-sm btn-outline-primary" onclick="navToElement('pni')">Open</button></div>
          </div>
          <div class="mt-2 preview-table" id="pniPreviewSmall"></div>
          <div class="mt-2 text-end"><button class="btn btn-sm btn-primary" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button></div>
        </div>
      </div>

    </div>
  </section>

  <!-- ============ FORMS & LISTS ============ -->

  <!-- Vessel Join -->
  <section id="vesselJoin" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Vessel Crew Joining</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('vesselJoin','Vessel_Join')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('vesselJoin')">Clear All</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="vjVessel">
        <input class="form-control" placeholder="Port" id="vjPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="vjNo">
        <input class="form-control" placeholder="Rank" id="vjRank">
        <input class="form-control" placeholder="Depart Date" type="date" id="vjDate">
        <input class="form-control" placeholder="Flight" id="vjFlight">
        <button class="btn btn-success" id="vjAddBtn">Add</button>
        <button class="btn btn-secondary" id="vjResetBtn">Reset</button>
      </div>
    </div>

    <div id="vj_list" class="card-slim"></div>
  </section>

  <!-- Arriving Crew -->
  <section id="arrivingCrew" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Arriving Crew</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('arrivingCrew','Arrivals')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('arrivingCrew')">Clear All</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Vessel" id="acVessel">
        <input class="form-control" placeholder="Port" id="acPort">
        <input class="form-control" placeholder="No. of Crew" type="number" id="acNo">
        <input class="form-control" placeholder="Rank" id="acRank">
        <input class="form-control" placeholder="Arrival Date" type="date" id="acDate">
        <input class="form-control" placeholder="Flight" id="acFlight">
        <button class="btn btn-success" id="acAddBtn">Add</button>
        <button class="btn btn-secondary" id="acResetBtn">Reset</button>
      </div>
    </div>

    <div id="ac_list" class="card-slim"></div>
  </section>

  <!-- Daily Updates -->
  <section id="dailyUpdates" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Daily Updates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('dailyUpdates','Daily_Updates')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('dailyUpdates')">Clear All</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="duTitle">
        <input class="form-control" placeholder="Details" id="duDetails">
        <input class="form-control" type="date" id="duDate">
        <button class="btn btn-success" id="duAddBtn">Add</button>
        <button class="btn btn-secondary" id="duResetBtn">Reset</button>
      </div>
    </div>
    <div id="du_list" class="card-slim"></div>
  </section>

  <!-- Memo -->
  <section id="memo" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Memo</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('memo','Memo')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('memo')">Clear All</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Title" id="mTitle">
        <input class="form-control" placeholder="Details" id="mDetails">
        <input class="form-control" type="date" id="mDate">
        <button class="btn btn-success" id="mAddBtn">Add</button>
        <button class="btn btn-secondary" id="mResetBtn">Reset</button>
      </div>
    </div>
    <div id="m_list" class="card-slim"></div>
  </section>

  <!-- Training -->
  <section id="training" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>Training</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('training','Training')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('training')">Clear All</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="tSubject">
        <input class="form-control" placeholder="Details" id="tDetails">
        <input class="form-control" type="date" id="tDate">
        <button class="btn btn-success" id="tAddBtn">Add</button>
        <button class="btn btn-secondary" id="tResetBtn">Reset</button>
      </div>
    </div>
    <div id="t_list" class="card-slim"></div>
  </section>

  <!-- PnI -->
  <section id="pni" class="section" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4>P&amp;I / Events</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="printSectionPDF('pni','PNI_Events')">Export PDF</button>
        <button class="btn btn-outline-danger btn-sm" onclick="clearSection('pni')">Clear All</button>
      </div>
    </div>

    <div class="card-slim mb-3">
      <div class="form-row">
        <input class="form-control" placeholder="Subject" id="pSubject">
        <input class="form-control" placeholder="Details" id="pDetails">
        <input class="form-control" type="date" id="pDate">
        <button class="btn btn-success" id="pAddBtn">Add</button>
        <button class="btn btn-secondary" id="pResetBtn">Reset</button>
      </div>
    </div>
    <div id="p_list" class="card-slim"></div>
  </section>

  <div class="fixed-bottom-left">© 2025 SeaCrew Dashboard</div>
</main>

<!-- Scripts -->
<script>
/* ============ CONFIG ============ */
/* YOUR Apps Script webapp URL (use the one you deployed) */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyq42ztzPtIHuCWrkmlVhxHeqIT5EOHbTvJe4TuD-CnSMZpc1rszQWUw_IhYR5_nI0RUQ/exec";

/* storage keys and sheet tab mapping */
const SECTIONS = {
  vj: { key:'vesselJoin', sheet:'Vessel_Join' },
  ac: { key:'arrivingCrew', sheet:'Arrivals' },
  du: { key:'dailyUpdates', sheet:'Updates' },
  memo: { key:'memo', sheet:'Memo' },
  tr: { key:'training', sheet:'Training' },
  pni: { key:'pni', sheet:'Pni' }
};

/* ---------- local storage helpers ---------- */
function saveLocal(key, arr){ localStorage.setItem(key, JSON.stringify(arr || [])); }
function loadLocal(key){ return JSON.parse(localStorage.getItem(key) || "[]"); }

/* ---------- utility ---------- */
function fmtDate(d){ if(!d) return ""; const dt = new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString(); }
function escapeHtml(unsafe){ if(!unsafe && unsafe !== 0) return ''; return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }

/* ---------- Navigation ---------- */
function navTo(e, id){
  e && e.preventDefault();
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
  const el = Array.from(document.querySelectorAll('.sidebar a')).find(a=>a.dataset.target===id);
  if(el) el.classList.add('active');
}
function navToElement(id){ document.querySelectorAll('.section').forEach(s=>s.style.display='none'); document.getElementById(id).style.display='block'; }

/* ---------- edit state ---------- */
const editState = { vj:null, ac:null, du:null, memo:null, tr:null, pni:null };

/* ---------- Add / Render / Edit / Delete ---------- */
function addEntry(sectionShort){
  if(!(sectionShort in SECTIONS)) return;
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  const list = loadLocal(key);

  let item = { id: Date.now() };

  // collect fields
  if(sectionShort === 'vj'){
    item.Vessel = document.getElementById('vjVessel').value.trim();
    item.Port = document.getElementById('vjPort').value.trim();
    item.Crew = document.getElementById('vjNo').value.trim();
    item.Rank = document.getElementById('vjRank').value.trim();
    item.DepartDate = document.getElementById('vjDate').value;
    item.Flight = document.getElementById('vjFlight').value.trim();
  } else if(sectionShort === 'ac'){
    item.Vessel = document.getElementById('acVessel').value.trim();
    item.Port = document.getElementById('acPort').value.trim();
    item.Crew = document.getElementById('acNo').value.trim();
    item.Rank = document.getElementById('acRank').value.trim();
    item.Date = document.getElementById('acDate').value;
    item.Flight = document.getElementById('acFlight').value.trim();
  } else if(sectionShort === 'du'){
    item.Title = document.getElementById('duTitle').value.trim();
    item.Details = document.getElementById('duDetails').value.trim();
    item.Date = document.getElementById('duDate').value;
  } else if(sectionShort === 'memo'){
    item.Title = document.getElementById('mTitle').value.trim();
    item.Details = document.getElementById('mDetails').value.trim();
    item.Date = document.getElementById('mDate').value;
  } else if(sectionShort === 'tr'){
    item.Subject = document.getElementById('tSubject').value.trim();
    item.Details = document.getElementById('tDetails').value.trim();
    item.Date = document.getElementById('tDate').value;
  } else if(sectionShort === 'pni'){
    item.Subject = document.getElementById('pSubject').value.trim();
    item.Details = document.getElementById('pDetails').value.trim();
    item.Date = document.getElementById('pDate').value;
  }

  // validation minimal
  if(sectionShort==='vj' && (!item.Vessel || !item.Port || !item.Crew || !item.Rank || !item.DepartDate)){
    return alert('Please fill required fields for Vessel Joining (Vessel/Port/Crew/Rank/Depart Date).');
  }
  if(sectionShort==='ac' && (!item.Vessel || !item.Port || !item.Crew || !item.Rank || !item.Date)){
    return alert('Please fill required fields for Arriving Crew (Vessel/Port/Crew/Rank/Date).');
  }

  // edit flow
  if(editState[sectionShort]){
    const idx = list.findIndex(x=>x.id === editState[sectionShort].id);
    if(idx >= 0){
      if(editState[sectionShort].rowIndex) item._rowIndex = editState[sectionShort].rowIndex;
      list[idx] = Object.assign({}, item);
      saveLocal(key, list);
      renderList(sectionShort);
      updateCounts();
      // server update
      if(item._rowIndex){
        callServerUpdate(meta.sheet, item, item._rowIndex);
      } else {
        callServerAppend(meta.sheet, item);
      }
      editState[sectionShort] = null;
      clearForm(sectionShort);
      return;
    }
  }

  // normal append
  list.push(item);
  saveLocal(key, list);
  renderList(sectionShort);
  updateCounts();
  clearForm(sectionShort);

  // append to server
  callServerAppend(meta.sheet, item).then(res => {
    if(res && res.rowIndex){
      const cur = loadLocal(key);
      const findIdx = cur.findIndex(x=>x.id === item.id);
      if(findIdx >= 0){ cur[findIdx]._rowIndex = res.rowIndex; saveLocal(key, cur); renderList(sectionShort); }
    }
  }).catch(()=>{/*ignore*/});
}

function renderList(sectionShort){
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  const list = loadLocal(key);
  const idMap = { vj: 'vj_list', ac: 'ac_list', du: 'du_list', memo: 'm_list', tr: 't_list', pni: 'p_list' };
  const containerEl = document.getElementById(idMap[sectionShort]);
  if(!containerEl) return;
  containerEl.innerHTML = '';

  list.forEach(ep => {
    const row = document.createElement('div');
    row.className = 'row-entry';
    const left = document.createElement('div'); left.className = 'left';
    // Build left content depending on section
    if(sectionShort === 'vj'){
      left.innerHTML = `<div style="font-weight:700"><strong>${escapeHtml(ep.Vessel)}</strong></div>
        <div class="entry-meta">${escapeHtml(ep.Port)} · ${escapeHtml(ep.Crew)} crew · ${escapeHtml(ep.Rank)}</div>
        <div class="small-note">Depart: ${fmtDate(ep.DepartDate)} ${ep.Flight? ' · ' + escapeHtml(ep.Flight):''}</div>`;
    } else if(sectionShort === 'ac'){
      left.innerHTML = `<div style="font-weight:700"><strong>${escapeHtml(ep.Vessel)}</strong></div>
        <div class="entry-meta">${escapeHtml(ep.Port)} · ${escapeHtml(ep.Crew)} crew · ${escapeHtml(ep.Rank)}</div>
        <div class="small-note">Arrival: ${fmtDate(ep.Date)} ${ep.Flight? ' · ' + escapeHtml(ep.Flight):''}</div>`;
    } else if(sectionShort === 'du' || sectionShort === 'memo'){
      const title = escapeHtml(ep.Title || '');
      left.innerHTML = `<div style="font-weight:700">${title}</div><div class="small-note">${escapeHtml(ep.Details)}</div><div class="small-note">${fmtDate(ep.Date)}</div>`;
    } else if(sectionShort === 'tr' || sectionShort === 'pni'){
      const title = escapeHtml(ep.Subject || '');
      left.innerHTML = `<div style="font-weight:700">${title}</div><div class="small-note">${escapeHtml(ep.Details)}</div><div class="small-note">${fmtDate(ep.Date)}</div>`;
    }

    const right = document.createElement('div'); right.className = 'right';
    const editBtn = document.createElement('button');
    editBtn.className = 'btn btn-sm btn-outline-primary';
    editBtn.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>';
    editBtn.onclick = ()=> startEdit(sectionShort, ep.id);
    const delBtn = document.createElement('button');
    delBtn.className = 'btn btn-sm btn-outline-danger';
    delBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
    delBtn.onclick = ()=> deleteEntry(sectionShort, ep.id);

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    row.appendChild(left);
    row.appendChild(right);
    containerEl.appendChild(row);
  });

  updateSmallPreview(sectionShort);
  updateCounts();
}

/* small dashboard preview: last 3 */
function updateSmallPreview(sectionShort){
  const key = SECTIONS[sectionShort].key;
  const list = loadLocal(key);
  const previewIdMap = { vj:'vesselPreviewSmall', ac:'arrivalsPreviewSmall', du:'updatesPreviewSmall', memo:'memoPreviewSmall', tr:'trainingPreviewSmall', pni:'pniPreviewSmall' };
  const previewEl = document.getElementById(previewIdMap[sectionShort]);
  if(!previewEl) return;
  const last3 = list.slice(-3).reverse();
  previewEl.innerHTML = last3.map(item=>{
    if(sectionShort==='vj') return `<div><strong>${escapeHtml(item.Vessel)}</strong> — ${escapeHtml(item.Port)} · ${escapeHtml(item.Crew)} crew · ${escapeHtml(item.Rank)}</div>`;
    if(sectionShort==='ac') return `<div><strong>${escapeHtml(item.Vessel)}</strong> — ${escapeHtml(item.Port)} · ${escapeHtml(item.Crew)} crew · ${escapeHtml(item.Rank)}</div>`;
    if(sectionShort==='du') return `<div><strong>${escapeHtml(item.Title)}</strong> — ${fmtDate(item.Date)}<div class="small-note">${escapeHtml(item.Details)}</div></div>`;
    if(sectionShort==='memo') return `<div><strong>${escapeHtml(item.Title)}</strong> — ${fmtDate(item.Date)}</div>`;
    if(sectionShort==='tr') return `<div><strong>${escapeHtml(item.Subject)}</strong> — ${fmtDate(item.Date)}</div>`;
    if(sectionShort==='pni') return `<div><strong>${escapeHtml(item.Subject)}</strong> — ${fmtDate(item.Date)}</div>`;
    return '';
  }).join('');
}

function updateCounts(){
  document.getElementById('countVessel').innerText = loadLocal(SECTIONS.vj.key).length;
  document.getElementById('countArrivals').innerText = loadLocal(SECTIONS.ac.key).length;
  document.getElementById('countUpdates').innerText = loadLocal(SECTIONS.du.key).length;
  document.getElementById('countMemo').innerText = loadLocal(SECTIONS.memo.key).length;
  document.getElementById('countTraining').innerText = loadLocal(SECTIONS.tr.key).length;
  document.getElementById('countPNI').innerText = loadLocal(SECTIONS.pni.key).length;
}

/* clear section local only */
function clearSection(sectionId){
  if(!confirm('Clear ALL entries for this section (local only)?')) return;
  const short = mapSectionIdToShort(sectionId);
  if(!short) return;
  localStorage.removeItem(SECTIONS[short].key);
  renderList(short);
}

/* clear all local storage */
function clearAllLocal(){
  if(!confirm('Clear ALL local data? This will NOT delete your Google Sheet data.')) return;
  Object.keys(SECTIONS).forEach(k => localStorage.removeItem(SECTIONS[k].key));
  Object.keys(SECTIONS).forEach(k => renderList(k));
  updateCounts();
}

/* map id to short code */
function mapSectionIdToShort(sectionId){
  if(sectionId==='vesselJoin') return 'vj';
  if(sectionId==='arrivingCrew') return 'ac';
  if(sectionId==='dailyUpdates') return 'du';
  if(sectionId==='memo') return 'memo';
  if(sectionId==='training') return 'tr';
  if(sectionId==='pni') return 'pni';
  return null;
}

/* delete entry */
function deleteEntry(sectionShort, id){
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  let list = loadLocal(key);
  const idx = list.findIndex(x=>x.id === id);
  if(idx === -1) return;
  if(!confirm('Delete this entry?')) return;
  const item = list[idx];
  if(item._rowIndex){
    callServerDelete(meta.sheet, item._rowIndex).catch(()=>{/*ignore*/});
  }
  list.splice(idx,1);
  saveLocal(key, list);
  renderList(sectionShort);
  updateCounts();
}

/* start edit */
function startEdit(sectionShort, id){
  const meta = SECTIONS[sectionShort];
  const key = meta.key;
  const list = loadLocal(key);
  const item = list.find(x=>x.id === id);
  if(!item) return;
  editState[sectionShort] = { id: item.id, rowIndex: item._rowIndex || null };

  if(sectionShort === 'vj'){
    document.getElementById('vjVessel').value = item.Vessel || '';
    document.getElementById('vjPort').value = item.Port || '';
    document.getElementById('vjNo').value = item.Crew || '';
    document.getElementById('vjRank').value = item.Rank || '';
    document.getElementById('vjDate').value = item.DepartDate || '';
    document.getElementById('vjFlight').value = item.Flight || '';
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(sectionShort === 'ac'){
    document.getElementById('acVessel').value = item.Vessel || '';
    document.getElementById('acPort').value = item.Port || '';
    document.getElementById('acNo').value = item.Crew || '';
    document.getElementById('acRank').value = item.Rank || '';
    document.getElementById('acDate').value = item.Date || '';
    document.getElementById('acFlight').value = item.Flight || '';
    window.scrollTo({top:0,behavior:'smooth'});
  } else if(sectionShort === 'du'){
    document.getElementById('duTitle').value = item.Title || '';
    document.getElementById('duDetails').value = item.Details || '';
    document.getElementById('duDate').value = item.Date || '';
  } else if(sectionShort === 'memo'){
    document.getElementById('mTitle').value = item.Title || '';
    document.getElementById('mDetails').value = item.Details || '';
    document.getElementById('mDate').value = item.Date || '';
  } else if(sectionShort === 'tr'){
    document.getElementById('tSubject').value = item.Subject || '';
    document.getElementById('tDetails').value = item.Details || '';
    document.getElementById('tDate').value = item.Date || '';
  } else if(sectionShort === 'pni'){
    document.getElementById('pSubject').value = item.Subject || '';
    document.getElementById('pDetails').value = item.Details || '';
    document.getElementById('pDate').value = item.Date || '';
  }
  highlightAddButton(sectionShort, true);
}

/* highlight add button as Update (and revert) */
function highlightAddButton(sectionShort, isEditing){
  const mapBtn = { vj:'vjAddBtn', ac:'acAddBtn', du:'duAddBtn', memo:'mAddBtn', tr:'tAddBtn', pni:'pAddBtn' };
  const btn = document.getElementById(mapBtn[sectionShort]);
  if(!btn) return;
  if(isEditing){
    btn.innerText = 'Update';
    btn.classList.remove('btn-success'); btn.classList.add('btn-warning');
  } else {
    btn.innerText = 'Add';
    btn.classList.remove('btn-warning'); btn.classList.add('btn-success');
  }
}

/* clear form for section */
function clearForm(sectionShort){
  if(sectionShort==='vj'){ ['vjVessel','vjPort','vjNo','vjRank','vjDate','vjFlight'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='ac'){ ['acVessel','acPort','acNo','acRank','acDate','acFlight'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='du'){ ['duTitle','duDetails','duDate'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='memo'){ ['mTitle','mDetails','mDate'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='tr'){ ['tSubject','tDetails','tDate'].forEach(id=>document.getElementById(id).value=''); }
  if(sectionShort==='pni'){ ['pSubject','pDetails','pDate'].forEach(id=>document.getElementById(id).value=''); }
  editState[sectionShort] = null;
  highlightAddButton(sectionShort, false);
}

/* Wire up buttons */
function wireUpButtons(){
  // vj
  document.getElementById('vjAddBtn').addEventListener('click', ()=> {
    if(editState.vj) { addEntry('vj'); } else { addEntry('vj'); }
  });
  document.getElementById('vjResetBtn').addEventListener('click', ()=> clearForm('vj'));

  // ac
  document.getElementById('acAddBtn').addEventListener('click', ()=> { addEntry('ac'); });
  document.getElementById('acResetBtn').addEventListener('click', ()=> clearForm('ac'));

  // du
  document.getElementById('duAddBtn').addEventListener('click', ()=> { addEntry('du'); });
  document.getElementById('duResetBtn').addEventListener('click', ()=> clearForm('du'));

  // memo
  document.getElementById('mAddBtn').addEventListener('click', ()=> { addEntry('memo'); });
  document.getElementById('mResetBtn').addEventListener('click', ()=> clearForm('memo'));

  // tr
  document.getElementById('tAddBtn').addEventListener('click', ()=> { addEntry('tr'); });
  document.getElementById('tResetBtn').addEventListener('click', ()=> clearForm('tr'));

  // pni
  document.getElementById('pAddBtn').addEventListener('click', ()=> { addEntry('pni'); });
  document.getElementById('pResetBtn').addEventListener('click', ()=> clearForm('pni'));
}

/* ---------- PDF export ---------- */
function printSectionPDF(sectionId, filename, all=false){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape'});
  doc.setFontSize(14);
  if(all){
    doc.text('SeaCrew Monthly Report', 14, 16);
    let y = 24;
    const order = ['vj','ac','du','memo','tr','pni'];
    for(const sec of order){
      const key = SECTIONS[sec].key;
      const list = loadLocal(key);
      if(list.length === 0) continue;
      doc.setFontSize(12); doc.text(SECTIONS[sec].sheet.replace(/_/g,' '), 14, y); y += 4;
      let head=[], body=[];
      if(sec==='vj'){ head = ['Vessel','Port','Crew','Rank','Depart Date','Flight']; body = list.map(r=>[r.Vessel||'', r.Port||'', r.Crew||'', r.Rank||'', fmtDate(r.DepartDate||r.date), r.Flight||'']); }
      else if(sec==='ac'){ head = ['Vessel','Port','Crew','Rank','Date','Flight']; body = list.map(r=>[r.Vessel||'', r.Port||'', r.Crew||'', r.Rank||'', fmtDate(r.Date||r.DepartDate), r.Flight||'']); }
      else if(sec==='du'){ head = ['Title','Details','Date']; body = list.map(r=>[r.Title||'', r.Details||'', fmtDate(r.Date)]); }
      else if(sec==='memo'){ head = ['Title','Details','Date']; body = list.map(r=>[r.Title||'', r.Details||'', fmtDate(r.Date)]); }
      else if(sec==='tr'){ head = ['Subject','Details','Date']; body = list.map(r=>[r.Subject||'', r.Details||'', fmtDate(r.Date)]); }
      else if(sec==='pni'){ head = ['Subject','Details','Date']; body = list.map(r=>[r.Subject||'', r.Details||'', fmtDate(r.Date)]); }

      doc.autoTable({ startY: y, head:[head], body, styles:{fontSize:9}, headStyles:{fillColor:[20,90,160]} });
      y = doc.previousAutoTable ? doc.previousAutoTable.finalY + 8 : y + 36;
      if(y > 160){ doc.addPage(); y = 16; }
    }
    doc.save(`${filename}.pdf`);
    return;
  }

  const short = mapSectionIdToShort(sectionId);
  if(!short) return alert('Unknown section for PDF');
  const key = SECTIONS[short].key;
  const list = loadLocal(key);
  if(!list || list.length === 0){ alert('No entries to print'); return; }

  doc.setFontSize(16); doc.text(filename.replace(/_/g,' '), 14, 16);
  const head = (short==='vj')? ['Vessel','Port','Crew','Rank','Depart Date','Flight'] :
             (short==='ac')? ['Vessel','Port','Crew','Rank','Date','Flight'] :
             (short==='du')? ['Title','Details','Date'] :
             (short==='memo')? ['Title','Details','Date'] :
             (short==='tr')? ['Subject','Details','Date'] :
             ['Subject','Details','Date'];

  const body = list.map(r => {
    if(short==='vj') return [r.Vessel||'', r.Port||'', r.Crew||'', r.Rank||'', fmtDate(r.DepartDate||r.date), r.Flight||''];
    if(short==='ac') return [r.Vessel||'', r.Port||'', r.Crew||'', r.Rank||'', fmtDate(r.Date||r.DepartDate), r.Flight||''];
    if(short==='du') return [r.Title||'', r.Details||'', fmtDate(r.Date)];
    if(short==='memo') return [r.Title||'', r.Details||'', fmtDate(r.Date)];
    if(short==='tr') return [r.Subject||'', r.Details||'', fmtDate(r.Date)];
    return [r.Subject||'', r.Details||'', fmtDate(r.Date)];
  });

  doc.autoTable({ startY: 24, head: [head], body, styles:{fontSize:9}, headStyles:{fillColor:[20,90,160]} });
  doc.save(`${filename}.pdf`);
}

/* ---------- Server calls (Apps Script) ---------- */
async function callServerGet(sheetName){
  if(!SCRIPT_URL) return [];
  try{
    const url = `${SCRIPT_URL}?action=get&sheet=${encodeURIComponent(sheetName)}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('fetch failed');
    const data = await res.json();
    return data;
  } catch(err){
    console.warn('callServerGet error', err);
    return [];
  }
}

async function callServerAppend(sheetName, rowObj){
  if(!SCRIPT_URL) return null;
  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ action: 'append', sheet: sheetName, row: rowObj })
    });
    if(!res.ok) throw new Error('append failed');
    const json = await res.json().catch(()=>null);
    return json || null;
  } catch(err){
    console.warn('append failed', err);
    return null;
  }
}

async function callServerUpdate(sheetName, rowObj, rowIndex){
  if(!SCRIPT_URL) return null;
  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ action: 'update', sheet: sheetName, row: rowObj, rowIndex })
    });
    return true;
  } catch(err){
    console.warn('update failed', err);
    return false;
  }
}

async function callServerDelete(sheetName, rowIndex){
  if(!SCRIPT_URL) return null;
  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ action: 'delete', sheet: sheetName, rowIndex })
    });
    return true;
  } catch(err){
    console.warn('delete failed', err);
    return false;
  }
}

/* ---------- Sync from Google Sheet ---------- */
async function syncFromSheet(){
  if(!SCRIPT_URL){ alert('SCRIPT_URL not configured.'); return; }
  try{
    const tabs = ['Vessel_Join','Arrivals','Updates','Memo','Training','Pni'];
    for(const tab of tabs){
      const data = await callServerGet(tab);
      const mapped = (data || []).map((r,i)=>{
        const out = { id: Date.now() + Math.floor(Math.random()*1000) };
        if(tab === 'Vessel_Join'){
          out.Vessel = r.Vessel || r[0] || '';
          out.Port = r.Port || r[1] || '';
          out.Crew = r.Crew || r[2] || (r['No. of Crew']||r['No of Crew']||'');
          out.Rank = r.Rank || r[3] || '';
          out.DepartDate = r['Depart Date'] || r.DepartDate || r[4] || '';
          out.Flight = r.Flight || r[5] || '';
        } else if(tab === 'Arrivals'){
          out.Vessel = r.Vessel || r[0] || '';
          out.Port = r.Port || r[1] || '';
          out.Crew = r.Crew || r[2] || '';
          out.Rank = r.Rank || r[3] || '';
          out.Date = r.Date || r[4] || '';
          out.Flight = r.Flight || r[5] || '';
        } else if(tab === 'Updates'){
          out.Title = r.Title || r[0] || '';
          out.Details = r.Details || r[1] || '';
          out.Date = r.Date || r[2] || '';
        } else if(tab === 'Memo'){
          out.Title = r.Title || r[0] || '';
          out.Details = r.Details || r[1] || '';
          out.Date = r.Date || r[2] || '';
        } else if(tab === 'Training'){
          out.Subject = r.Subject || r[0] || '';
          out.Details = r.Details || r[1] || '';
          out.Date = r.Date || r[2] || '';
        } else if(tab === 'Pni' || tab === 'PnI'){
          out.Subject = r.Subject || r[0] || '';
          out.Details = r.Details || r[1] || '';
          out.Date = r.Date || r[2] || '';
        }
        if(r.rowIndex) out._rowIndex = r.rowIndex;
        if(r.__rowIndex) out._rowIndex = r.__rowIndex;
        return out;
      });

      let localKey = '';
      if(tab==='Vessel_Join') localKey = SECTIONS.vj.key;
      else if(tab==='Arrivals') localKey = SECTIONS.ac.key;
      else if(tab==='Updates') localKey = SECTIONS.du.key;
      else if(tab==='Memo') localKey = SECTIONS.memo.key;
      else if(tab==='Training') localKey = SECTIONS.tr.key;
      else if(tab==='Pni' || tab==='PnI') localKey = SECTIONS.pni.key;

      saveLocal(localKey, mapped);
      const short = Object.keys(SECTIONS).find(k=>SECTIONS[k].key===localKey);
      if(short) renderList(short);
    }
    updateCounts();
    alert('Sync complete (if your Apps Script returned data).');
  } catch(err){
    console.error('syncFromSheet error', err);
    alert('Error syncing from Google Sheet (see console).');
  }
}

/* ---------- Init ---------- */
function init(){
  wireUpButtons();
  Object.keys(SECTIONS).forEach(k => renderList(k));
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById('dashboard').style.display='block';
}

window.addEventListener('DOMContentLoaded', init);
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
